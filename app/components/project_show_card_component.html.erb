<%= render "shared/inspector", record: project %>
<article class="project-show-card">
  <div class="project-show-card__banner project-card__banner">
    <div class="project-card__banner-frame">
      <%= image_tag(banner_variant.present? ? project.banner.variant(:card) : "default-banner.png", class: "project-card__banner-image", alt: "#{project.title} banner") %>

      <% if owner? %>
        <div class="project-show-card__ship-wrapper" id="<%= ship_btn_wrapper_id %>">
          <% if can_ship? || !can_request_re_cert? %>
            <%= render ButtonComponent.new(
                text: project.draft? ? "Ship" : "Ship Again",
                color: :green,
                icon: "icons/ship.svg",
                href: can_ship? ? new_project_ships_path(project) : nil,
                disabled: !can_ship?,
                class: "project-show-card__ship-btn"
            ) %>
          <% else %>
            <%= button_to helpers.request_recertification_project_path(project),
                  method: :post,
                  class: "btn btn--green project-show-card__ship-btn",
                  data: { confirm: "Are you sure you want to request re-certification? This will resubmit your project for review." } do %>
              <%= helpers.inline_svg_tag "icons/ship.svg" %>
              Ship Again
            <% end %>
          <% end %>
        </div>
        <% if !can_ship? && !can_request_re_cert? %>
          <%= render TooltipComponent.new(target_id: ship_btn_wrapper_id, position: :left) do %>
            <strong>Cannot ship yet:</strong>
            <ul>
              <% ship_disabled_reasons.each do |reason| %>
                <li><%= reason %></li>
              <% end %>
            </ul>
          <% end %>
        <% end %>
      <% elsif current_user.present? %>
        <div class="project-show-card__ship-wrapper">
          <% if following? %>
            <%= button_to "Unfollow", unfollow_project_path(project), method: :delete, class: "btn btn--brown project-show-card__ship-btn" %>
          <% else %>
            <%= button_to "Follow", follow_project_path(project), method: :post, class: "btn btn--brown project-show-card__ship-btn" %>
          <% end %>
        </div>
      <% end %>

      <% if helpers.current_user.present? && helpers.policy(:admin).manage_projects? %>
        <%= render ButtonComponent.new(
            text: project.fire? ? "Unmark as Well Cooked" : "Mark as Well Cooked",
            color: :green,
            icon: "icons/fire.svg",
            class: "project-show-card__fire-btn",
            data: {
              controller: "project-fire",
              action: "click->project-fire#toggle",
              project_fire_project_id_value: project.id,
              project_fire_is_fire_value: project.fire?
            }
        ) %>
      <% end %>
    </div>
  </div>

  <div class="project-show-card__content project-card__content">
    <header class="project-show-card__header">
      <div class="project-show-card__titlebar">
        <h1 class="project-show-card__title project-card__title">
          <span class="project-show-card__title-text"><%= project.title %></span>
        </h1>

        <div class="projects-show__title-actions">
          <%= helpers.turbo_frame_tag "lapse-timelapses-#{project.id}", src: helpers.lapse_timelapses_project_path(project), loading: "lazy" %>
            <% if helpers.policy(project).edit? %>
              <%= render ButtonComponent.new(
                    href: helpers.edit_project_path(project),
                    color: :brown,
                    variant: :borderless,
                    icon: "icons/edit.svg",
                    class: "projects-show__icon-btn",
                    aria: { label: "Edit project" }
                  ) %>
            <% end %>
            <% if helpers.policy(project).destroy? %>
              <%= button_to helpers.project_path(project),
                    method: :delete,
                    class: "btn btn--brown btn--borderless projects-show__icon-btn",
                    form: { onsubmit: "return confirm('Are you sure you want to delete ' + #{project.title.to_json} + '? This action cannot be undone.')" },
                    aria: { label: "Delete project" } do %>
                <%= helpers.inline_svg_tag "icons/trash-bin.svg" %>
              <% end %>
            <% end %>
            <% if show_report_button? %>
              <%= render ButtonComponent.new(
                    text: "Report",
                    color: :brown,
                    variant: :borderless,
                    icon: "icons/flag.svg",
                    aria: { label: "Report" },
                    onclick: "document.getElementById('project-report-modal').showModal()"
                  ) %>
            <% end %>
        </div>
      </div>
      <div class="project-show-card__byline">
        <%= byline_text %>
      </div>

      <div class="project-show-card__stats">
        <div class="project-show-card__stat">
          <%= helpers.inline_svg_tag("icons/paper.svg") %>
          <span><%= project.devlogs_count %> <%= "devlog".pluralize(project.devlogs_count) %></span>
        </div>
        <div class="project-show-card__stat">
          <%= helpers.inline_svg_tag("icons/time.svg") %>
          <span><%= helpers.format_seconds(project.duration_seconds) %></span>
        </div>
        <button type="button" class="project-show-card__stat project-show-card__stat--clickable" data-controller="modal" data-action="click->modal#open" data-modal-target-value="project-followers-modal-<%= project.id %>">
          <%= helpers.inline_svg_tag("icons/user.svg") %>
          <span><%= followers_count %> <%= "follower".pluralize(followers_count) %></span>
        </button>
        <% if !project.draft? && can_view_ship_feedback? && ship_status.present? %>
          <div class="project-show-card__stat">
            <% certifier_border = certifier_viewing_others_project? ? "border: 3px solid orange; box-shadow: 0 0 0 4px rgba(255, 165, 0, 0.3);" : "" %>
            <% if has_feedback? %>
              <button type="button" data-controller="modal" data-action="click->modal#open" data-modal-target-value="<%= ship_feedback_modal_id %>" style="background-color: <%= ship_status_color %>; color: white; border-radius: 9999px; padding: 2px 10px; font-size: 0.85em; font-weight: 600; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; <%= certifier_border %>" title="Click to view feedback">
                <%= ship_status_label %>
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10" /><path d="M12 16v-4" /><path d="M12 8h.01" /></svg>
              </button>
            <% else %>
              <span style="background-color: <%= ship_status_color %>; color: white; border-radius: 9999px; padding: 2px 10px; font-size: 0.85em; font-weight: 600; <%= certifier_border %>">
                <%= ship_status_label %>
              </span>
            <% end %>
          </div>
        <% end %>
      </div>
    </header>

    <% if project.display_description.present? %>
      <div class="project-show-card__description"><%= helpers.md project.display_description %></div>
    <% end %>

    <% if project.ai_declaration.present? %>
      <div class="project-show-card__ai-declaration">
        <div class="project-show-card__ai-declaration-header">
          <span aria-hidden="true">ðŸ¤–</span> <span>This project uses AI</span>
        </div>
        <div style="margin-top: 8px; font-size: 0.9em; color: var(--color-blue-600);">
          <%= helpers.md project.ai_declaration %>
        </div>
      </div>
    <% end %>

    <% if has_any_links? %>
      <div class="project-show-card__actions">
        <% if project.demo_url.present? %>
          <%= render ButtonComponent.new(
                text: "Demo",
                href: project.demo_url,
                color: :brown,
                variant: :borderless,
                icon: "icons/globe.svg"
              ) %>
        <% end %>
        <% if project.repo_url.present? %>
          <%= render ButtonComponent.new(
                text: "Repository",
                href: project.repo_url,
                color: :brown,
                variant: :borderless,
                icon: "icons/merge.svg"
              ) %>
        <% end %>
        <% if project.readme_url.present? %>
          <% readme_modal_id = "project-readme-modal-#{project.id}" %>

          <% if ProjectReadmeFetcher.allowed_url?(project.readme_url) %>
            <%= render ButtonComponent.new(
                  text: "Readme",
                  color: :brown,
                  variant: :borderless,
                  icon: "icons/paper.svg",
                  onclick: "document.getElementById('project-readme-modal-#{project.id.to_json}').showModal()"
                ) %>

            <%= render layout: "shared/modal", locals: { id: readme_modal_id, title: "README" } do %>
              <turbo-frame id="project-readme-frame-<%= project.id %>" src="<%= readme_project_path(project) %>" loading="lazy">
                <p style="text-align: center; font-size: 1.5rem;">Loading README...</p>
              </turbo-frame>
              <div class="modal__actions">
                <button type="button" class="modal__actions-close" onclick="document.getElementById(<%= "project-readme-modal-#{project.id}".to_json %>).close()">Close</button>
              </div>
            <% end %>
          <% else %>
              <%= render ButtonComponent.new(
                text: "Readme",
                href: project.readme_url,
                color: :brown,
                variant: :borderless,
                icon: "icons/paper.svg",
                target: "_blank",
                rel: "noopener noreferrer"
              ) %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
</article>

<%# Feedback Modal %>
<%# TODO: Abstraction for modals w/ proper design and no inline css %>
<% if can_view_ship_feedback? && has_feedback? %>
  <%= render layout: "shared/modal", locals: { id: ship_feedback_modal_id, title: "Ship Feedback" } do %>
    <div style="display: flex; flex-direction: column; gap: 16px;">
      <div>
        <span style="background-color: <%= ship_status_color %>; color: white; border-radius: 9999px; padding: 4px 12px; font-size: 0.9em; font-weight: 600;">
          <%= ship_status_label %>
        </span>
      </div>

      <% if ship_feedback_reason.present? %>
        <div>
          <h3 style="margin: 0 0 8px 0; color: var(--color-brown); font-size: 1em;">Reason</h3>
          <p style="margin: 0; color: var(--color-brown-dark);"><%= ship_feedback_reason %></p>
        </div>
      <% end %>

      <% if ship_feedback_video_url.present? %>
        <div>
          <h3 style="margin: 0 0 8px 0; color: var(--color-brown); font-size: 1em;">Video Feedback</h3>
          <video controls style="width: 100%; max-height: 300px; border-radius: 8px; background: #000;">
            <source src="<%= ship_feedback_video_url %>" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <%= link_to "Open in new tab", ship_feedback_video_url, target: "_blank", rel: "noopener", style: "display: block; margin-top: 8px; color: var(--color-blue); text-decoration: underline; font-size: 0.85em;" %>
        </div>
      <% end %>

      <% if ship_status == "rejected" %>
        <div style="margin-top: 4px; padding-top: 16px; border-top: 1px solid var(--color-brown-300, #ddd);">
          <%= button_to helpers.request_recertification_project_path(project),
                method: :post,
                data: { confirm: "Are you sure you want to request re-certification? This will resubmit your project for review." },
                class: "btn btn--brown",
                style: "width: 100%; justify-content: center;" do %>
            ðŸ”„ Request Re-Certification
          <% end %>
        </div>
      <% end %>

      <div class="modal__actions" style="margin-top: 8px;">
        <button type="button" class="modal__actions-close" data-action="modal#close">Close</button>
      </div>
    </div>
  <% end %>
<% end %>

<%# Follower Modal %>
<div id="project-followers-modal-<%= project.id %>" class="project-followers-modal" data-controller="modal" style="display: none; position: fixed; inset: 0; z-index: 1000; justify-content: center; align-items: center;">
  <div data-action="click->modal#close" style="position: absolute; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px);"></div>
  <div style="background: var(--color-cream, #fef3e2); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; position: relative; z-index: 1001; max-height: 80vh; overflow-y: auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <h2 style="margin: 0; color: var(--color-brown);"><%= followers_count %> <%= "Follower".pluralize(followers_count) %></h2>
      <button type="button" data-action="click->modal#close" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-brown);">&times;</button>
    </div>

    <% if followers_count > 0 %>
      <div style="display: flex; flex-direction: column; gap: 12px;">
        <% project.followers.each do |follower| %>
          <%= link_to user_path(follower), style: "display: flex; align-items: center; gap: 12px; text-decoration: none; color: inherit; padding: 8px; border-radius: 8px; transition: background 0.2s;" do %>
            <%= image_tag follower.avatar, style: "width: 40px; height: 40px; border-radius: 50%; object-fit: cover;", alt: follower.display_name %>
            <span style="font-weight: 500; color: var(--color-brown);"><%= follower.display_name %></span>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <p style="color: var(--color-brown-600); text-align: center; margin: 0;">No followers yet</p>
    <% end %>
  </div>
</div>
