<% if @show_welcome_overlay %>
  <%= render WelcomeOverlayComponent.new %>
<% end %>

<div class="kitchen-index">
  <%= render HeadingComponent.new(title: "Kitchen", tone: :blue) %>

  <% if @show_welcome_overlay %>
    <div class="dialogue-box-container"
         data-controller="kitchen-dialogue"
         data-kitchen-dialogue-show-hackatime-tutorial-value="<%= @show_hackatime_tutorial %>"
         data-kitchen-dialogue-show-slack-tutorial-value="<%= @show_slack_tutorial %>"
         style="display: none;">
      <!-- Welcome Dialogue -->
      <div class="dialogue-box-wrapper dialogue-box-wrapper--welcome"
        data-dialogue-type="welcome"
        data-dialogue-iteration-text-value='<%= [
          "Welcome to the Kitchen, chef! This is your home base on Flavortown.",
          "The Kitchen is where you'll find your tutorial steps, track your progress, and see what you need to do next.",
          "You'll see cards for each step you need to complete. Once you finish them all, you'll be fully set up and ready to cook!",
          "Let's start by checking out the tutorial steps below. They'll guide you through everything you need to know."
        ].to_json %>'
        data-dialogue-iteration-sprites-value='<%= (1..12).map { |i| image_path("orpheus_sprites/#{i}.png") }.to_json %>'
        data-action="keydown.enter@window->dialogue-iteration#next click@window->dialogue-iteration#next">
        <div class="dialogue-box-backdrop"></div>
        <div class="dialogue-box">
          <h1>Chef Orpheus</h1>
          <div class="dialogue-box__image" data-action="click->dialogue-iteration#squeakCharacter" data-dialogue-iteration-target="character">
            <%= image_tag "orpheus_sprites/1.png", alt: "Chef Orpheus", data: { dialogue_iteration_target: "sprite" } %>
          </div>
          <div class="dialogue-box__text">
            <div class="dialogue-box__text-content">
              <span data-dialogue-iteration-target="content">Welcome to the Kitchen, chef! This is your home base on Flavortown.</span>
            </div>
            <button type="button" class="dialogue-box__text-btn">
              Click to continue...<span>&#8964;</span>
            </button>
          </div>
        </div>
      </div>

      <% if @show_hackatime_tutorial %>
        <!-- Hackatime Tutorial Dialogue -->
        <div class="dialogue-box-wrapper dialogue-box-wrapper--hackatime"
          data-dialogue-type="hackatime"
          style="display: none;"
          data-dialogue-iteration-text-value='<%= [
            "On Flavortown, the projects that you build are time tracked!",
            "You install an extension in your code editor and the time tracking is automatic.",
            "We need to track how much time you spend to reward you with cookies!",
            "And that's how you're gonna earn cookies :p!",
            "Let's connect your Hackatime account so we can start tracking your coding time."
          ].to_json %>'
          data-dialogue-iteration-sprites-value='<%= (1..12).map { |i| image_path("orpheus_sprites/#{i}.png") }.to_json %>'
          data-action="keydown.enter@window->dialogue-iteration#next click@window->dialogue-iteration#next">
          <div class="dialogue-box-backdrop"></div>
          <div class="dialogue-box">
            <h1>Chef Orpheus</h1>
            <div class="dialogue-box__image" data-action="click->dialogue-iteration#squeakCharacter" data-dialogue-iteration-target="character">
              <%= image_tag "orpheus_sprites/1.png", alt: "Chef Orpheus", data: { dialogue_iteration_target: "sprite" } %>
            </div>
            <div class="dialogue-box__text">
              <div class="dialogue-box__text-content">
                <span data-dialogue-iteration-target="content">On Flavortown, the projects that you build are time tracked!</span>
              </div>
              <button type="button" class="dialogue-box__text-btn">
                Click to continue...<span>&#8964;</span>
              </button>
            </div>
          </div>
        </div>
      <% end %>

      <% if @show_slack_tutorial %>
        <!-- Slack Tutorial Dialogue -->
        <div class="dialogue-box-wrapper dialogue-box-wrapper--slack"
          data-dialogue-type="slack"
          style="display: none;"
          data-dialogue-iteration-text-value='<%= [
            "One more thing, chef!",
            "Join our Slack community to connect with other chefs, share your projects, and get help when you need it.",
            "It's a great place to meet fellow builders and be part of the Flavortown community!"
          ].to_json %>'
          data-dialogue-iteration-sprites-value='<%= (1..12).map { |i| image_path("orpheus_sprites/#{i}.png") }.to_json %>'
          data-action="keydown.enter@window->dialogue-iteration#next click@window->dialogue-iteration#next">
          <div class="dialogue-box-backdrop"></div>
          <div class="dialogue-box">
            <h1>Chef Orpheus</h1>
            <div class="dialogue-box__image" data-action="click->dialogue-iteration#squeakCharacter" data-dialogue-iteration-target="character">
              <%= image_tag "orpheus_sprites/1.png", alt: "Chef Orpheus", data: { dialogue_iteration_target: "sprite" } %>
            </div>
            <div class="dialogue-box__text">
              <div class="dialogue-box__text-content">
                <span data-dialogue-iteration-target="content">One more thing, chef!</span>
              </div>
              <button type="button" class="dialogue-box__text-btn">
                Click to continue...<span>&#8964;</span>
              </button>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if current_user&.banned? %>
    <div class="banned-banner">
      <div class="banned-banner__content">
        <h2 class="banned-banner__title">Account Banned</h2>
        <p class="banned-banner__message">Your account has been banned and you cannot access other parts of the site.</p>
        <% if current_user.banned_reason.present? %>
          <p class="banned-banner__reason"><strong>Reason:</strong> <%= current_user.banned_reason %></p>
        <% end %>
      </div>
    </div>
  <% else %>
  <% if current_user.verification_ineligible? %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact kitchen-verification-notice--wide">
      <%= render StateCardComponent.new(
        title: "Not Eligible",
        description: "Your account has been marked as ineligible for this program. If you believe this is an error, please contact identity@hackclub.com.",
        variant: :danger,
        badge_text: "ineligible",
        icon: "info"
      ) %>
    </div>
  <% elsif current_user.verification_verified? && current_user.ysws_eligible == false %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact kitchen-verification-notice--wide">
      <%= render StateCardComponent.new(
        title: "Outside age range",
        description: "You're verified, but this program is only available to teenagers :-/",
        variant: :warning,
        badge_text: "sorry...",
        icon: "info"
      ) %>
    </div>
  <% elsif current_user.verification_needs_submission? && current_user.tutorial_step_completed?(:identity_verified) %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact kitchen-verification-notice--wide">
      <% rejection_message = [@verification_rejection_reason&.dig("reason")&.humanize, @verification_rejection_reason&.dig("details")].compact_blank.join(": ").presence %>
      <%= render StateCardComponent.new(
        title: "one more try!",
        description: "we need you to resubmit your ID verification..." + (rejection_message ? " #{rejection_message}" : ""),
        variant: :danger,
        badge_text: "action needed",
        icon: "info",
        cta_text: "verify again",
        cta_href: HCAService.verify_portal_url(return_to: kitchen_url)
      ) %>
    </div>
  <% end %>
  <div class="kitchen-setup">
    <%= render KitchenTutorialStepsComponent.new(
      tutorial_steps: @tutorial_steps,
      completed_steps: @completed_steps,
      current_user: current_user
    ) %>
  </div>
  <% if current_user.verification_pending? %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact">
      <%= render StateCardComponent.new(
        title: "Verification Pending",
        description: "Your identity verification is being reviewed. This usually takes a few days.",
        variant: :warning,
        badge_text: "Pending",
        icon: "time"
      ) %>
    </div>
  <% end %>
  <% end %>
  <div class="kitchen-help">
    <%= render KitchenHelpCardsComponent %>
  </div>
</div>
