<% if @show_welcome_overlay %>
  <%= render WelcomeOverlayComponent.new %>
<% end %>

<div class="kitchen-index">
  <div class="kitchen-index__header">
    <%= render HeadingComponent.new(title: "Kitchen", tone: :blue, size: :full) %>
  </div>

  <% flavortime_release_download_base = "https://github.com/hackclub/flavortime/releases/latest/download" %>
  <% flavortime_download_links = {
    macos: "#{flavortime_release_download_base}/flavortime-macos-universal.dmg",
    windows: "#{flavortime_release_download_base}/flavortime-windows-x64.exe",
    linux: "#{flavortime_release_download_base}/flavortime-linux-x64.AppImage"
  } %>
  <% user_agent = request.user_agent.to_s.downcase %>
  <% default_download_platform = if user_agent.include?("macintosh") || user_agent.include?("mac os")
                                  :macos
                                elsif user_agent.include?("linux") && !user_agent.include?("android")
                                  :linux
                                else
                                  :windows
                                end %>
  <% platform_labels = {
    macos: "macOS (universal)",
    windows: "Windows (x64)",
    linux: "Linux (x64 AppImage)"
  } %>
  <% platform_short_labels = {
    macos: "Mac",
    windows: "Windows",
    linux: "Linux"
  } %>
  <% platform_details = {
    macos: "universal",
    windows: "x64",
    linux: "x64 AppImage"
  } %>

  <% if @show_welcome_overlay %>
    <div class="dialogue-box-container"
         data-controller="kitchen-dialogue"
         data-kitchen-dialogue-show-hackatime-tutorial-value="<%= @show_hackatime_tutorial %>"
         data-kitchen-dialogue-show-slack-tutorial-value="<%= @show_slack_tutorial %>"
         style="display: none;">
      <!-- Welcome Dialogue -->
      <div class="dialogue-box-wrapper dialogue-box-wrapper--welcome"
        data-dialogue-type="welcome"
        data-dialogue-iteration-text-value='<%= [
          "Welcome to the Kitchen, chef! This is your home base on Flavortown.",
          "The Kitchen is where you'll find your tutorial steps, track your progress, and see what you need to do next.",
          "You'll see cards for each step you need to complete. Once you finish them all, you'll be fully set up and ready to cook!",
          "Let's start by checking out the tutorial steps below. They'll guide you through everything you need to know."
        ].to_json %>'
        data-dialogue-iteration-sprites-value='<%= (1..12).map { |i| image_path("orpheus_sprites/#{i}.png") }.to_json %>'
        data-action="keydown.enter@window->dialogue-iteration#next click@window->dialogue-iteration#next">
        <div class="dialogue-box-backdrop"></div>
        <div class="dialogue-box">
          <div class="dialogue-box__header">
            <h1>Chef Orpheus</h1>
            <button type="button" class="dialogue-box__mute-btn" data-dialogue-iteration-target="muteButton" data-action="click->dialogue-iteration#toggleMute" aria-label="Toggle sound">
              <%= inline_svg_tag "icons/volume-on.svg", class: "dialogue-box__mute-icon", data: { dialogue_iteration_target: "volumeOnIcon" } %>
              <%= inline_svg_tag "icons/volume-off.svg", class: "dialogue-box__mute-icon", data: { dialogue_iteration_target: "volumeOffIcon" }, style: "display: none;" %>
            </button>
          </div>
          <div class="dialogue-box__image" data-action="click->dialogue-iteration#squeakCharacter" data-dialogue-iteration-target="character">
            <%= image_tag "orpheus_sprites/1.png", alt: "Chef Orpheus", data: { dialogue_iteration_target: "sprite" } %>
          </div>
          <div class="dialogue-box__text">
            <div class="dialogue-box__text-content">
              <span data-dialogue-iteration-target="content">Welcome to the Kitchen, chef! This is your home base on Flavortown.</span>
            </div>
            <button type="button" class="dialogue-box__text-btn">
              Click to continue...<span>&#8964;</span>
            </button>
          </div>
        </div>
      </div>

      <% if @show_hackatime_tutorial %>
        <!-- Hackatime Tutorial Dialogue -->
        <div class="dialogue-box-wrapper dialogue-box-wrapper--hackatime"
          data-dialogue-type="hackatime"
          style="display: none;"
          data-dialogue-iteration-text-value='<%= [
            "On Flavortown, the projects that you build are time tracked!",
            "You install an extension in your code editor and the time tracking is automatic.",
            "We need to track how much time you spend to reward you with cookies!",
            "And that's how you're gonna earn cookies :p!",
            "Let's connect your Hackatime account so we can start tracking your coding time."
          ].to_json %>'
          data-dialogue-iteration-sprites-value='<%= (1..12).map { |i| image_path("orpheus_sprites/#{i}.png") }.to_json %>'
          data-action="keydown.enter@window->dialogue-iteration#next click@window->dialogue-iteration#next">
          <div class="dialogue-box-backdrop"></div>
          <div class="dialogue-box">
            <div class="dialogue-box__header">
              <h1>Chef Orpheus</h1>
              <button type="button" class="dialogue-box__mute-btn" data-dialogue-iteration-target="muteButton" data-action="click->dialogue-iteration#toggleMute" aria-label="Toggle sound">
                <%= inline_svg_tag "icons/volume-on.svg", class: "dialogue-box__mute-icon", data: { dialogue_iteration_target: "volumeOnIcon" } %>
                <%= inline_svg_tag "icons/volume-off.svg", class: "dialogue-box__mute-icon", data: { dialogue_iteration_target: "volumeOffIcon" }, style: "display: none;" %>
              </button>
            </div>
            <div class="dialogue-box__image" data-action="click->dialogue-iteration#squeakCharacter" data-dialogue-iteration-target="character">
              <%= image_tag "orpheus_sprites/1.png", alt: "Chef Orpheus", data: { dialogue_iteration_target: "sprite" } %>
            </div>
            <div class="dialogue-box__text">
              <div class="dialogue-box__text-content">
                <span data-dialogue-iteration-target="content">On Flavortown, the projects that you build are time tracked!</span>
              </div>
              <button type="button" class="dialogue-box__text-btn">
                Click to continue...<span>&#8964;</span>
              </button>
            </div>
          </div>
        </div>
      <% end %>

      <% if @show_slack_tutorial %>
        <!-- Slack Tutorial Dialogue -->
        <div class="dialogue-box-wrapper dialogue-box-wrapper--slack"
          data-dialogue-type="slack"
          style="display: none;"
          data-dialogue-iteration-text-value='<%= [
            "One more thing, chef!",
            "Join our Slack community to connect with other chefs, share your projects, and get help when you need it.",
            "It's a great place to meet fellow builders and be part of the Flavortown community!"
          ].to_json %>'
          data-dialogue-iteration-sprites-value='<%= (1..12).map { |i| image_path("orpheus_sprites/#{i}.png") }.to_json %>'
          data-action="keydown.enter@window->dialogue-iteration#next click@window->dialogue-iteration#next">
          <div class="dialogue-box-backdrop"></div>
          <div class="dialogue-box">
            <div class="dialogue-box__header">
              <h1>Chef Orpheus</h1>
              <button type="button" class="dialogue-box__mute-btn" data-dialogue-iteration-target="muteButton" data-action="click->dialogue-iteration#toggleMute" aria-label="Toggle sound">
                <%= inline_svg_tag "icons/volume-on.svg", class: "dialogue-box__mute-icon", data: { dialogue_iteration_target: "volumeOnIcon" } %>
                <%= inline_svg_tag "icons/volume-off.svg", class: "dialogue-box__mute-icon", data: { dialogue_iteration_target: "volumeOffIcon" }, style: "display: none;" %>
              </button>
            </div>
            <div class="dialogue-box__image" data-action="click->dialogue-iteration#squeakCharacter" data-dialogue-iteration-target="character">
              <%= image_tag "orpheus_sprites/1.png", alt: "Chef Orpheus", data: { dialogue_iteration_target: "sprite" } %>
            </div>
            <div class="dialogue-box__text">
              <div class="dialogue-box__text-content">
                <span data-dialogue-iteration-target="content">One more thing, chef!</span>
              </div>
              <button type="button" class="dialogue-box__text-btn">
                Click to continue...<span>&#8964;</span>
              </button>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>

  <% if challenger_source? %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact kitchen-verification-notice--wide">
      <%= render StateCardComponent.new(
        title: "Challenger Center Space Challenge",
        description: "Ship a space-related project by March 31! Submit it to this sidequest to qualify for space-themed prizes in the shop.",
        variant: :space,
        badge_text: "Mission Deadline: March 31",
        icon: "rocket",
        cta_text: challenger_mission_cta_text,
        cta_href: challenger_mission_cta_href(fallback: sidequests_path(anchor: "challenger-center"))
      ) %>
    </div>
  <% end %>

  <% if current_user&.banned? %>
    <div class="banned-banner">
      <div class="banned-banner__content">
        <h2 class="banned-banner__title">Account Banned</h2>

        <p class="banned-banner__message">Your account has been banned and you cannot access other parts of the site.</p>
        <p>
          Please contact @Fraud Squad for further communications! if you are not on the hackclub slack please email <a href="mailto:fraudsquad@hackclub.com">fraudsquad@hackclub.com</a>
        </p>
      </div>
    </div>
  <% else %>
  <% if current_user.verification_ineligible? %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact kitchen-verification-notice--wide">
      <%= render StateCardComponent.new(
        title: "Not Eligible",
        description: "Your account has been marked as ineligible for this program. If you believe this is an error, please contact identity@hackclub.com.",
        variant: :danger,
        badge_text: "ineligible",
        icon: "info"
      ) %>
    </div>
  <% elsif current_user.verification_verified? && current_user.ysws_eligible == false %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact kitchen-verification-notice--wide">
      <%= render StateCardComponent.new(
        title: "Outside age range",
        description: "You're verified, but this program is only available to teenagers :-/",
        variant: :warning,
        badge_text: "sorry...",
        icon: "info"
      ) %>
    </div>
  <% elsif current_user.verification_needs_submission? && current_user.tutorial_step_completed?(:identity_verified) %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact kitchen-verification-notice--wide">
      <% rejection_message = [@verification_rejection_reason&.dig("reason")&.humanize, @verification_rejection_reason&.dig("details")].compact_blank.join(": ").presence %>
      <%= render StateCardComponent.new(
        title: "one more try!",
        description: "we need you to resubmit your ID verification..." + (rejection_message ? " #{rejection_message}" : ""),
        variant: :danger,
        badge_text: "action needed",
        icon: "info",
        cta_text: "verify again",
        cta_href: HCAService.verify_portal_url(return_to: kitchen_url)
      ) %>
    </div>
  <% end %>
  <div class="kitchen-setup">
    <%= render KitchenTutorialStepsComponent.new(
      tutorial_steps: @tutorial_steps,
      completed_steps: @completed_steps,
      current_user: current_user
    ) %>
  </div>
  <%= link_to "https://pyramid.hackclub.com/c/flavortown/?ref=ft-dash", class: "kitchen-pyramid-banner", target: "_blank", rel: "noopener noreferrer" do %>
    <%= image_tag "pyramid/logo.png", alt: "Pyramid Scheme icon", class: "kitchen-pyramid-banner__icon" %>
    <span class="kitchen-pyramid-banner__copy">
      <span class="kitchen-pyramid-banner__title">Referral Program: Pyramid Scheme</span>
      <span class="kitchen-pyramid-banner__text">Get a Flavortown referral link and invite your friends, put up posters and make videos to earn additional prizes!</span>
    </span>
    <span class="kitchen-pyramid-banner__cta" aria-hidden="true">↗</span>
  <% end %>
  <section class="kitchen-flavortime-banner" aria-label="Flavortime">
    <div class="kitchen-flavortime-banner__content">
      <h2 class="kitchen-flavortime-banner__title">Flavortime <%= image_tag "flavortime/clock-icon.png", alt: "", class: "kitchen-flavortime-banner__title-icon", aria: { hidden: true } %></h2>
      <p class="kitchen-flavortime-banner__text">Share your referral link and/or time spent coding on Discord!</p>
      <div class="kitchen-flavortime-banner__downloads">
        <%= link_to flavortime_download_links[default_download_platform],
            class: "kitchen-flavortime-banner__primary-download",
            target: "_blank",
            rel: "noopener noreferrer" do %>
          <svg class="kitchen-flavortime-banner__download-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></svg>
          <span class="kitchen-flavortime-banner__download-label">Download for <%= platform_short_labels[default_download_platform] %> <span class="kitchen-flavortime-banner__download-detail">(<%= platform_details[default_download_platform] %>)</span></span>
        <% end %>
        <p class="kitchen-flavortime-banner__download-links">
          <span class="kitchen-flavortime-banner__download-prefix">Alternatively,</span> download for
          <% other_platforms = %i[macos windows linux].reject { |p| p == default_download_platform } %>
          <% other_platforms.each_with_index do |platform, i| %>
            <%= link_to platform_labels[platform], flavortime_download_links[platform], class: "kitchen-flavortime-banner__download-link", target: "_blank", rel: "noopener noreferrer" %>
            <% if i < other_platforms.length - 1 %>
              <span class="kitchen-flavortime-banner__download-separator">|</span>
            <% end %>
          <% end %>
        </p>
      </div>
    </div>
    <%= image_tag "flavortime/flavortime-background.webp", alt: "Flavortime mascot", class: "kitchen-flavortime-banner__mascot" %>
  </section>
  <% if current_user.verification_pending? %>
    <div class="kitchen-verification-notice kitchen-verification-notice--compact">
      <%= render StateCardComponent.new(
        title: "Verification Pending",
        description: "Your identity verification is being reviewed. This usually takes a few days.",
        variant: :warning,
        badge_text: "Pending",
        icon: "time"
      ) %>
    </div>
  <% end %>
  <% end %>
  <%= render PlatformNoticeComponent.new(title: "The voting system is being upgraded", heading_element: "h2", with_margin: true) %>
  <% if Flipper.enabled?(:kitchen_comic, current_user) %>
    <div class="kitchen-comic">
      <%= image_tag "kitchen_comic/title.avif", alt: "How to Flavortown", class: "kitchen-comic__title" %>
      <div class="kitchen-comic__cards">
        <%= render ComicCardComponent.new(
          image: "kitchen_comic/1.avif",
          alt: "Get an idea",
          caption: "Get an idea!",
          modal_title: "Get an idea!",
          step_num: 1,
          modal_text: "<p>You can make anything — software or hardware (or both) — as long as you can track it using <a href='https://hackatime.hackclub.com' target='_blank'>Hackatime</a>, our very own software to track time spent hacking!</p>"
        ) %>
        <%= image_tag "kitchen_comic/arrow.avif", alt: "Arrow", class: "kitchen-comic__arrow" %>
        <%= render ComicCardComponent.new(
          image: "kitchen_comic/2.avif",
          alt: "Make your project",
          caption: "Make your project!",
          modal_title: "Make your project!",
          step_num: 2,
          modal_text: "<p>Set up Hackatime using <a href='https://hackatime.hackclub.com/my/wakatime_setup' target='_blank'>these</a> instructions and log your hours using devlogs — simple posts with text + images/videos that you post after making significant progress on your project. Remember to post these devlogs regularly — not posting a devlog after logging over 10 hours might result in your time being lost!</p>"
        ) %>
        <%= image_tag "kitchen_comic/arrow.avif", alt: "Arrow", class: "kitchen-comic__arrow" %>
        <%= render ComicCardComponent.new(
          image: "kitchen_comic/3.avif",
          alt: "Ship your project",
          caption: "Ship your project!",
          modal_title: "Ship your project!",
          step_num: 3,
          modal_text: "<p>Once your project is in a shipable state (i.e. you have a way for others to experience it through a website, app binary, etc.) — ship it! Once shipped, you must wait for your project to be approved by the <a href='https://us.review.hackclub.com' target='_blank'>Shipwrights</a>. This can take a few days (check the queue <a href='https://us.review.hackclub.com/queue' target='_blank'>here</a>) but don't worry — all they do is check if your project is shipable with the correct links, and sometimes give you helpful advice to improve it!</p><br><p>Lastly, always remember that while projects have to be demo-ready before being shipped, you can always continue working on them afterwards and re-ship.</p>"
        ) %>
        <%= image_tag "kitchen_comic/arrow.avif", alt: "Arrow", class: "kitchen-comic__arrow" %>
        <%= render ComicCardComponent.new(
          image: "kitchen_comic/4.avif",
          alt: "Vote on projects",
          caption: "Vote on projects!",
          modal_title: "Vote on projects!",
          step_num: 4,
          modal_text: "<p>You're almost ready to get cookies for the hours you spent on your project — you just have to vote to unlock the payout! Voting is done by rating each project on a bunch of simple metrics:</p> <ul><li><b>Originality:</b> Is the project innovative and original, or just a clone of an overused concept?</li><li><b>Technical:</b> How complex is the project? Did the author use new frameworks or learn something cool?</li><li><b>Usability:</b> Is the project easy and fun to use, or is it buggy and frustrating?</li><li><b>Storytelling:</b> Does the author devlog regularly? Is the development timeline fun to scroll through?</li></ul> <p>Voting is done so people (including you) making good projects get more cookies per hour. For every project shipped, you must vote on 14 projects to get cookies!</p>"
        ) %>
        <%= image_tag "kitchen_comic/arrow.avif", alt: "Arrow", class: "kitchen-comic__arrow" %>
        <%= render ComicCardComponent.new(
          image: "kitchen_comic/5.avif",
          alt: "Earn cookies",
          caption: "Earn cookies!",
          modal_title: "Earn cookies!",
          step_num: 5,
          modal_text: "<p>Congratulations! You're now ready to get cookies for your hard work. You earn anywhere between 1 to 30 cookies per each hour you hack on a project — the better your project does in voting, the more cookies you get! Make sure to ship high quality projects to get bigger payouts.</p>"
        ) %>
        <%= image_tag "kitchen_comic/arrow.avif", alt: "Arrow", class: "kitchen-comic__arrow" %>
        <%= render ComicCardComponent.new(
          image: "kitchen_comic/6.avif",
          alt: "Win prizes",
          caption: "Win prizes!",
          modal_title: "Win prizes!",
          step_num: 6,
          modal_text: %q{<p>Once you've earned enough cookies, you can place an order in the <a href='https://flavortown.hackclub.com/shop'>Shop</a>! You can get anything from domain grants and Raspberry Pi's to iPads and Macbooks.</p><br><p>After placing an order, you must wait again for it to be reviewed by the Fraud Squad — they just check to make sure nothing fishy is going on. Unfortunately, considering the scale at which Hack Club operates, we sometimes get bad actors trying to defraud our nonprofit, thus deeming this step necessary, especially for larger prizes. But you can rest easy — if you don't try do anything wrong, you'll never get in trouble!</p><br><p>One last thing: Hack Club always pays for shipping, but some special prizes may incur customs (a charge levied by your country's government on imported goods) if you live outside the US — which we will not be able to cover. Don't worry though, you'll know which items may incur customs during checkout so you can make an informed decision!</p>}
        ) %>
        <%= image_tag "kitchen_comic/arrow.avif", alt: "Arrow", class: "kitchen-comic__arrow" %>
      </div>
    </div>
  <% end %>
  <div class="kitchen-stats">
    <%= render KitchenStatsComponent.new(user: current_user) %>
  </div>
  <% if @recently_added_items.any? %>
    <section class="kitchen-recently-added">
      <div class="kitchen-recently-added__header">
        <h2 class="kitchen-recently-added__title">Recently Added to Shop</h2>
        <p class="kitchen-recently-added__subtitle">fresh off the shelf, check these out!</p>
      </div>
      <div class="kitchen-recently-added__items">
        <% @recently_added_items.each do |item| %>
          <% next unless item.image.present? && item.enabled_in_region?(@user_region) %>
          <% sale_price = item.price_for_region(@user_region) %>
          <%= render ShopItemCardComponent.new(
            item_id: item.id,
            name: item.name,
            description: item.description,
            hours: item.fixed_estimate(sale_price).to_i,
            price: item.ticket_cost,
            image_url: item.image.variant(:carousel_lg),
            item_type: item.type,
            balance: @user_balance,
            enabled_regions: Shop::Regionalizable::REGION_CODES.select { |code| item.enabled_in_region?(code) },
            regional_price: sale_price,
            logged_in: current_user.present?,
            remaining_stock: item.remaining_stock,
            limited: item.limited?,
            on_sale: item.on_sale?,
            sale_percentage: item.sale_percentage,
            original_price: item.ticket_cost,
            created_at: item.created_at,
            show_bow: true,
            show_time_ago: true,
            enabled_until: item.enabled_until
          ) %>
        <% end %>
      </div>
    </section>
  <% end %>
  <div class="kitchen-help">
    <%= render KitchenHelpCardsComponent %>
  </div>
</div>
