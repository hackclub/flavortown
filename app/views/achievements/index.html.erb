<div class="achievements" data-controller="achievement-highlight" data-achievement-highlight-slug-value="<%= params[:highlight] %>">
  <%= render HeadingComponent.new(title: "Achievements", tone: :blue) %>

  <div class="achievements__stats">
    <div class="achievements__stats-text">
      <span class="achievements__stats-count"><%= @achievement_stats[:earned] %></span> / <span class="achievements__stats-total"><%= @achievement_stats[:total] %></span> collected
    </div>
    <div class="achievements__stats-bar">
      <div class="achievements__stats-fill" style="width: <%= @achievement_stats[:total] > 0 ? (@achievement_stats[:earned].to_f / @achievement_stats[:total] * 100).round : 0 %>%"></div>
    </div>
  </div>

  <div class="achievements__grid">
    <% @achievements.each do |item| %>
      <% achievement = item[:achievement] %>
      <% next unless achievement.shown_to?(current_user, earned: item[:earned]) %>
      <% is_obscured = !achievement.visible? && !item[:earned] %>
      <% expose_slug = item[:earned] || achievement.visible? %>
      <div <%= tag.attributes(id: "achievement-#{achievement.slug}") if expose_slug %> class="achievements__card <%= 'achievements__card--earned' if item[:earned] %> <%= 'achievements__card--secret' if is_obscured %>" data-achievement-highlight-target="card" <%= tag.attributes(data: { slug: achievement.slug }) if expose_slug %>>
        <div class="achievements__icon">
          <% if is_obscured %>
            <%= inline_svg_tag "icons/question.svg", class: "achievements__icon-svg" %>
          <% else %>
            <%= achievement_icon achievement.icon, earned: item[:earned], class: "achievements__icon-svg" %>
          <% end %>
        </div>
        <h3 class="achievements__name"><%= achievement.display_name(earned: item[:earned]) %></h3>
        <p class="achievements__description"><%= achievement.display_description(earned: item[:earned]) %></p>
        <% if achievement.has_cookie_reward? %>
          <span class="achievements__reward <%= 'achievements__reward--secret' if is_obscured %>">+<%= is_obscured ? "?" : achievement.cookie_reward %> ğŸª</span>
        <% end %>
        <% if achievement.show_progress?(earned: item[:earned]) && item[:progress] %>
          <div class="achievements__progress">
            <div class="achievements__progress-bar">
              <div class="achievements__progress-fill" style="width: <%= [(item[:progress][:current].to_f / item[:progress][:target] * 100), 100].min %>%"></div>
            </div>
            <span class="achievements__progress-text"><%= [(item[:progress][:current].to_f / item[:progress][:target] * 100).round, 100].min %>%</span>
          </div>
        <% elsif item[:earned] %>
          <span class="achievements__earned-at">Earned <%= time_ago_in_words(item[:earned_at]) %> ago</span>
        <% end %>
        <% if item[:earned] %>
          <div class="achievements__badge">
            <%= inline_svg_tag "icons/checkmark.svg", class: "achievements__badge-icon" %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
