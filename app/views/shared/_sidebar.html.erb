<aside class="sidebar" aria-label="Main">
  <%# <div class="sidebar__header">
    <span class="sidebar__title">Flavortown</span>
  </div> %>

  <div class="sidebar__blob">
    <nav class="sidebar__nav" aria-label="Primary navigation">
      <% sidebar_nav_items = [
        { label: "Kitchen", path: kitchen_path, icon: "fork_spoon_fill" },
        { label: "Explore", path: "/explore", icon: "compass_fill" },
        { label: "Projects", path: projects_path, icon: "projects-icon" },
        { label: "Vote", path: new_vote_path, icon: "star_fill" },
        { label: "Shop", path: "/shop", icon: "shopping_cart_1_fill" }
      ] %>

      <% sidebar_nav_items << { label: "Admin", path: admin_root_path, icon: "code" } if policy(:admin).access_admin_dashboard? %>

      <% sidebar_nav_items << { label: "Fulfil", path: admin_shop_orders_path(view: "fulfillment"), icon: "shopping_cart_1_fill" } if current_user.fulfillment_person? && !current_user.admin? %>

      <% sidebar_nav_items << { label: "Helper", path: helper_root_path, icon: "help" } if policy(:helper).access_helper_dashboard? %>

      <% sidebar_nav_items << { label: "Certify", path: "https://sw.eryxks.dev", icon: "ship" } if current_user.project_certifier? %>

      <ul class="sidebar__nav-list">
        <% sidebar_nav_items.each do |item| %>
          <% candidate_path = item[:path] %>
          <% active = if candidate_path == "#"
                        false
                      else
                        current_page?(candidate_path) ||
                          request.path == candidate_path ||
                          request.path.start_with?("#{candidate_path}/")
                      end %>
          <% link_classes = ["sidebar__nav-link", ("sidebar__nav-link--active" if active)].compact.join(" ") %>

          <li class="sidebar__nav-item">
            <% if item[:method] %>
              <%= button_to item[:path], method: item[:method], class: link_classes, aria: (active ? { current: "page" } : {}), form: { class: "sidebar__nav-form" } do %>
                <span class="sidebar__nav-icon-wrapper" aria-hidden="true">
                <%= inline_svg_tag "icons/#{item[:icon]}.svg", class: "sidebar__nav-icon" %>
                </span>
                <span class="sidebar__nav-label"><%= item[:label] %></span>
              <% end %>
            <% else %>
              <%= link_to item[:path], class: link_classes, aria: (active ? { current: "page" } : {}) do %>
                <span class="sidebar__nav-icon-wrapper" aria-hidden="true">
                <%= inline_svg_tag "icons/#{item[:icon]}.svg", class: "sidebar__nav-icon" %>
                </span>
                <span class="sidebar__nav-label"><%= item[:label] %></span>
              <% end %>
            <% end %>
          </li>
        <% end %>
      </ul>
    </nav>
  </div>

  <div class="sidebar__user" aria-live="polite">
    <div class="sidebar__user-card">
      <div class="sidebar__user-avatar">
        <%= image_tag "chef-hat.webp", alt: "Hat", class: "sidebar__user-avatar-hat", aria: { hidden: true } %>
        <%= image_tag "chef-hat-bg.webp", alt: "Hat", class: "sidebar__user-avatar-hat-bg", aria: { hidden: true } %>
        <% if current_user.slack_id.present? %>
          <%= image_tag current_user.avatar, alt: current_user.display_name, class: "sidebar__user-avatar-placeholder", style: "object-fit: cover;" %>
        <% else %>
          <div class="sidebar__user-avatar-placeholder">
            <%= current_user.display_name.first.upcase %>
          </div>
        <% end %>
      </div>
      <div class="sidebar__user-details">
        <%= link_to user_path(current_user) do %>
          <span class="sidebar__user-name"><%= "‚ö° " if current_user.admin? %><%= current_user.display_name %></span>
        <% end %>
        <% if current_user.fulfillment_person? && current_user.has_regions? %>
          <span class="sidebar__user-region" style="font-size: 0.75rem; opacity: 0.7;">üìç <%= current_user.regions_display %></span>
        <% end %>
        <div class="sidebar__user-actions">
          <button type="button" class="sidebar__user-balance" onclick="document.getElementById('balance-modal').showModal()">
            üç™ <%= current_user.cached_balance %>
          </button>

          <button type="button" class="sidebar__user-settings" onclick="document.getElementById('settings-modal').showModal()" aria-label="Settings">
            <%= inline_svg_tag "icons/gear.svg", class: "sidebar__user-settings-icon" %>
          </button>

          <%= link_to my_achievements_path, class: "sidebar__user-settings", aria: { label: "Achievements" } do %>
            <%= inline_svg_tag "icons/trophy.svg", class: "sidebar__user-settings-icon" %>
          <% end %>

          <%= link_to leaderboard_path, class: "sidebar__user-settings", aria: { label: "Leaderboard" } do %>
            <%= inline_svg_tag "icons/leaderboard.svg", class: "sidebar__user-settings-icon" %>
          <% end %>

          <button type="button" class="sidebar__user-logout" onclick="document.getElementById('logout-form').submit()" aria-label="Logout">
            <%= inline_svg_tag "icons/logout.svg", class: "sidebar__user-logout-icon" %>
          </button>

          <%= form_with url: logout_path, method: :delete, id: "logout-form", style: "display: none;" do %>

          <% end %>
        </div>
      </div>
    </div>
  </div>

  <%= render layout: "shared/modal", locals: { id: "balance-modal", title: "Transaction History" } do %>
    <%= turbo_frame_tag "balance_history", src: my_balance_path, loading: "lazy" do %>
      <div class="modal__loading">Loading history...</div>
    <% end %>
    <div class="modal__actions">
      <button type="button" class="modal__actions-close" onclick="document.getElementById('balance-modal').close()">Close</button>
    </div>
  <% end %>

  <%= render layout: "shared/modal", locals: { id: "settings-modal", title: "Settings" } do %>
    <%= form_with url: my_settings_path, method: :patch, local: true, class: "settings-form", id: "settings-form" do |f| %>
      <div class="settings-form__field">
        <label class="settings-form__label" for="hcb_email">HCB Email</label>
        <%= text_field_tag :hcb_email, current_user.hcb_email, id: "hcb_email", class: "settings-form__input", placeholder: current_user.email, autocomplete: "email" %>
        <small class="settings-form__hint">Email used for receiving HCB grants. Leave blank to use your default email.</small>
      </div>

      <div class="settings-form__field">
        <label class="settings-form__checkbox">
          <%= check_box_tag :send_votes_to_slack, "1", current_user.send_votes_to_slack, id: "send_votes_to_slack" %>
          <span>Send votes to Slack</span>
        </label>
        <small class="settings-form__hint">Share your votes in #flavortown-share-votes</small>
      </div>

      <div class="settings-form__field">
        <label class="settings-form__checkbox">
          <%= check_box_tag :leaderboard_optin, "1", current_user.leaderboard_optin, id: "leaderboard_optin" %>
          <span>Opt in to the leaderboard</span>
        </label>
        <small class="settings-form__hint">Check this if you want to be shown on the leaderboard</small>
      </div>

      <div class="settings-form__field">
        <label class="settings-form__checkbox">
          <%= check_box_tag :slack_balance_notifications, "1", current_user.slack_balance_notifications, id: "slack_balance_notifications" %>
          <span>Balance change notifications</span>
        </label>
        <small class="settings-form__hint">Receive a Slack DM when your cookie balance changes</small>
      </div>

      <div class="modal__actions">
        <%= f.submit "Save", class: "modal__actions-close" %>
        <button type="button" class="modal__actions-close" onclick="document.getElementById('settings-form').reset(); document.getElementById('settings-modal').close()">Cancel</button>
      </div>
    <% end %>

    <div>
      <label class="settings-form__label">API Key</label>
      <div class="api-key-container">
        <div class="api-key-display" onmouseenter="this.style.filter='blur(0px)'" onmouseleave="this.style.filter='blur(8px)'">
          <%= current_user.api_key.present? ? current_user.api_key : "No API Key, press generate" %>
        </div>

        <%= button_to roll_api_key_path,
          method: :post,
          data: { turbo_confirm: "Are you sure? This will invalidate your current API key (if you have one)" } do %>
          <%= inline_svg_tag "icons/refresh.svg", class: "api-key-generate-icon" %>
        <% end %>
      </div>

      <small class="settings-form__hint">Your API key for accessing Flavortown's API. Keep this secret!</small>
    </div>
  <% end %>
</aside>
