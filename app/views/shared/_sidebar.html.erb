<aside class="sidebar" aria-label="Main">
  <%# <div class="sidebar__header">
    <span class="sidebar__title">Flavortown</span>
  </div> %>

  <div class="sidebar__blob">
    <nav class="sidebar__nav" aria-label="Primary navigation">
      <% sidebar_nav_items = [
        { label: "Kitchen", path: kitchen_path, icon: "fork_spoon_fill" },
        # { label: "Explore", path: "#", icon: "compass_fill" },
        { label: "Projects", path: projects_path, icon: "square_fill" },
        { label: "Vote", path: new_vote_path, icon: "star_fill" },
        { label: "Shop", path: "/shop", icon: "shopping_cart_1_fill" },
        { label: "Logout", path: "/logout", icon: "arrow-red-right", method: :delete }
      ] %>

      <% sidebar_nav_items << { label: "Admin", path: admin_root_path, icon: "code" } if policy(:admin).access_admin_dashboard? %>

      <ul class="sidebar__nav-list">
        <% sidebar_nav_items.each do |item| %>
          <% candidate_path = item[:path] %>
          <% active = if candidate_path == "#"
                        false
                      else
                        current_page?(candidate_path) ||
                          request.path == candidate_path ||
                          request.path.start_with?("#{candidate_path}/")
                      end %>
          <% link_classes = ["sidebar__nav-link", ("sidebar__nav-link--active" if active)].compact.join(" ") %>

          <li class="sidebar__nav-item">
            <% if item[:method] %>
              <%= button_to item[:path], method: item[:method], class: link_classes, aria: (active ? { current: "page" } : {}), form: { class: "sidebar__nav-form" } do %>
                <span class="sidebar__nav-icon-wrapper" aria-hidden="true">
                <%= inline_svg_tag "icons/#{item[:icon]}.svg", class: "sidebar__nav-icon" %>
                </span>
                <span class="sidebar__nav-label"><%= item[:label] %></span>
              <% end %>
            <% else %>
              <%= link_to item[:path], class: link_classes, aria: (active ? { current: "page" } : {}) do %>
                <span class="sidebar__nav-icon-wrapper" aria-hidden="true">
                <%= inline_svg_tag "icons/#{item[:icon]}.svg", class: "sidebar__nav-icon" %>
                </span>
                <span class="sidebar__nav-label"><%= item[:label] %></span>
              <% end %>
            <% end %>
          </li>
        <% end %>
      </ul>
    </nav>
  </div>

  <div class="sidebar__user" aria-live="polite">
    <div class="sidebar__user-card">
      <div class="sidebar__user-avatar">
        <%= image_tag "chef-hat.webp", alt: "Hat", class: "sidebar__user-avatar-hat", aria: { hidden: true } %>
        <%= image_tag "chef-hat-bg.webp", alt: "Hat", class: "sidebar__user-avatar-hat-bg", aria: { hidden: true } %>
        <% if current_user.slack_id.present? %>
          <%= image_tag current_user.avatar, alt: current_user.display_name, class: "sidebar__user-avatar-placeholder", style: "object-fit: cover;" %>
        <% else %>
          <div class="sidebar__user-avatar-placeholder">
            <%= current_user.display_name.first.upcase %>
          </div>
        <% end %>
      </div>
      <div class="sidebar__user-details">
        <span class="sidebar__user-name"><%= "‚ö° " if current_user.admin? %><%= current_user.display_name %></span>
        <div class="sidebar__user-actions">
          <button type="button" class="sidebar__user-balance" onclick="document.getElementById('balance-modal').showModal()">
            üç™ <%= current_user.balance %>
          </button>
          <button type="button" class="sidebar__user-settings" onclick="document.getElementById('settings-modal').showModal()" aria-label="Settings">
            <%= inline_svg_tag "icons/gear.svg", class: "sidebar__user-settings-icon" %>
          </button>
        </div>
      </div>
    </div>
  </div>

  <%= render layout: "shared/modal", locals: { id: "balance-modal", title: "Transaction History" } do %>
    <%= turbo_frame_tag "balance_history", src: "/my/balance", loading: "lazy" do %>
      <div class="modal__loading">Loading history...</div>
    <% end %>
    <div class="modal__actions">
      <button type="button" class="modal__actions-close" onclick="document.getElementById('balance-modal').close()">Close</button>
    </div>
  <% end %>

  <%= render layout: "shared/modal", locals: { id: "settings-modal", title: "Settings" } do %>
    <%= form_with url: my_settings_path, method: :patch, local: true, class: "settings-form" do |f| %>
      <div class="settings-form__field">
        <label class="settings-form__label" for="hcb_email">HCB Email</label>
        <%= text_field_tag :hcb_email, current_user.hcb_email, id: "hcb_email", class: "settings-form__input", placeholder: current_user.email, autocomplete: "email" %>
        <small class="settings-form__hint">Email used for receiving HCB grants. Leave blank to use your default email.</small>
      </div>

      <div class="settings-form__field">
        <label class="settings-form__checkbox">
          <%= check_box_tag :send_votes_to_slack, "1", current_user.send_votes_to_slack, id: "send_votes_to_slack" %>
          <span>Send votes to Slack</span>
        </label>
        <small class="settings-form__hint">Share your votes in #flavortown-share-votes to help project creators understand how their work is being received</small>
      </div>

      <div class="settings-form__field">
        <label class="settings-form__checkbox">
          <%= check_box_tag :vote_anonymously, "1", current_user.vote_anonymously, id: "vote_anonymously" %>
          <span>Vote anonymously</span>
        </label>
        <small class="settings-form__hint">Hide your identity when sharing votes to Slack</small>
      </div>

      <div class="settings-form__field">
        <label class="settings-form__checkbox">
          <%= check_box_tag :public_api, "1", current_user.public_api, id: "public_api" %>
          <span>Make profile public via API</span>
        </label>
        <small class="settings-form__hint">Allow others to view your profile, projects, and devlogs through the public API</small>
      </div>

      <div class="modal__actions">
        <%= f.submit "Save", class: "modal__actions-close" %>
        <button type="button" class="modal__actions-close" onclick="document.getElementById('settings-modal').close()">Cancel</button>
      </div>


    <% end %>

    <div style="margin-top: 24px;">
      <div class="settings-form__field">
        <label class="settings-form__label" for="api_key">API Key</label>
        <%= text_field_tag :api_key, "Click to show", id: "api_key", class: "settings-form__input", placeholder: "Your API key", autocomplete: "off", readonly: true, onclick: "if(this.value==='Click to show'){this.value='#{current_user.api_key}'; this.select(); setTimeout(() => {this.value='Click to show';}, 10000);}", style: "cursor: pointer;" %>
        <small class="settings-form__hint">Use this key to authenticate API requests. Keep it secret!</small>
      </div>

      <%= form_with url: regenerate_api_key_path, method: :post, local: true do %>
        <button type="submit" class="modal__actions-close" onclick="return confirm('Are you sure? This will invalidate your current API key and any applications using it will stop working.')">Reset API Key</button>
      <% end %>
    </div>


  <% end %>
</aside>
