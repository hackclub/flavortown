<% content_for :title, "Hackatime Time Loss Audit" %>
<h1>Hackatime Time Loss Audit</h1>

<% if @last_audited_at.present? %>
  <p>Last audited: <strong><%= time_ago_in_words(@last_audited_at) %> ago</strong> (<%= @last_audited_at.strftime("%Y-%m-%d %H:%M UTC") %>)</p>
<% else %>
  <p>No audit data yet. Run <code>OneTime::HackatimeTimeLossAuditJob.perform_later</code> from the console or Mission Control.</p>
<% end %>

<div style="display: flex; gap: 1rem; margin: 1rem 0;">
  <div class="card" style="flex: 1; padding: 1rem;">
    <strong>Total Inflation</strong><br>
    <span style="font-size: 1.5rem; color: #c0392b;">+<%= (@total_inflation / 3600.0).round(2) %>h</span>
    <br><small><%= @total_inflation %>s across projects</small>
  </div>
  <div class="card" style="flex: 1; padding: 1rem;">
    <strong>Total Deflation</strong><br>
    <span style="font-size: 1.5rem; color: #2980b9;"><%= (@total_deflation / 3600.0).round(2) %>h</span>
    <br><small><%= @total_deflation %>s across projects</small>
  </div>
  <div class="card" style="flex: 1; padding: 1rem;">
    <strong>Projects Audited</strong><br>
    <span style="font-size: 1.5rem;"><%= @total_projects %></span>
  </div>
</div>

<div style="margin: 1rem 0;">
  <%= link_to "All", admin_time_loss_index_path, class: "btn-primary slim #{params[:filter].blank? ? '' : 'secondary'}" %>
  <%= link_to "Inflation only", admin_time_loss_index_path(filter: "inflation"), class: "btn-primary slim" %>
  <%= link_to "Deflation only", admin_time_loss_index_path(filter: "deflation"), class: "btn-primary slim" %>
</div>

<% if @audits.any? %>
  <table class="table-data">
    <thead>
      <tr>
        <th>Project</th>
        <th>Owner</th>
        <th>Hackatime Keys</th>
        <th>Per-Project Sum</th>
        <th>Ungrouped Total</th>
        <th>Difference</th>
        <th>Devlog Total</th>
        <th>Devlog vs Correct</th>
      </tr>
    </thead>
    <tbody>
      <% @audits.each do |audit| %>
        <tr>
          <td><%= link_to audit.project.title.truncate(30), admin_project_path(audit.project) %></td>
          <td><%= link_to audit.user.display_name.truncate(20), admin_user_path(audit.user) %></td>
          <td><small><%= audit.hackatime_keys.truncate(40) %></small></td>
          <td><%= (audit.per_project_sum_seconds / 3600.0).round(2) %>h</td>
          <td><%= (audit.ungrouped_total_seconds / 3600.0).round(2) %>h</td>
          <td style="color: <%= audit.difference_seconds > 0 ? '#c0392b' : audit.difference_seconds < 0 ? '#2980b9' : 'inherit' %>; font-weight: bold;">
            <%= audit.difference_seconds > 0 ? '+' : '' %><%= (audit.difference_seconds / 3600.0).round(2) %>h
            <br><small>(<%= audit.difference_seconds %>s)</small>
          </td>
          <td><%= (audit.devlog_total_seconds / 3600.0).round(2) %>h</td>
          <td style="color: <%= audit.devlog_total_seconds > audit.ungrouped_total_seconds ? '#c0392b' : 'inherit' %>;">
            <% devlog_drift = audit.devlog_total_seconds - audit.ungrouped_total_seconds %>
            <%= devlog_drift > 0 ? '+' : '' %><%= (devlog_drift / 3600.0).round(2) %>h
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No results found.</p>
<% end %>

<% if @pagy.pages > 1 %>
  <div class="pagination">
    <%== @pagy.series_nav %>
  </div>
<% end %>

<%= link_to "Go back", "/admin", class: "btn-primary" %>
