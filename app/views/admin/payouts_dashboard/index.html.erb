<h1>Payouts Dashboard</h1>

<div class="dashboard-stats">
  <div class="card">
    <h3>Total Circulation</h3>
    <p class="stat-value"><%= number_with_delimiter(@cap) %></p>
  </div>

  <div class="card">
    <h3>Last 24 Hours</h3>
    <table class="stats-table">
      <tr><td>Created</td><td class="positive">+<%= number_with_delimiter(@created) %></td></tr>
      <tr><td>Destroyed</td><td class="negative">-<%= number_with_delimiter(@destroyed) %></td></tr>
      <tr><td>Transactions</td><td><%= number_with_delimiter(@txns) %></td></tr>
      <tr><td>Volume</td><td><%= number_with_delimiter(@volume) %></td></tr>
    </table>
  </div>
</div>

<h2>Top Spenders (24h)</h2>
<% if @spenders.any? %>
  <table class="table-data">
    <thead>
      <tr>
        <th>User</th>
        <th>Amount Spent</th>
      </tr>
    </thead>
    <tbody>
      <% @spenders.each do |(user_data, amount)| %>
        <tr>
          <td><%= link_to user_data[1] || "User ##{user_data[0]}", admin_user_path(user_data[0]) %></td>
          <td><%= number_with_delimiter(amount) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No spending activity in the last 24 hours.</p>
<% end %>

<h2>Top Holders</h2>
<% if @holders.any? %>
  <table class="table-data">
    <thead>
      <tr>
        <th>User</th>
        <th>Balance</th>
      </tr>
    </thead>
    <tbody>
      <% @holders.each do |(user_data, balance)| %>
        <tr>
          <td><%= link_to user_data[1] || "User ##{user_data[0]}", admin_user_path(user_data[0]) %></td>
          <td><%= number_with_delimiter(balance) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No positive balances.</p>
<% end %>

<h2>Sources (24h)</h2>
<% if @sources.any? %>
  <table class="table-data">
    <thead>
      <tr>
        <th>Type</th>
        <th>Direction</th>
        <th>Amount</th>
      </tr>
    </thead>
    <tbody>
      <% @sources.each do |(type, is_positive), amount| %>
        <tr>
          <td><%= type&.humanize || "Unknown" %></td>
          <td><%= is_positive ? "Created" : "Destroyed" %></td>
          <td class="<%= is_positive ? 'positive' : 'negative' %>"><%= number_with_delimiter(amount.abs) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No activity.</p>
<% end %>

<h2>Volume by Type (7 days)</h2>
<% if @types.any? %>
  <table class="table-data">
    <thead>
      <tr>
        <th>Type</th>
        <th>Volume</th>
      </tr>
    </thead>
    <tbody>
      <% @types.sort_by { |_, v| -v }.each do |type, volume| %>
        <tr>
          <td><%= type %></td>
          <td><%= number_with_delimiter(volume) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No activity.</p>
<% end %>

<h2>30-Day Trends</h2>

<div class="payout-charts-container">
  <div class="card payout-chart-card">
    <h3>Daily Creation</h3>
    <canvas id="creationChart"></canvas>
  </div>

  <div class="card payout-chart-card">
    <h3>Daily Destruction</h3>
    <canvas id="destructionChart"></canvas>
  </div>

  <div class="card payout-chart-card">
    <h3>Circulation Over Time</h3>
    <canvas id="circulationChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script id="payout-chart-data">
  <%= {
    creation: @creation.sort.map { |date, amount| { x: date.strftime('%b %d'), y: amount.to_i } },
    destruction: @destruction.sort.map { |date, amount| { x: date.strftime('%b %d'), y: amount.to_i } },
    circulation: @circulation.sort.map { |date, amount| { x: date.strftime('%b %d'), y: amount.to_i } }
  }.to_json.html_safe %>
</script>

<script>
  (() => {
    const chartData = JSON.parse(document.getElementById('payout-chart-data').textContent);

    // Creation Chart
    const creationCtx = document.getElementById('creationChart');
    if (creationCtx) {
      new Chart(creationCtx, {
        type: 'bar',
        data: {
          labels: chartData.creation.map(d => d.x),
          datasets: [{
            label: 'Cookies Created',
            data: chartData.creation.map(d => d.y),
            backgroundColor: 'rgba(16, 185, 129, 0.6)',
            borderColor: 'rgba(16, 185, 129, 1)',
            borderWidth: 1,
            borderRadius: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // Destruction Chart
    const destructionCtx = document.getElementById('destructionChart');
    if (destructionCtx) {
      new Chart(destructionCtx, {
        type: 'bar',
        data: {
          labels: chartData.destruction.map(d => d.x),
          datasets: [{
            label: 'Cookies Destroyed',
            data: chartData.destruction.map(d => d.y),
            backgroundColor: 'rgba(239, 68, 68, 0.6)',
            borderColor: 'rgba(239, 68, 68, 1)',
            borderWidth: 1,
            borderRadius: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }

    // Circulation Chart
    const circulationCtx = document.getElementById('circulationChart');
    if (circulationCtx) {
      new Chart(circulationCtx, {
        type: 'line',
        data: {
          labels: chartData.circulation.map(d => d.x),
          datasets: [{
            label: 'Total Circulation',
            data: chartData.circulation.map(d => d.y),
            borderColor: 'rgba(59, 130, 246, 1)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: 'rgba(59, 130, 246, 1)'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: false,
              ticks: {
                callback: function(value) {
                  return value.toLocaleString();
                }
              }
            }
          }
        }
      });
    }
  })();
</script>

<h2>Recent Transactions</h2>
<% if @recent.any? %>
  <table class="table-data">
    <thead>
      <tr>
        <th>Time</th>
        <th>Created By</th>
        <th>Amount</th>
        <th>Source</th>
        <th>Reason</th>
      </tr>
    </thead>
    <tbody>
      <% @recent.each do |entry| %>
        <tr>
          <td><%= entry.created_at.strftime("%Y-%m-%d %H:%M") %></td>
          <td><%= entry.created_by || "Unknown" %></td>
          <td class="<%= entry.amount >= 0 ? 'positive' : 'negative' %>">
            <%= entry.amount >= 0 ? '+' : '' %><%= number_with_delimiter(entry.amount) %>
          </td>
          <td><%= entry.ledgerable_type&.humanize || "Unknown" %></td>
          <td><%= entry.reason || "-" %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No recent transactions.</p>
<% end %>

<%= link_to "Go back", "/admin", class: "btn-primary" %>

<style>
  .dashboard-stats {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
    margin-bottom: 2rem;
  }

  .stats-table {
    width: 100%;
  }

  .stats-table td {
    padding: 0.25rem 0;
  }

  .stats-table td:last-child {
    text-align: right;
    font-weight: bold;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 0.5rem 0;
  }

  .positive { color: #10b981; }
  .negative { color: #ef4444; }

  .payout-charts-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .payout-chart-card {
    display: flex;
    flex-direction: column;
  }

  .payout-chart-card h3 {
    margin-bottom: 1rem;
  }
</style>
