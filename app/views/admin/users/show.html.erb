<h1>User #<%= @user.id %>, <%= @user.display_name %></h1>

<div class="flex">
  <div class="card">
    <h2>basic info</h2>

    <div class="info-rows">
      <div><b>Name:</b> <%= @user.display_name %></div>
      <div><b>Roles:</b> <%= @user.roles.pluck(:name).join(", ") %></div>
      <div><b>Projects:</b> <%= @user.projects.count %></div>
    </div>
  </div>
  <div class="card">
    <h2>identities</h2>
    <div class="info-rows">
      <% @user.identities.each do |identity| %>
        <div>
          <b><%= identity.provider %>:</b>
          <%= identity.uid %>

          <% if identity.provider == "slack" %>
            <%= link_to "go to slack", "https://hackclub.slack.com/team/#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
          <% end %>

          <% if identity.provider == "hackatime" %>
            <%= link_to "go to billy", "#{Rails.application.config.billy_url}?u=#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
            <%= link_to "go to joe", "#{Rails.application.config.joe_url}profile/#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="card">
    <h2>actions</h2>
    <div class="info-rows">
      <%= link_to "Generate Magic Link", admin_user_magic_link_path(@user), class: "btn-primary slim" %>
      <% slack_identity = @user.identities.find_by(provider: "slack") %>
      <%= button_to "Sync Hackatime Data",
                    sync_hackatime_admin_user_path(@user),
                    method: :post,
                    class: "btn-primary slim",
                    disabled: slack_identity.nil? %>
      <% has_fraud_dept = @user.roles.exists?(name: "fraud_dept") %>
      <%= button_to (has_fraud_dept ? "Demote from Fraud Dept" : "Promote to Fraud Dept"),
                    (has_fraud_dept ? demote_role_admin_user_path(@user) : promote_role_admin_user_path(@user)),
                    method: :post,
                    params: { role_name: "fraud_dept" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>

      <% has_fulfillment = @user.roles.exists?(name: "fulfillment_person") %>
      <%= button_to (has_fulfillment ? "Demote from Fulfillment Person" : "Promote to Fulfillment Person"),
                    (has_fulfillment ? demote_role_admin_user_path(@user) : promote_role_admin_user_path(@user)),
                    method: :post,
                    params: { role_name: "fulfillment_person" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>
          <% has_helper = @user.roles.exists?(name: "helper") %>
      <%= button_to (has_helper ? "Demote from Fulfillment Person" : "Promote to helper"),
                    (has_helper ? demote_role_admin_user_path(@user) : promote_role_admin_user_path(@user)),
                    method: :post,
                    params: { role_name: "helper" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>

              
      <% has_project_certifier = @user.roles.exists?(name: "project_certifier") %>
      <%= button_to (has_project_certifier ? "Demote from Project Certifier" : "Promote to Project Certifier"),
                    (has_project_certifier ? demote_role_admin_user_path(@user) : promote_role_admin_user_path(@user)),
                    method: :post,
                    params: { role_name: "project_certifier" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>

      <% has_admin = @user.roles.exists?(name: "admin") %>
      <%= button_to (has_admin ? "Demote from Admin" : "Promote to Admin"),
                    (has_admin ? demote_role_admin_user_path(@user) : promote_role_admin_user_path(@user)),
                    method: :post,
                    params: { role_name: "admin" },
                    class: "btn-primary slim",
                    disabled: !current_user&.super_admin? %>

      <%= button_to "üé≠ Impersonate User",
                    impersonate_admin_user_path(@user),
                    method: :post,
                    class: "btn-primary slim",
                    disabled: !current_user&.admin?,
                    data: { confirm: "Are you sure you want to impersonate #{@user.display_name}? This action will be logged." } %>
    </div>
  </div>
  <div class="card">
    <h2>flipper features</h2>
    <div class="info-rows">
      <% has_shop_open = Flipper.enabled?(:shop_open, @user) %>
      <%= button_to (has_shop_open ? "Disable Shop" : "Enable Shop"),
                    toggle_flipper_admin_user_path(@user),
                    method: :post,
                    params: { feature: "shop_open" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>

      <% has_admin_green = Flipper.enabled?(:admin_green, @user) %>
      <%= button_to (has_admin_green ? "Disable Admin Green" : "Enable Admin Green"),
                    toggle_flipper_admin_user_path(@user),
                    method: :post,
                    params: { feature: "admin_green" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>

      <% has_admin_dark = Flipper.enabled?(:admin_dark, @user) %>
      <%= button_to (has_admin_dark ? "Disable Admin Dark Mode" : "Enable Admin Dark Mode"),
                    toggle_flipper_admin_user_path(@user),
                    method: :post,
                    params: { feature: "admin_dark" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>
    </div>
  </div>
</div>

<% if @user_actions.any? %>
  <div class="card" style="margin-top: 1.5rem;">
    <h2>Action History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Event</th>
          <th>Changes</th>
          <th>Performed By</th>
        </tr>
      </thead>
      <tbody>
        <% @user_actions.each do |version| %>
          <%
            changes = YAML.load(version.object_changes) rescue {}
            admin = User.find_by(id: version.whodunnit)
          %>
          <tr>
            <td><%= version.created_at.strftime("%Y-%m-%d %H:%M") %></td>
            <td>
              <% case version.event %>
              <% when "flipper_enable" %>
                <span style="color: #10b981; font-weight: 500;">üîì Feature Enabled</span>
              <% when "flipper_disable" %>
                <span style="color: #ef4444; font-weight: 500;">üîí Feature Disabled</span>
              <% when "impersonate_start" %>
                <span style="color: #dc2626; font-weight: 500;">üé≠ Impersonation Started</span>
              <% when "impersonate_end" %>
                <span style="color: #10b981; font-weight: 500;">üé≠ Impersonation Ended</span>
              <% when "update" %>
                <span style="color: #3b82f6; font-weight: 500;">‚úèÔ∏è Updated</span>
              <% when "create" %>
                <span style="color: #10b981; font-weight: 500;">‚úì Created</span>
              <% else %>
                <%= version.event.titleize %>
              <% end %>
            </td>
            <td>
              <% if version.event.starts_with?("flipper_") %>
                <%
                  # Debug: inspect the changes hash
                  feature_array = changes["feature"] || changes[:feature]
                  feature_name = if feature_array.is_a?(Array)
                    feature_array.compact.first
                  else
                    feature_array
                  end
                %>
                <strong><%= feature_name&.titleize || "Unknown Feature" %></strong>
                <% if changes["status"] || changes[:status] %>
                  <% status = changes["status"] || changes[:status] %>
                  (<%= status.first %> ‚Üí <%= status.last %>)
                <% end %>
              <% elsif changes.any? %>
                <% changes.each do |key, value| %>
                  <div><strong><%= key.to_s.titleize %>:</strong> 
                  <% if value.is_a?(Array) %>
                    <%= value.first.inspect %> ‚Üí <%= value.last.inspect %>
                  <% else %>
                    <%= value.inspect %>
                  <% end %>
                  </div>
                <% end %>
              <% else %>
                <em>No changes recorded</em>
              <% end %>
            </td>
            <td>
              <% if admin %>
                <%= link_to admin.display_name, admin_user_path(admin) %>
              <% elsif version.whodunnit %>
                User #<%= version.whodunnit %>
              <% else %>
                <em>System</em>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
    
    <%= link_to "View Full Audit Log ‚Üí", admin_audit_logs_path(item_type: "User", item_id: @user.id), class: "btn-secondary", style: "margin-top: 1rem; display: inline-block;" %>
  </div>
<% end %>

<% if @role_history.any? %>
  <div class="card" style="margin-top: 1.5rem;">
    <h2>Role Change History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Action</th>
          <th>Role</th>
          <th>Changed By</th>
        </tr>
      </thead>
      <tbody>
        <% @role_history.each do |version| %>
          <%
            changes = YAML.load(version.object_changes) rescue {}
            # For create: [nil, 5], for destroy: [5, nil] - we want the non-nil value
            role_id_array = changes["role_id"]
            role_id = if role_id_array.is_a?(Array)
              role_id_array.compact.first
            else
              role_id_array
            end

            role = Role.find_by(id: role_id) if role_id
            admin = User.find_by(id: version.whodunnit)
          %>
          <tr>
            <td><%= version.created_at.strftime("%Y-%m-%d %H:%M") %></td>
            <td>
              <% if version.event == "create" %>
                <span style="color: #10b981; font-weight: 500;">‚úì Promoted</span>
              <% elsif version.event == "destroy" %>
                <span style="color: #ef4444; font-weight: 500;">‚úó Demoted</span>
              <% else %>
                <%= version.event %>
              <% end %>
            </td>
            <td>
              <%= role&.name&.titleize || "Unknown Role" %>
              <% if role_id && !role %>
                (ID: <%= role_id %>)
              <% end %>
            </td>
            <td>
              <% if admin %>
                <%= link_to admin.display_name, admin_user_path(admin) %>
              <% elsif version.whodunnit %>
                User #<%= version.whodunnit %>
              <% else %>
                <em>System</em>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>
