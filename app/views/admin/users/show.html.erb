<h1>User #<%= @user.id %>, <%= @user.display_name %></h1>

<% if @user.banned? %>
  <div class="alert alert--danger" style="margin-bottom: 1rem;">
    <strong>üö´ This user is banned</strong>
    <% if @user.banned_reason.present? %>
      <br>Reason: <%= @user.banned_reason %>
    <% end %>
    <% if @user.banned_at.present? %>
      <br>Banned at: <%= @user.banned_at.strftime("%Y-%m-%d %H:%M") %>
    <% end %>
  </div>
<% end %>

<div class="flex">
  <div class="card">
    <h2>basic info</h2>

    <div class="info-rows">
      <div><b>Name:</b> <%= @user.display_name %></div>
      <div><b>Balance:</b> <%= @user.balance %> tickets</div>
      <div><b>Roles:</b> <%= @user.roles.map { |r| r.to_s.titleize }.join(", ") %></div>
      <div><b>Projects:</b> <%= @user.projects_count %></div>
      <% if @user.fulfillment_person? %>
        <div>
          <b>Region:</b>
          <form method="post" action="<%= admin_user_path(@user) %>" style="display: inline;">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <%= hidden_field_tag :_method, "patch" %>
            <select name="user[region]" onchange="this.form.submit();">
              <option value="">-- Select Region --</option>
              <% Shop::Regionalizable::REGION_CODES.each do |code| %>
                <option value="<%= code %>" <%= "selected" if @user.region == code %>>
                  <%= Shop::Regionalizable.region_name(code) %>
                </option>
              <% end %>
            </select>
          </form>
        </div>
      <% end %>
    </div>
  </div>
  <div class="card">
    <h2>identities</h2>
    <div class="info-rows">
      <% @user.identities.each do |identity| %>
        <div>
          <b><%= identity.provider %>:</b>
          <%= identity.uid %>

          <% if identity.provider == "slack" %>
            <%= link_to "go to slack", "https://hackclub.slack.com/team/#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
          <% end %>

          <% if identity.provider == "hackatime" %>
            <%= link_to "go to billy", "https://billy.3kh0.net/?u=#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
            <%= link_to "go to joe", "https://dash.fraud.land/profile/#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
          <% end %>

            <% if identity.provider == "hack_club" %>
            <%= link_to "go to idv backend", "#{HCAService.backend_url("/identities/#{identity.uid}")}", class: "btn-primary slim", target: "_blank" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="card">
    <h2>actions</h2>
    <div class="info-rows" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      <% if policy(:admin).generate_magic_links? %>
        <%= link_to "üîó Generate Magic Link", admin_user_magic_link_path(@user), class: "btn-primary slim" %>
      <% end %>
      <% slack_identity = @user.identities.find { |i| i.provider == "slack" } %>
      <%= button_to "üï∞Ô∏è Sync Hackatime Data",
                    sync_hackatime_admin_user_path(@user),
                    method: :post,
                    title: "Sync Hackatime Data",
                    class: "btn-primary slim",
                    style: "font-size: 0.75rem; padding: 0.25rem 0.5rem;" %>
      <%= render 'role_toggle', user: @user, role_icon: 'üïµÔ∏è‚Äç‚ôÄÔ∏è', role_name: 'fraud_dept', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_icon: 'üì¶', role_name: 'fulfillment_person', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_icon: 'üö¢', role_name: 'project_certifier', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_icon: '‚ö°', role_name: 'admin', disabled: !current_user&.super_admin? %>

      <% if @user.shop_orders.where(aasm_state: %w[pending awaiting_periodical_fulfillment]).any? %>
        <button type="button" onclick="document.getElementById('reject-modal-orders').showModal()" class="btn-danger slim">
          ‚úó Reject Orders
        </button>
        <%= render layout: "shared/modal", locals: { id: "reject-modal-orders", title: "Reject All Orders", description: "This will reject all pending and awaiting fulfillment orders for #{@user.display_name}." } do %>
          <form action="<%= mass_reject_orders_admin_user_path(@user) %>" method="post">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <div class="modal__field">
              <%= label_tag :reason, "Rejection Reason (optional)" %>
              <%= text_area_tag :reason, "", placeholder: "Enter reason..." %>
            </div>
            <div class="modal__actions">
              <button type="submit" class="btn-danger slim">Confirm Reject</button>
              <button type="button" onclick="document.getElementById('reject-modal-orders').close()" class="btn-secondary slim">Cancel</button>
            </div>
          </form>
        <% end %>
      <% end %>

      <% if policy(:admin).manage_users? %>
        <button type="button" onclick="document.getElementById('adjust-balance-modal').showModal()" class="btn-primary slim">
          üí∞ Adjust Balance
        </button>
        <%= render layout: "shared/modal", locals: { id: "adjust-balance-modal", title: "Adjust Balance", description: "Current balance: #{@user.balance} tickets" } do %>
          <form action="<%= adjust_balance_admin_user_path(@user) %>" method="post">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <div class="modal__field">
              <%= label_tag :amount, "Amount (use negative to decrease)" %>
              <%= number_field_tag :amount, nil, placeholder: "e.g. 100 or -50", required: true, autocomplete: "off" %>
            </div>
            <div class="modal__field">
              <%= label_tag :reason, "Reason (required)" %>
              <%= text_area_tag :reason, "", placeholder: "Enter reason for adjustment...", required: true %>
            </div>
            <div class="modal__actions">
              <button type="submit" class="btn-primary slim">Confirm Adjustment</button>
              <button type="button" onclick="document.getElementById('adjust-balance-modal').close()" class="btn-secondary slim">Cancel</button>
            </div>
          </form>
        <% end %>
      <% end %>

      <% if policy(:admin).ban_users? %>
        <% if @user.banned? %>
          <%= button_to "üîì Unban User", unban_admin_user_path(@user), method: :post, class: "btn-primary slim" %>
        <% else %>
          <button type="button" onclick="document.getElementById('ban-user-modal').showModal()" class="btn-danger slim">
            üö´ Ban User
          </button>
          <%= render layout: "shared/modal", locals: { id: "ban-user-modal", title: "Ban User", description: "This will prevent #{@user.display_name} from accessing the site (except /kitchen)." } do %>
            <form action="<%= ban_admin_user_path(@user) %>" method="post">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <div class="modal__field">
                <%= label_tag :reason, "Ban Reason (optional)" %>
                <%= text_area_tag :reason, "", placeholder: "Enter reason for ban..." %>
              </div>
              <div class="modal__actions">
                <button type="submit" class="btn-danger slim">Confirm Ban</button>
                <button type="button" onclick="document.getElementById('ban-user-modal').close()" class="btn-secondary slim">Cancel</button>
              </div>
            </form>
          <% end %>
        <% end %>
      <% end %>

    </div>
  </div>
  <div class="card">
    <h2>flipper features</h2>
    <div class="info-rows">
      <% has_shop_open = Flipper.enabled?(:shop_open, @user) %>
      <%= button_to (has_shop_open ? "Disable Shop" : "Enable Shop"),
                    toggle_flipper_admin_user_path(@user),
                    method: :post,
                    params: { feature: "shop_open" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>

      <% has_admin_green = Flipper.enabled?(:admin_green, @user) %>
      <%= button_to (has_admin_green ? "Disable Admin Green" : "Enable Admin Green"),
                    toggle_flipper_admin_user_path(@user),
                    method: :post,
                    params: { feature: "admin_green" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>

      <% has_admin_dark = Flipper.enabled?(:admin_dark, @user) %>
      <%= button_to (has_admin_dark ? "Disable Admin Dark Mode" : "Enable Admin Dark Mode"),
                    toggle_flipper_admin_user_path(@user),
                    method: :post,
                    params: { feature: "admin_dark" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>
    </div>
  </div>
</div>

<%= render Admin::PastOrdersComponent.new(user: @user, title: "Shop Orders") %>

<% if @user_actions.any? %>
  <div class="card" style="margin-top: 1.5rem;">
    <h2>Action History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Event</th>
          <th>Changes</th>
          <th>Performed By</th>
        </tr>
      </thead>
      <tbody>
        <% @user_actions.each do |version| %>
          <%
            changes = YAML.load(version.object_changes) rescue {}
            admin = User.find_by(id: version.whodunnit)
          %>
          <tr>
            <td><%= version.created_at.strftime("%Y-%m-%d %H:%M") %></td>
            <td>
              <% case version.event %>
              <% when "flipper_enable" %>
                <span style="color: #10b981; font-weight: 500;">üîì Feature Enabled</span>
              <% when "flipper_disable" %>
                <span style="color: #ef4444; font-weight: 500;">üîí Feature Disabled</span>
              <% when "balance_adjustment" %>
                <span style="color: #3b82f6; font-weight: 500;">üí∞ Balance Adjusted</span>
              <% when "update" %>
                <span style="color: #3b82f6; font-weight: 500;">‚úèÔ∏è Updated</span>
              <% when "create" %>
                <span style="color: #10b981; font-weight: 500;">‚úì Created</span>
              <% else %>
                <%= version.event.titleize %>
              <% end %>
            </td>
            <td>
              <% if version.event.starts_with?("flipper_") %>
                <%
                  # Debug: inspect the changes hash
                  feature_array = changes["feature"] || changes[:feature]
                  feature_name = if feature_array.is_a?(Array)
                    feature_array.compact.first
                  else
                    feature_array
                  end
                %>
                <strong><%= feature_name&.titleize || "Unknown Feature" %></strong>
                <% if changes["status"] || changes[:status] %>
                  <% status = changes["status"] || changes[:status] %>
                  (<%= status.first %> ‚Üí <%= status.last %>)
                <% end %>
              <% elsif version.event == "balance_adjustment" %>
                <%
                  balance = changes["balance"] || changes[:balance]
                  reason = changes["reason"] || changes[:reason]
                  reason = reason.is_a?(Array) ? reason.last : reason
                  created_by = changes["created_by"] || changes[:created_by]
                  created_by = created_by.is_a?(Array) ? created_by.last : created_by
                %>
                <% if balance.is_a?(Array) %>
                  <%= balance.first %> ‚Üí <%= balance.last %> tickets
                <% end %>
                <% if reason.present? %>
                  (<%= reason %>)
                <% end %>
              <% elsif changes.any? %>
                <% changes.except("amount", "ledger_entry_id").each do |key, value| %>
                  <div><strong><%= key.to_s.titleize %>:</strong>
                  <% if value.is_a?(Array) %>
                    <%= value.first.inspect %> ‚Üí <%= value.last.inspect %>
                  <% else %>
                    <%= value.inspect %>
                  <% end %>
                  </div>
                <% end %>
              <% else %>
                <em>No changes recorded</em>
              <% end %>
            </td>
            <td>
              <% if admin %>
                <%= link_to admin.display_name, admin_user_path(admin) %>
              <% elsif version.whodunnit %>
                User #<%= version.whodunnit %>
              <% else %>
                <em>System</em>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <%= link_to "View Full Audit Log ‚Üí", admin_audit_logs_path(item_type: "User", item_id: @user.id), class: "btn-secondary", style: "margin-top: 1rem; display: inline-block;" %>
  </div>
<% end %>

<% if @role_history.any? %>
  <div class="card" style="margin-top: 1.5rem;">
    <h2>Role Change History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Action</th>
          <th>Role</th>
          <th>Changed By</th>
        </tr>
      </thead>
      <tbody>
        <% @role_history.each do |version| %>
          <%
            changes = YAML.load(version.object_changes) rescue {}
            # For create: [nil, 5], for destroy: [5, nil] - we want the non-nil value
            role_int_array = changes["role"]
            role_int = if role_int_array.is_a?(Array)
              role_int_array.compact.first
            else
              role_int_array
            end

            role_name = User::Role.all.find { |r| r.id == role_int }&.name if role_int
            admin = User.find_by(id: version.whodunnit)
          %>
          <tr>
            <td><%= version.created_at.strftime("%Y-%m-%d %H:%M") %></td>
            <td>
              <% if version.event == "create" %>
                <span style="color: #10b981; font-weight: 500;">‚úì Promoted</span>
              <% elsif version.event == "destroy" %>
                <span style="color: #ef4444; font-weight: 500;">‚úó Demoted</span>
              <% else %>
                <%= version.event %>
              <% end %>
            </td>
            <td>
              <%= role_name&.titleize || "Unknown Role" %>
            </td>
            <td>
              <% if admin %>
                <%= link_to admin.display_name, admin_user_path(admin) %>
              <% elsif version.whodunnit %>
                User #<%= version.whodunnit %>
              <% else %>
                <em>System</em>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% end %>
