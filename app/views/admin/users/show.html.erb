<h1>User #<%= @user.id %>, <%= @user.display_name %></h1>

<% if @user.banned? %>
  <div class="alert alert--danger" style="margin-bottom: 1rem;">
    <strong>ğŸš« This user is banned</strong>
    <% if @user.banned_reason.present? %>
      <br>Reason: <%= @user.banned_reason %>
    <% end %>
    <% if @user.banned_at.present? %>
      <br>Banned at: <%= @user.banned_at.strftime("%Y-%m-%d %H:%M") %>
    <% end %>
  </div>
<% end %>

<div class="flex">
  <div class="card">
    <h2>basic info</h2>

    <div class="info-rows">
      <div><b>Name:</b> <%= @user.display_name %></div>
      <div><b>Balance:</b> <%= @user.balance %> tickets</div>
      <div><b>Roles:</b> <%= @user.roles.map { |r| r.to_s.titleize }.join(", ") %></div>
      <div>
        <b>Projects (<%= @all_projects.size %>):</b>
        <ul style="margin: 0.5rem 0 0 1rem; padding: 0; list-style: disc;">
          <% @all_projects.each do |project| %>
            <li>
              <%= link_to project.title, admin_project_path(project), style: "color: #3b82f6;" %>
              <% if project.deleted? %>
                <span style="color: #ef4444; font-weight: 500;">(deleted)</span>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
      <% if @user.fulfillment_person? %>
        <div>
          <b>Regions:</b>
          <form method="post" action="<%= admin_user_path(@user) %>" style="display: inline-block; vertical-align: middle;">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <%= hidden_field_tag :_method, "patch" %>
            <%= hidden_field_tag "user[regions][]", "" %>
            <div class="region-checkboxes" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.25rem;">
              <% Shop::Regionalizable::REGION_CODES.each do |code| %>
                <label class="region-checkbox" style="display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; background: var(--color-tan-400); border: 2px solid var(--color-brown-500); border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem; transition: background 0.1s, border-color 0.1s;">
                  <input type="checkbox"
                         name="user[regions][]"
                         value="<%= code %>"
                         <%= "checked" if @user.regions.include?(code) %>
                         style="accent-color: var(--color-brown-500); width: 1rem; height: 1rem;">
                  <span><%= Shop::Regionalizable.region_name(code) %></span>
                </label>
              <% end %>
            </div>
            <button type="submit" class="btn-primary slim" style="margin-top: 0.5rem;">Save Regions</button>
          </form>
        </div>
      <% end %>
    </div>
  </div>
  <div class="card">
    <h2>identities</h2>
    <div class="info-rows">
      <% @user.identities.each do |identity| %>
        <div>
          <b><%= identity.provider %>:</b>
          <%= identity.uid %>

          <% if identity.provider == "slack" %>
            <%= link_to "go to slack", "https://hackclub.slack.com/team/#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
          <% end %>

          <% if identity.provider == "hackatime" %>
            <%= link_to "go to billy", "https://billy.3kh0.net/?u=#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
            <%= link_to "go to joe", "https://dash.fraud.land/profile/#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
          <% end %>

            <% if identity.provider == "hack_club" %>
            <%= link_to "go to idv backend", "#{HCAService.backend_url("/identities/#{identity.uid}")}", class: "btn-primary slim", target: "_blank" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="card">
    <h2>actions</h2>
    <div class="info-rows" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
      <% if policy(:admin).generate_magic_links? %>
        <%= link_to "ğŸ”— Generate Magic Link", admin_user_magic_link_path(@user), class: "btn-primary slim" %>
      <% end %>
      <% if policy(@user).impersonate? && !impersonating? %>
        <%= button_to "Impersonate User",
                      impersonate_admin_user_path(@user),
                      method: :post,
                      class: "btn-primary slim",
                      data: {
                        confirm: "Are you sure you want to impersonate #{@user.display_name}? You will see the site as they do."
                      } %>
      <% end %>
      <% slack_identity = @user.identities.find { |i| i.provider == "slack" } %>
      <%= button_to "ğŸ•°ï¸ Sync Hackatime Data",
                    sync_hackatime_admin_user_path(@user),
                    method: :post,
                    title: "Sync Hackatime Data",
                    class: "btn-primary slim",
                    style: "font-size: 0.75rem; padding: 0.25rem 0.5rem;" %>
      <%= button_to "ğŸ”„ Refresh Verification",
                    refresh_verification_admin_user_path(@user),
                    method: :post,
                    title: "Refresh verification status from HCA",
                    class: "btn-primary slim",
                    data: { confirm: "Refresh verification status for #{@user.display_name}?" } %>
      <%= render 'role_toggle', user: @user, role_icon: 'ğŸ•µï¸â€â™€ï¸', role_name: 'fraud_dept', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_icon: 'ğŸ“¦', role_name: 'fulfillment_person', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_icon: 'ğŸš¢', role_name: 'project_certifier', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_icon: 'âœ‹', role_name: 'helper', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_icon: 'âš¡', role_name: 'admin', disabled: !current_user&.super_admin? %>

      <% if @user.shop_orders.where(aasm_state: %w[pending awaiting_periodical_fulfillment]).any? %>
        <button type="button" onclick="document.getElementById('reject-modal-orders').showModal()" class="btn-danger slim">
          âœ— Reject Orders
        </button>
        <%= render layout: "shared/modal", locals: { id: "reject-modal-orders", title: "Reject All Orders", description: "This will reject all pending and awaiting fulfillment orders for #{@user.display_name}." } do %>
          <form action="<%= mass_reject_orders_admin_user_path(@user) %>" method="post">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <div class="modal__field">
              <%= label_tag :reason, "Rejection Reason (optional)" %>
              <%= text_area_tag :reason, "", placeholder: "Enter reason..." %>
            </div>
            <div class="modal__actions">
              <button type="submit" class="btn-danger slim">Confirm Reject</button>
              <button type="button" onclick="document.getElementById('reject-modal-orders').close()" class="btn-secondary slim">Cancel</button>
            </div>
          </form>
        <% end %>
      <% end %>

      <% if policy(:admin).manage_users? %>
        <button type="button" onclick="document.getElementById('adjust-balance-modal').showModal()" class="btn-primary slim">
          ğŸ’° Adjust Balance
        </button>
        <%= render layout: "shared/modal", locals: { id: "adjust-balance-modal", title: "Adjust Balance", description: "Current balance: #{@user.balance} tickets" } do %>
          <form action="<%= adjust_balance_admin_user_path(@user) %>" method="post">
            <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
            <div class="modal__field">
              <%= label_tag :amount, "Amount (use negative to decrease)" %>
              <%= number_field_tag :amount, nil, placeholder: "e.g. 100 or -50", required: true, autocomplete: "off" %>
            </div>
            <div class="modal__field">
              <%= label_tag :reason, "Reason (required)" %>
              <%= text_area_tag :reason, "", placeholder: "Enter reason for adjustment...", required: true %>
            </div>
            <div class="modal__actions">
              <button type="submit" class="btn-primary slim">Confirm Adjustment</button>
              <button type="button" onclick="document.getElementById('adjust-balance-modal').close()" class="btn-secondary slim">Cancel</button>
            </div>
          </form>
        <% end %>
      <% end %>

      <% if current_user.admin? %>
        <% has_grants = @user.shop_card_grants.where.not(hcb_grant_hashid: nil).exists? %>
        <button type="button" onclick="document.getElementById('cancel-grants-modal').showModal()" class="btn-danger slim" <%= 'disabled style="opacity: 0.5; cursor: not-allowed;"'.html_safe unless has_grants %>>
          ğŸš« Cancel All HCB Grants
        </button>
        <% if has_grants %>
          <%= render layout: "shared/modal", locals: { id: "cancel-grants-modal", title: "Cancel All HCB Grants", description: "This will cancel ALL HCB grants for #{@user.display_name}. This action cannot be undone!" } do %>
            <form action="<%= cancel_all_hcb_grants_admin_user_path(@user) %>" method="post">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <p style="color: #ef4444; font-weight: bold;">âš ï¸ Warning: This will cancel <%= @user.shop_card_grants.where.not(hcb_grant_hashid: nil).count %> grant(s).</p>
              <div class="modal__actions">
                <button type="submit" class="btn-danger slim">Confirm Cancel All Grants</button>
                <button type="button" onclick="document.getElementById('cancel-grants-modal').close()" class="btn-secondary slim">Cancel</button>
              </div>
            </form>
          <% end %>
        <% end %>
      <% end %>

      <% if policy(:admin).ban_users? %>
        <% if @user.shadow_banned? %>
          <%= button_to "ğŸ‘ï¸ Remove Shadow Ban", unshadow_ban_admin_user_path(@user), method: :post, class: "btn-primary slim" %>
        <% else %>
          <button type="button" onclick="document.getElementById('shadow-ban-modal').showModal()" class="btn-secondary slim">
            ğŸ‘» Shadow Ban
          </button>
          <%= render layout: "shared/modal", locals: { id: "shadow-ban-modal", title: "Shadow Ban User", description: "This will hide #{@user.display_name}'s projects from voting, explore, and API without notifying them." } do %>
            <form action="<%= shadow_ban_admin_user_path(@user) %>" method="post">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <div class="modal__field">
                <%= label_tag :reason, "Shadow Ban Reason (optional)" %>
                <%= text_area_tag :reason, "", placeholder: "Enter reason for shadow ban..." %>
              </div>
              <div class="modal__actions">
                <button type="submit" class="btn-secondary slim">Confirm Shadow Ban</button>
                <button type="button" onclick="document.getElementById('shadow-ban-modal').close()" class="btn-secondary slim">Cancel</button>
              </div>
            </form>
          <% end %>
        <% end %>

        <% if @user.banned? %>
          <%= button_to "ğŸ”“ Unban User", unban_admin_user_path(@user), method: :post, class: "btn-primary slim" %>
        <% else %>
          <button type="button" onclick="document.getElementById('ban-user-modal').showModal()" class="btn-danger slim">
            ğŸš« Ban User
          </button>
          <%= render layout: "shared/modal", locals: { id: "ban-user-modal", title: "Ban User", description: "This will prevent #{@user.display_name} from accessing the site (except /kitchen)." } do %>
            <form action="<%= ban_admin_user_path(@user) %>" method="post">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <div class="modal__field">
                <%= label_tag :reason, "Ban Reason (optional)" %>
                <%= text_area_tag :reason, "", placeholder: "Enter reason for ban..." %>
              </div>
              <div class="modal__actions">
                <button type="submit" class="btn-danger slim">Confirm Ban</button>
                <button type="button" onclick="document.getElementById('ban-user-modal').close()" class="btn-secondary slim">Cancel</button>
              </div>
            </form>
          <% end %>
        <% end %>
      <% end %>

    </div>
  </div>
  <div class="card">
    <h2>flipper features</h2>
    <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
      <%
        features = [
          { key: :shop_open, label: "Shop" },
          { key: :admin_green, label: "Admin Green" },
          { key: :admin_dark, label: "Admin Dark" },
          { key: :scrapbook_devlogs, label: "Devlogs" },
          { key: :"git_commit_2025-12-25", label: "Git Commit" },
          { key: :kitchen_comic, label: "Kitchen Comic" },
          { key: :voting, label: "Voting" },
          { key: :christmas_theme, label: "Christmas" },
          { key: :grant_cookies, label: "Grant Cookies" }
        ]
      %>
      <% features.each do |f| %>
        <% enabled = Flipper.enabled?(f[:key], @user) %>
        <%= button_to toggle_flipper_admin_user_path(@user),
                      method: :post,
                      params: { feature: f[:key].to_s },
                      class: "btn-primary",
                      style: "font-size: 0.65rem; padding: 0.2rem 0.4rem; background: #{enabled ? '#22c55e' : '#6b7280'};",
                      disabled: !current_user&.admin?,
                      title: "#{enabled ? 'Disable' : 'Enable'} #{f[:label]}" do %>
          <%= f[:label] %><%= enabled ? " âœ“" : "" %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<div class="card" style="margin-top: 1rem;">
  <h2 style="font-size: 0.875rem; font-weight: 600; padding: 0.25rem 0; color: #374151;">
    ğŸ“ Internal Notes
  </h2>
  <p style="color: #666; font-size: 0.75rem; margin-bottom: 0.5rem;">Only visible to admins and fraud dept. Changes are audit logged.</p>
  <form action="<%= admin_user_path(@user) %>" method="post">
    <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
    <%= hidden_field_tag :_method, "patch" %>
    <%= text_area_tag "user[internal_notes]", @user.internal_notes,
        placeholder: "Add internal notes about this user...",
        rows: 4,
        style: "width: 100%; resize: vertical; font-family: inherit; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;" %>
    <button type="submit" class="btn-primary slim" style="margin-top: 0.5rem;">Save Notes</button>
  </form>
</div>

<%= render Admin::PastOrdersComponent.new(user: @user, title: "Shop Orders") %>

<% if @user_actions.any? %>
  <div class="card" style="margin-top: 1.5rem;">
    <h2>Action History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Event</th>
          <th>Changes</th>
          <th>Performed By</th>
        </tr>
      </thead>
      <tbody>
        <% @user_actions.each do |action| %>
          <% if action.is_a?(LedgerEntry) %>
            <tr>
              <td><%= action.created_at.strftime("%Y-%m-%d %H:%M") %></td>
              <td>
                <% if action.amount < 0 %>
                  <span style="color: #ef4444; font-weight: 500;">ğŸ›’ Shop Purchase</span>
                <% else %>
                  <span style="color: #10b981; font-weight: 500;">ğŸ’° Balance Credit</span>
                <% end %>
              </td>
              <td>
                <strong><%= action.amount > 0 ? "+#{action.amount}" : action.amount %> tickets</strong>
                <% if action.reason.present? %>
                  (<%= action.reason %>)
                <% end %>
              </td>
              <td>
                <% if action.created_by.present? && (match = action.created_by.match(/\((\d+)\)$/)) && (performer = User.find_by(id: match[1])) %>
                  <%= link_to performer.display_name, admin_user_path(performer) %>
                <% elsif action.created_by.present? %>
                  <%= action.created_by %>
                <% else %>
                  <em>System</em>
                <% end %>
              </td>
            </tr>
          <% else %>
            <%
              version = action
              # Handle both YAML strings (old data) and native JSONB hashes (new data)
              raw_changes = version.object_changes
              changes = if raw_changes.is_a?(Hash)
                raw_changes.with_indifferent_access
              elsif raw_changes.is_a?(String) && raw_changes.present?
                (YAML.safe_load(raw_changes, permitted_classes: [Time, Date, DateTime, BigDecimal, Symbol]) || {}).with_indifferent_access rescue {}
              else
                {}.with_indifferent_access
              end
              admin = User.find_by(id: version.whodunnit)
              is_ban_event = changes["banned"].is_a?(Array) rescue false
              is_magic_link_event = changes["magic_link_token"].is_a?(Array) rescue false
              is_internal_notes_event = changes["internal_notes"].is_a?(Array) rescue false
            %>
            <tr>
              <td><%= version.created_at.strftime("%Y-%m-%d %H:%M") %></td>
              <td>
                <% if version.event == "role_promoted" %>
                  <span style="color: #10b981; font-weight: 500;">ğŸ‘‘ Role Promoted</span>
                <% elsif version.event == "role_demoted" %>
                  <span style="color: #ef4444; font-weight: 500;">ğŸ‘‘ Role Demoted</span>
                <% elsif is_ban_event %>
                  <% if changes["banned"]&.last == true %>
                    <span style="color: #ef4444; font-weight: 500;">ğŸš« Banned</span>
                  <% else %>
                    <span style="color: #10b981; font-weight: 500;">âœ… Unbanned</span>
                  <% end %>
                <% elsif is_magic_link_event && changes["magic_link_token"]&.last.present? %>
                  <span style="color: #f59e0b; font-weight: 500;">ğŸ”— Magic Link Created</span>
                <% elsif is_internal_notes_event %>
                  <span style="color: #6366f1; font-weight: 500;">ğŸ“ Internal Notes Updated</span>
                <% elsif version.event == "address_revealed" %>
                  <span style="color: #f59e0b; font-weight: 500;">ğŸ“ Address Revealed</span>
                <% else %>
                  <% case version.event
                     when "flipper_enable" %>
                    <span style="color: #10b981; font-weight: 500;">ğŸ”“ Feature Enabled</span>
                  <% when "flipper_disable" %>
                    <span style="color: #ef4444; font-weight: 500;">ğŸ”’ Feature Disabled</span>
                  <% when "balance_adjustment" %>
                    <span style="color: #3b82f6; font-weight: 500;">ğŸ’° Balance Adjusted</span>
                  <% when "update" %>
                    <span style="color: #3b82f6; font-weight: 500;">âœï¸ Updated</span>
                  <% when "create" %>
                    <span style="color: #10b981; font-weight: 500;">âœ“ Created</span>
                  <% else %>
                    <%= version.event.titleize %>
                  <% end %>
                <% end %>
              </td>
              <td>
                <% if version.event == "role_promoted" || version.event == "role_demoted" %>
                  <% role_name_str = changes["role"] || changes[:role] %>
                  <strong><%= role_name_str&.to_s&.titleize || "Unknown Role" %></strong>
                <% elsif is_ban_event %>
                  <% ban_reason = changes["banned_reason"]&.last %>
                  <% if ban_reason.present? %>
                    Reason: <%= ban_reason %>
                  <% else %>
                    <em>No reason provided</em>
                  <% end %>
                <% elsif is_magic_link_event && changes["magic_link_token"]&.last.present? %>
                  Expires: <%= changes["magic_link_token_expires_at"]&.last %>
                <% elsif is_internal_notes_event %>
                  <% new_notes = changes["internal_notes"]&.last %>
                  <% if new_notes.present? %>
                    Changed to: "<%= truncate(new_notes, length: 100) %>"
                  <% else %>
                    <em>Notes cleared</em>
                  <% end %>
                <% elsif version.event == "address_revealed" %>
                  <% order_id = changes["order_id"] || changes[:order_id] %>
                  <% shop_item_name = changes["shop_item"] || changes[:shop_item] %>
                  <% if order_id.present? %>
                    <%= link_to "Order ##{order_id}", admin_shop_order_path(order_id) %> (<%= shop_item_name %>)
                  <% else %>
                    <em>Order details unavailable</em>
                  <% end %>
                <% elsif version.event.starts_with?("flipper_") %>
                <%
                  feature_array = changes["feature"] || changes[:feature]
                  feature_name = if feature_array.is_a?(Array)
                    feature_array.compact.first
                  else
                    feature_array
                  end
                %>
                <strong><%= feature_name&.titleize || "Unknown Feature" %></strong>
                <% if changes["status"] || changes[:status] %>
                  <% status = changes["status"] || changes[:status] %>
                  (<%= status.first %> â†’ <%= status.last %>)
                <% end %>
              <% elsif version.event == "balance_adjustment" %>
                <%
                  balance = changes["balance"] || changes[:balance]
                  reason = changes["reason"] || changes[:reason]
                  reason = reason.is_a?(Array) ? reason.last : reason
                  created_by = changes["created_by"] || changes[:created_by]
                  created_by = created_by.is_a?(Array) ? created_by.last : created_by
                %>
                <% if balance.is_a?(Array) %>
                  <%= balance.first %> â†’ <%= balance.last %> tickets
                <% end %>
                <% if reason.present? %>
                  (<%= reason %>)
                <% end %>
              <% elsif changes.any? %>
                <% changes.except("amount", "ledger_entry_id").each do |key, value| %>
                  <div><strong><%= key.to_s.titleize %>:</strong>
                  <% if value.is_a?(Array) %>
                    <%= value.first.inspect %> â†’ <%= value.last.inspect %>
                  <% else %>
                    <%= value.inspect %>
                  <% end %>
                  </div>
                <% end %>
              <% else %>
                <em>No changes recorded</em>
              <% end %>
            </td>
            <td>
              <% if admin %>
                <%= link_to admin.display_name, admin_user_path(admin) %>
              <% elsif version.whodunnit %>
                User #<%= version.whodunnit %>
              <% elsif version.event == "balance_adjustment" && defined?(created_by) && created_by.present? %>
                <% if (match = created_by.match(/\((\d+)\)$/)) && (adjuster = User.find_by(id: match[1])) %>
                  <%= link_to adjuster.display_name, admin_user_path(adjuster) %>
                <% else %>
                  <%= created_by %>
                <% end %>
              <% else %>
                <em>System</em>
              <% end %>
            </td>
          </tr>
          <% end %>
        <% end %>
      </tbody>
    </table>

    <%= link_to "View Full Audit Log â†’", admin_audit_logs_path(item_type: "User", item_id: @user.id), class: "btn-secondary", style: "margin-top: 1rem; display: inline-block;" %>
  </div>
<% end %>
