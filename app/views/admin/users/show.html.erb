<h1>User #<%= @user.id %>, <%= @user.display_name %></h1>

<div class="flex">
  <div class="card">
    <h2>basic info</h2>

    <div class="info-rows">
      <div><b>Name:</b> <%= @user.display_name %></div>
      <div><b>Roles:</b> <%= @user.role_assignments.map(&:role).join(", ") %></div>
      <div><b>Projects:</b> <%= @user.projects_count %></div>
    </div>
  </div>
  <div class="card">
    <h2>identities</h2>
    <div class="info-rows">
      <% @user.identities.each do |identity| %>
        <div>
          <b><%= identity.provider %>:</b>
          <%= identity.uid %>

          <% if identity.provider == "slack" %>
            <%= link_to "go to slack", "https://hackclub.slack.com/team/#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
          <% end %>

          <% if identity.provider == "hackatime" %>
            <%= link_to "go to billy", "#{Rails.application.config.billy_url}?u=#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
            <%= link_to "go to joe", "#{Rails.application.config.joe_url}profile/#{identity.uid}", class: "btn-primary slim", target: "_blank" %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <div class="card">
    <h2>actions</h2>
    <div class="info-rows">
      <%= link_to "Generate Magic Link", admin_user_magic_link_path(@user), class: "btn-primary slim" %>
      <% slack_identity = @user.identities.find { |i| i.provider == "slack" } %>
      <%= button_to "Sync Hackatime Data",
                    sync_hackatime_admin_user_path(@user),
                    method: :post,
                    class: "btn-primary slim",
                    disabled: slack_identity.nil? %>
      <%= render 'role_toggle', user: @user, role_name: 'fraud_dept', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_name: 'fulfillment_person', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_name: 'project_certifier', disabled: !current_user&.admin? %>
      <%= render 'role_toggle', user: @user, role_name: 'admin', disabled: !current_user&.super_admin? %>
    </div>
  </div>
  <div class="card">
    <h2>flipper features</h2>
    <div class="info-rows">
      <% has_shop_open = Flipper.enabled?(:shop_open, @user) %>
      <%= button_to (has_shop_open ? "Disable Shop" : "Enable Shop"),
                    toggle_flipper_admin_user_path(@user),
                    method: :post,
                    params: { feature: "shop_open" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>

      <% has_admin_green = Flipper.enabled?(:admin_green, @user) %>
      <%= button_to (has_admin_green ? "Disable Admin Green" : "Enable Admin Green"),
                    toggle_flipper_admin_user_path(@user),
                    method: :post,
                    params: { feature: "admin_green" },
                    class: "btn-primary slim",
                    disabled: !current_user&.admin? %>
    </div>
  </div>
</div>

<% if @role_history.any? %>
  <div class="card" style="margin-top: 1.5rem;">
    <h2>Role Change History</h2>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Action</th>
          <th>Role</th>
          <th>Changed By</th>
        </tr>
      </thead>
      <tbody>
        <% @role_history.each do |version| %>
          <%
            changes = YAML.load(version.object_changes) rescue {}
            # For create: [nil, 5], for destroy: [5, nil] - we want the non-nil value
            role_int_array = changes["role"]
            role_int = if role_int_array.is_a?(Array)
              role_int_array.compact.first
            else
              role_int_array
            end

            role_name = User::RoleAssignment.roles.key(role_int) if role_int
            admin = User.find_by(id: version.whodunnit)
          %>
          <tr>
            <td><%= version.created_at.strftime("%Y-%m-%d %H:%M") %></td>
            <td>
              <% if version.event == "create" %>
                <span style="color: #10b981; font-weight: 500;">✓ Promoted</span>
              <% elsif version.event == "destroy" %>
                <span style="color: #ef4444; font-weight: 500;">✗ Demoted</span>
              <% else %>
                <%= version.event %>
              <% end %>
            </td>
            <td>
              <%= role_name&.titleize || "Unknown Role" %>
            </td>
            <td>
              <% if admin %>
                <%= admin.display_name %>
              <% elsif version.whodunnit %>
                User #<%= version.whodunnit %>
              <% else %>
                <em>System</em>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <%= link_to "View Full Audit Log →", admin_audit_logs_path(item_type: "User::RoleAssignment", whodunnit: @user.id), class: "btn-secondary", style: "margin-top: 1rem; display: inline-block;" %>
  </div>
<% end %>
