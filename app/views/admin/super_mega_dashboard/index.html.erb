<div class="super-mega-dashboard">
  <%= render HeadingComponent.new(title: "Super Mega Dashboard", tone: :red, size: :full) %>

  <h2>COMICALLY LARGE TEXT THANKING ROWAN AND SHREYAS</h2>
  <h3>(prob remove before merging in prod)</h3>

  <div class="super-mega-dashboard__dashboards">
    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--fraud">
        <h2>Fraud Overview</h2>
        <%= link_to "View Full Dashboard →", admin_fraud_dashboard_path, class: "super-mega-link" %>
      </div>

      <!-- SHOP ORDERS SECTION -->
      <div class="fraud-subsection">
        <h3 class="fraud-subsection__title">Shop Orders</h3>
        <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3>Order Queue</h3>
          <div class="fraud-stats-grid">
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">Pending</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--yellow"><%= @fraud_orders[:pending] %><span class="fraud-stats-grid__pct">(<%= @fraud_orders[:pending_pct] %>%)</span></span>
            </div>
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">Awaiting</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--blue"><%= @fraud_orders[:awaiting] %><span class="fraud-stats-grid__pct">(<%= @fraud_orders[:awaiting_pct] %>%)</span></span>
            </div>
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">Total Backlog</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--red"><%= @fraud_orders[:backlog] %><span class="fraud-stats-grid__pct">(<%= @fraud_orders[:backlog_pct] %>%)</span></span>
            </div>
          </div>
        </div>

        <div class="super-mega-dashboard__card super-mega-dashboard__card--mini-graph">
          <h3>Orders Over Time</h3>
          <% if @fraud_shop_order_trend_data.present? %>
            <div class="fraud-timeline-graph fraud-timeline-graph--compact">
              <canvas id="shopReviewChart" height="100"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('shopReviewChart');
                if (!ctx) return;

                const data = <%= raw @fraud_shop_order_trend_data.to_json %>;
                const sortedDates = Object.keys(data).sort();
                const labels = sortedDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                // Group by state
                const stateMap = {};
                sortedDates.forEach(date => {
                  Object.entries(data[date] || {}).forEach(([state, count]) => {
                    if (!stateMap[state]) stateMap[state] = {};
                    stateMap[state][date] = count;
                  });
                });

                // Define colors for different states
                const stateColors = {
                  'pending': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                  'awaiting_periodical_fulfillment': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
                  'fulfilled': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                  'rejected': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                  'on_hold': { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' }
                };

                // Build datasets
                const datasets = Object.entries(stateMap).map(([state, dates]) => {
                  const dataArray = sortedDates.map(d => dates[d] || 0);
                  const colors = stateColors[state] || { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' };
                  return {
                    label: state.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    data: dataArray,
                    borderColor: colors.border,
                    backgroundColor: colors.bg,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 1,
                    borderWidth: 1.5
                  };
                });

                new Chart(ctx, {
                  type: 'line',
                  data: { labels: labels, datasets: datasets },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 8 }, padding: 4 }
                      }
                    },
                    scales: {
                      x: {
                        ticks: { font: { size: 7 }, maxRotation: 45, minRotation: 0 }
                      },
                      y: {
                        beginAtZero: true,
                        ticks: { precision: 0, font: { size: 7 } }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p class="fraud-stats-error">No data available</p>
          <% end %>
        </div>
        </div>
      </div>

      <!-- JOE SECTION -->
      <div class="fraud-subsection">
        <h3 class="fraud-subsection__title">Joe Cases</h3>
        <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3>Second Chances</h3>
          <% if @joe_fraud_stats && !@joe_fraud_stats[:error] %>
            <div class="fraud-stats-grid">
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Given (Joe)</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--green"><%= @joe_fraud_stats[:second_chances_given] %></span>
              </div>
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Unbanned Today</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--green"><%= @fraud_second_chances[:unbans_today] %></span>
              </div>
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Banned Today</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--red"><%= @fraud_second_chances[:bans_today] %></span>
              </div>
            </div>
          <% else %>
            <p class="fraud-stats-error"><%= @joe_fraud_stats&.dig(:error) || "No Joe data" %></p>
          <% end %>
        </div>

        <div class="super-mega-dashboard__card">
          <h3>Joe Cases</h3>
          <% if @joe_fraud_stats && !@joe_fraud_stats[:error] %>
            <% total_joe_cases = @joe_fraud_stats[:total] %>
            <% fraudpheus_pct = @joe_fraud_stats[:open] > 0 ? ((@joe_fraud_stats[:fraudpheus_open].to_f / @joe_fraud_stats[:open]) * 100).round(1) : 0 %>
            <% open_pct = (((@joe_fraud_stats[:open].to_f / total_joe_cases) * 100).round(1)) %>
            <% closed_pct = (((@joe_fraud_stats[:closed].to_f / total_joe_cases) * 100).round(1)) %>
            <div class="fraud-stats-grid">
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Open</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--yellow"><%= @joe_fraud_stats[:open] %><span class="fraud-stats-grid__pct">(<%= open_pct %>%)</span></span>
              </div>
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Fraudpheus Open</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--red"><%= @joe_fraud_stats[:fraudpheus_open] %><span class="fraud-stats-grid__pct">(<%= fraudpheus_pct %>%)</span></span>
              </div>
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Closed</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--green"><%= @joe_fraud_stats[:closed] %><span class="fraud-stats-grid__pct">(<%= closed_pct %>%)</span></span>
              </div>
            </div>
          <% else %>
            <p class="fraud-stats-error"><%= @joe_fraud_stats&.dig(:error) || "No Joe data" %></p>
          <% end %>
        </div>

        <div class="super-mega-dashboard__card">
          <h3>Review Quality</h3>
          <% total_all_reviewed = @fraud_review_quality[:total_reviewed] %>
          <% this_week_pct = total_all_reviewed > 0 ? ((@fraud_review_quality[:this_week].to_f / total_all_reviewed) * 100).round(1) : 0 %>
          <div class="fraud-stats-grid">
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">Avg Review Time</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--blue"><%= @fraud_review_quality[:avg_review_hours] %>h</span>
            </div>
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">Total Reviewed</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--purple"><%= @fraud_review_quality[:total_reviewed] %></span>
            </div>
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">This Week</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--yellow"><%= @fraud_review_quality[:this_week] %><span class="fraud-stats-grid__pct">(<%= this_week_pct %>%)</span></span>
            </div>
          </div>
        </div>

        <div class="super-mega-dashboard__card super-mega-dashboard__card--mini-graph">
          <h3>Case Status Timeline</h3>
          <% if @joe_fraud_stats && @joe_fraud_stats[:timeline]&.any? && !@joe_fraud_stats[:error] %>
            <div class="fraud-timeline-graph fraud-timeline-graph--compact">
              <canvas id="fraudTimelineChart" height="100"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('fraudTimelineChart');
                if (!ctx) return;

                const timeline = <%= raw @joe_fraud_stats[:timeline].to_json %>;

                // Group by status
                const statusMap = {};
                timeline.forEach(entry => {
                  if (!statusMap[entry.status]) {
                    statusMap[entry.status] = {};
                  }
                  statusMap[entry.status][entry.date] = entry.count;
                });

                // Get all unique dates
                const allDates = [...new Set(timeline.map(e => e.date))].sort();
                const labels = allDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                // Define colors for different statuses
                const statusColors = {
                  'second_chance_given': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                  'banned': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                  'fraudpheus_open': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                  'other': { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }
                };

                // Build datasets
                const datasets = Object.entries(statusMap).map(([status, dates]) => {
                  const data = allDates.map(d => dates[d] || 0);
                  const colors = statusColors[status] || { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' };
                  return {
                    label: status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    data: data,
                    borderColor: colors.border,
                    backgroundColor: colors.bg,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 1,
                    borderWidth: 1.5
                  };
                });

                new Chart(ctx, {
                  type: 'line',
                  data: { labels: labels, datasets: datasets },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 8 }, padding: 4 }
                      }
                    },
                    scales: {
                      x: {
                        ticks: { font: { size: 7 }, maxRotation: 45, minRotation: 0 }
                      },
                      y: {
                        beginAtZero: true,
                        ticks: { precision: 0, font: { size: 7 } }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p class="fraud-stats-error">No timeline data available</p>
          <% end %>
        </div>

        <div class="super-mega-dashboard__card super-mega-dashboard__card--mini-graph">
          <h3>Bans Over Time</h3>
          <% if @fraud_ban_trend_data.present? %>
            <div class="fraud-timeline-graph fraud-timeline-graph--compact">
              <canvas id="banTrendChart" height="100"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('banTrendChart');
                if (!ctx) return;

                const data = <%= raw @fraud_ban_trend_data.to_json %>;
                const sortedDates = Object.keys(data).sort();
                const labels = sortedDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                const bansData = sortedDates.map(d => data[d].bans);
                const unbansData = sortedDates.map(d => data[d].unbans);

                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        label: 'Bans',
                        data: bansData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 1,
                        borderWidth: 1.5
                      },
                      {
                        label: 'Unbans',
                        data: unbansData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 1,
                        borderWidth: 1.5
                      }
                    ]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 8 }, padding: 4 }
                      }
                    },
                    scales: {
                      x: {
                        ticks: { font: { size: 7 }, maxRotation: 45, minRotation: 0 }
                      },
                      y: {
                        beginAtZero: true,
                        ticks: { precision: 0, font: { size: 7 } }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p class="fraud-stats-error">No trend data available</p>
          <% end %>
          </div>
          </div>
          </div>

          <!-- REPORTS SECTION -->
          <div class="fraud-subsection">
          <h3 class="fraud-subsection__title">Fraud Reports</h3>
          <div class="super-mega-dashboard__cards">
          <div class="super-mega-dashboard__card">
          <h3>Report Stats</h3>
          <div class="fraud-stats-grid">
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">New Today</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--blue"><%= @fraud_reports[:new_today] %></span>
           </div>
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Pending</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--yellow"><%= @fraud_reports[:pending] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:pending_pct] %>%)</span></span>
           </div>
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Reviewed</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--red"><%= @fraud_reports[:reviewed] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:reviewed_pct] %>%)</span></span>
           </div>
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Dismissed</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--green"><%= @fraud_reports[:dismissed] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:dismissed_pct] %>%)</span></span>
           </div>
          </div>
          </div>

          <div class="super-mega-dashboard__card">
          <h3>Ban Stats</h3>
          <div class="fraud-stats-grid">
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Banned</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--red"><%= @fraud_bans[:banned] %><span class="fraud-stats-grid__pct">(<%= @fraud_bans[:banned_pct] %>%)</span></span>
           </div>
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Shadow Banned</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--purple"><%= @fraud_bans[:shadow_banned_users] %><span class="fraud-stats-grid__pct">(<%= @fraud_bans[:shadow_banned_pct] %>%)</span></span>
           </div>
          </div>

          <div class="super-mega-dashboard__card">
            <h3>Report Status</h3>
            <div class="fraud-stats-grid">
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Pending</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--yellow"><%= @fraud_reports[:pending] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:pending_pct] %>%)</span></span>
              </div>
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Reviewed</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--green"><%= @fraud_reports[:reviewed] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:reviewed_pct] %>%)</span></span>
              </div>
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Dismissed</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--blue"><%= @fraud_reports[:dismissed] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:dismissed_pct] %>%)</span></span>
              </div>
            </div>
          </div>
          </div>

          <div class="super-mega-dashboard__card super-mega-dashboard__card--mini-graph">
          <h3>Reports Over Time (by reason)</h3>
          <% if @fraud_report_trend_data.present? %>
            <div class="fraud-timeline-graph fraud-timeline-graph--compact">
              <canvas id="reportTrendChart" height="100"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('reportTrendChart');
                if (!ctx) return;

                const data = <%= raw @fraud_report_trend_data.to_json %>;
                const sortedDates = Object.keys(data).sort();
                const labels = sortedDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                // Group by reason
                const reasonMap = {};
                sortedDates.forEach(date => {
                  Object.entries(data[date] || {}).forEach(([reason, count]) => {
                    if (!reasonMap[reason]) reasonMap[reason] = {};
                    reasonMap[reason][date] = count;
                  });
                });

                // Define colors for different reasons
                const reasonColors = {
                  'low_effort': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                  'undeclared_ai': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                  'demo_broken': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
                  'stolen_code': { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
                  'inappropriate': { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },
                  'other': { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }
                };

                // Build datasets
                const datasets = Object.entries(reasonMap).map(([reason, dates]) => {
                  const dataArray = sortedDates.map(d => dates[d] || 0);
                  const colors = reasonColors[reason] || { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' };
                  return {
                    label: reason.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    data: dataArray,
                    borderColor: colors.border,
                    backgroundColor: colors.bg,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 1,
                    borderWidth: 1.5
                  };
                });

                new Chart(ctx, {
                  type: 'line',
                  data: { labels: labels, datasets: datasets },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 8 }, padding: 4 }
                      }
                    },
                    scales: {
                      x: {
                        ticks: { font: { size: 7 }, maxRotation: 45, minRotation: 0 }
                      },
                      y: {
                        beginAtZero: true,
                        ticks: { precision: 0, font: { size: 7 } }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p class="fraud-stats-error">No data available</p>
          <% end %>
          </div>

          <div class="super-mega-dashboard__card super-mega-dashboard__card--mini-graph">
          <h3>Reports Over Time (by status)</h3>
          <% if @fraud_report_status_trend_data.present? %>
            <div class="fraud-timeline-graph fraud-timeline-graph--compact">
              <canvas id="reportStatusTrendChart" height="100"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('reportStatusTrendChart');
                if (!ctx) return;

                const data = <%= raw @fraud_report_status_trend_data.to_json %>;
                const sortedDates = Object.keys(data).sort();
                const labels = sortedDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                // Group by status
                const statusMap = {};
                sortedDates.forEach(date => {
                  Object.entries(data[date] || {}).forEach(([status, count]) => {
                    if (!statusMap[status]) statusMap[status] = {};
                    statusMap[status][date] = count;
                  });
                });

                // Define colors for different statuses
                const statusColors = {
                  'pending': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                  'reviewed': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
                  'dismissed': { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }
                };

                // Build datasets
                const datasets = Object.entries(statusMap).map(([status, dates]) => {
                  const dataArray = sortedDates.map(d => dates[d] || 0);
                  const colors = statusColors[status] || { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' };
                  return {
                    label: status.charAt(0).toUpperCase() + status.slice(1),
                    data: dataArray,
                    borderColor: colors.border,
                    backgroundColor: colors.bg,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 1,
                    borderWidth: 1.5
                  };
                });

                new Chart(ctx, {
                  type: 'line',
                  data: { labels: labels, datasets: datasets },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 8 }, padding: 4 }
                      }
                    },
                    scales: {
                      x: {
                        ticks: { font: { size: 7 }, maxRotation: 45, minRotation: 0 }
                      },
                      y: {
                        beginAtZero: true,
                        ticks: { precision: 0, font: { size: 7 } }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p class="fraud-stats-error">No data available</p>
          <% end %>
          </div>
          </div>
          </div>
          </div>

          <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--payouts">
        <h2>Payouts Overview</h2>
        <%= link_to "View Full Dashboard →", admin_payouts_dashboard_path, class: "super-mega-link" %>
      </div>

      <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3>Total Circulation</h3>
          <div class="super-mega-dashboard__stats">
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= number_with_delimiter(@payouts_cap) %></span>
              <span class="super-mega-dashboard__stat--label yellow">Cookies</span>
            </div>
          </div>
        </div>

        <div class="super-mega-dashboard__card">
          <h3>Last 24 Hours</h3>
          <div class="super-mega-dashboard__stats">
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value">+<%= number_with_delimiter(@payouts[:created]) %></span>
              <span class="super-mega-dashboard__stat--label green">Created</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value">-<%= number_with_delimiter(@payouts[:destroyed]) %></span>
              <span class="super-mega-dashboard__stat--label red">Destroyed</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= number_with_delimiter(@payouts[:txns]) %></span>
              <span class="super-mega-dashboard__stat--label blue">Transactions</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= number_with_delimiter(@payouts[:volume]) %></span>
              <span class="super-mega-dashboard__stat--label purple">Volume</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--fulfillment">
        <h2>Fulfillment Overview</h2>
        <%= link_to "View Full Dashboard →", admin_fulfillment_dashboard_index_path, class: "super-mega-link" %>
      </div>

      <div class="super-mega-dashboard__cards">
        <% [
          [:all, "All"],
          [:hq_mail, "HQ Stuff"],
          [:third_party, "Amber & Co"],
          [:warehouse, "Warehouse"],
          [:other, "Other"]
        ].each do |key, label| %>
          <div class="super-mega-dashboard__card">
            <h3><%= label %></h3>
            <div class="super-mega-dashboard__stats">
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value"><%= @fulfillment[key][:pending] %></span>
                <span class="super-mega-dashboard__stat--label red">Pending</span>
              </div>
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value"><%= @fulfillment[key][:awaiting] %></span>
                <span class="super-mega-dashboard__stat--label yellow">Awaiting</span>
              </div>
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value"><%= @fulfillment[key][:total] %></span>
                <span class="super-mega-dashboard__stat--label green">Total</span>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--ship-certs">
        <h2>Shipwrights Overview</h2>
        <%= link_to "View Full Dashboard →", "https://review.hackclub.com", class: "super-mega-link", target: "_blank" %>
      </div>

      <div class="super-mega-dashboard__cards super-mega-dashboard__cards--shipwrights">
        <div class="super-mega-dashboard__card super-mega-dashboard__card--sw-vibes">
          <div class="sw-vibes-mini__header-row">
            <button type="button" class="sw-vibes-mini__history-link" data-popup="history-popup">History</button>
            <h3>SW Vibes</h3>
          </div>
          <% if @sw_vibes && !@sw_vibes[:error] %>
            <div class="sw-vibes-mini">
              <div class="sw-vibes-mini__status">
                <span class="sw-vibes-mini__badge sw-vibes-mini__badge--clickable <%= @sw_vibes.dig(:positive, :result) ? 'sw-vibes-mini__badge--good' : 'sw-vibes-mini__badge--bad' %>"
                      data-popup="sw-vibes-graph-popup">
                  <%= @sw_vibes.dig(:positive, :result) ? 'Good' : 'Bad' %>
                </span>
              </div>

              <% if @sw_vibes[:quotes]&.any? %>
                <div class="sw-vibes-mini__section">
                  <h4 class="sw-vibes-mini__header">Quotes (<%= @sw_vibes[:quotes].size %>)</h4>
                  <ul class="sw-vibes-mini__quotes-list">
                    <% @sw_vibes[:quotes].each_with_index do |quote, idx| %>
                      <li class="sw-vibes-mini__quote-item">
                        <button type="button"
                                class="sw-vibes-mini__quote-trigger"
                                data-popup="quote-popup-<%= idx %>">
                          "<%= truncate(quote[:text], length: 150) %>"
                        </button>
                      </li>
                    <% end %>
                  </ul>
                </div>
              <% end %>

              <% if @sw_vibes[:suggestion] %>
                <div class="sw-vibes-mini__section">
                  <h4 class="sw-vibes-mini__header">Suggestion</h4>
                  <p class="sw-vibes-mini__suggestion-text" data-popup="suggestion-popup">
                    <%= truncate(@sw_vibes.dig(:suggestion, :action), length: 120) %>
                  </p>
                </div>
              <% end %>

              <p class="sw-vibes-mini__disclaimer">*AI generated, take with a grain of salt*</p>
            </div>

            <!-- Popups moved outside nested structure -->
            <% if @sw_vibes[:quotes]&.any? %>
              <% @sw_vibes[:quotes].each_with_index do |quote, idx| %>
                <div id="quote-popup-<%= idx %>" class="sw-vibes-popup" style="display: none;">
                  <div class="sw-vibes-popup__content">
                    <span class="sw-vibes-popup__close">&times;</span>
                    <h4><%= quote[:ticket_id] %></h4>
                    <blockquote>"<%= quote[:text] %>"</blockquote>
                    <div class="sw-vibes-popup__reason-block">
                      <%= quote[:reason] %>
                    </div>
                    <%= link_to "View in Slack →", quote[:link], target: "_blank", class: "sw-vibes-popup__link" %>
                  </div>
                </div>
              <% end %>
            <% end %>

            <% if @sw_vibes[:suggestion] %>
              <div id="suggestion-popup" class="sw-vibes-popup" style="display: none;">
                <div class="sw-vibes-popup__content">
                  <span class="sw-vibes-popup__close">&times;</span>
                  <h4>Suggestion</h4>
                  <p><%= @sw_vibes.dig(:suggestion, :action) %></p>
                  <p class="sw-vibes-popup__reason"><strong>Why:</strong> <%= @sw_vibes.dig(:suggestion, :reason) %></p>
                </div>
              </div>
            <% end %>

          <% else %>
            <p class="sw-vibes-mini__error"><%= @sw_vibes&.dig(:error) || "nun yet" %></p>
          <% end %>

            <div id="sw-vibes-graph-popup" class="sw-vibes-popup" style="display: none;">
              <div class="sw-vibes-popup__content sw-vibes-popup__content--wide">
                <span class="sw-vibes-popup__close">&times;</span>
                <h4>SW Vibes – 30-Day Overview</h4>
                <div class="sw-vibes-summary" id="sw-vibes-summary"></div>
                <div class="sw-vibes-graph-wrap">
                  <canvas id="swVibesHistoryChart"></canvas>
                </div>
                <div class="sw-vibes-legend">
                  <span class="sw-vibes-legend__item sw-vibes-legend__item--good">Good</span>
                  <span class="sw-vibes-legend__item sw-vibes-legend__item--bad">Bad</span>
                  <span class="sw-vibes-legend__item sw-vibes-legend__item--missing">No data</span>
                </div>
                <% if @sw_vibes && !@sw_vibes[:error] %>
                  <div class="sw-vibes-popup__today-reason">
                    <strong>Today:</strong> <%= @sw_vibes.dig(:positive, :reason) %>
                  </div>
                <% end %>
              </div>
            </div>

            <div id="history-popup" class="sw-vibes-popup" style="display: none;">
              <div class="sw-vibes-popup__content sw-vibes-popup__content--wide">
                <span class="sw-vibes-popup__close">&times;</span>
                <div id="history-popup-list" class="sw-vibes-history">
                  <h4>SW Vibes history</h4>
                  <% if @sw_vibes_history.present? %>
                    <div class="sw-vibes-history__cards">
                      <% @sw_vibes_history.each_with_index do |snapshot, idx| %>
                        <button type="button" class="sw-vibes-history__card" data-history-index="<%= idx %>">
                          <span class="sw-vibes-mini__badge <%= snapshot.result ? 'sw-vibes-mini__badge--good' : 'sw-vibes-mini__badge--bad' %>"><%= snapshot.result ? 'Good' : 'Bad' %></span>
                          <span class="sw-vibes-history__reason"><%= truncate(snapshot.reason.to_s, length: 80) %></span>
                          <span class="sw-vibes-history__date">For <%= snapshot.recorded_date.strftime('%b %-d, %Y') %></span>
                        </button>
                      <% end %>
                    </div>
                  <% else %>
                    <p class="sw-vibes-history__empty">No history yet. History is recorded when you view the dashboard.</p>
                  <% end %>
                </div>
                <div id="history-popup-detail" class="sw-vibes-history-detail" style="display: none;">
                  <button type="button" class="sw-vibes-history-detail__back">&larr; Back</button>
                  <div id="history-popup-detail-content"></div>
                </div>
              </div>
            </div>

            <script>
              window.SW_VIBES_HISTORY_DATA = <%= raw (@sw_vibes_history || []).map { |s| { date: s.recorded_date.to_s, result: s.result, reason: s.reason.to_s, payload: s.payload } }.to_json %>;
            </script>

            <script>
              document.addEventListener('DOMContentLoaded', function() {
                function escapeHtml(str) {
                  return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
                }

                function buildDetailHtml(s) {
                  var payload = s.payload || {};
                  var positive = payload.positive || {};
                  var reason = escapeHtml(positive.reason || s.reason || '');
                  var dateText = escapeHtml(s.date || '');
                  var html = '<h4>' + dateText + ' — ' + (s.result ? 'Good' : 'Bad') + '</h4><p>' + (reason || '—') + '</p>';
                  var quotes = payload.quotes || [];
                  if (quotes.length) {
                    html += '<h4>Quotes</h4><ul class="sw-vibes-popup__quotes">';
                    quotes.forEach(function(q) {
                      html += '<li><blockquote>' + escapeHtml(q.text || '') + '</blockquote><p>' + escapeHtml(q.reason || '') + '</p></li>';
                    });
                    html += '</ul>';
                  }
                  var suggestion = payload.suggestion;
                  if (suggestion) {
                    html += '<h4>Suggestion</h4><p>' + escapeHtml(suggestion.action || '') + '</p><p><strong>Why:</strong> ' + escapeHtml(suggestion.reason || '') + '</p>';
                  }
                  return html;
                }

                function showDayDetail(entry, parentPopupId) {
                  var historyPopup = document.getElementById('history-popup');
                  var graphPopup = document.getElementById('sw-vibes-graph-popup');
                  historyPopup.style.display = 'flex';
                  if (graphPopup) graphPopup.style.display = 'none';
                  document.getElementById('history-popup-detail-content').innerHTML = buildDetailHtml(entry);
                  document.getElementById('history-popup-list').style.display = 'none';
                  document.getElementById('history-popup-detail').style.display = 'block';
                  historyPopup.setAttribute('data-came-from', parentPopupId || '');
                }

                window._swVibesChartDays = [];

                document.querySelectorAll('[data-popup]').forEach(function(trigger) {
                  trigger.addEventListener('click', function() {
                    var popupId = this.getAttribute('data-popup');
                    var popup = document.getElementById(popupId);
                    if (popup) {
                      popup.style.display = 'flex';
                      if (popupId === 'sw-vibes-graph-popup') {
                        requestAnimationFrame(function() {
                          var canvas = document.getElementById('swVibesHistoryChart');
                          if (!canvas || typeof Chart === 'undefined') return;
                          var historyData = window.SW_VIBES_HISTORY_DATA || [];

                          var byDate = {};
                          historyData.forEach(function(d) { byDate[d.date] = d; });

                          var days = [];
                          for (var i = 29; i >= 0; i--) {
                            var dt = new Date();
                            dt.setDate(dt.getDate() - i);
                            var iso = dt.toISOString().slice(0, 10);
                            days.push({ date: iso, entry: byDate[iso] || null });
                          }
                          window._swVibesChartDays = days;

                          var goodCount = 0, badCount = 0, noData = 0, streak = 0, streakType = '';
                          days.forEach(function(d) {
                            if (!d.entry) { noData++; return; }
                            d.entry.result ? goodCount++ : badCount++;
                          });
                          for (var j = days.length - 1; j >= 0; j--) {
                            if (!days[j].entry) break;
                            var curr = days[j].entry.result ? 'good' : 'bad';
                            if (streak === 0) { streakType = curr; streak = 1; }
                            else if (curr === streakType) { streak++; }
                            else break;
                          }

                          var total = goodCount + badCount;
                          var pct = total > 0 ? Math.round((goodCount / total) * 100) : 0;
                          var summaryEl = document.getElementById('sw-vibes-summary');
                          summaryEl.innerHTML =
                            '<div class="sw-vibes-summary__stat sw-vibes-summary__stat--good"><span class="sw-vibes-summary__number">' + goodCount + '</span><span class="sw-vibes-summary__label">Good days</span></div>' +
                            '<div class="sw-vibes-summary__stat sw-vibes-summary__stat--bad"><span class="sw-vibes-summary__number">' + badCount + '</span><span class="sw-vibes-summary__label">Bad days</span></div>' +
                            '<div class="sw-vibes-summary__stat"><span class="sw-vibes-summary__number">' + pct + '%</span><span class="sw-vibes-summary__label">Good rate</span></div>' +
                            '<div class="sw-vibes-summary__stat"><span class="sw-vibes-summary__number">' + streak + '</span><span class="sw-vibes-summary__label">' + (streakType === 'good' ? 'Good' : 'Bad') + ' streak</span></div>';

                          var labels = days.map(function(d) {
                            var p = d.date.split('-');
                            return parseInt(p[1]) + '/' + parseInt(p[2]);
                          });
                          var barValues = days.map(function() { return 1; });
                          var bgColors = days.map(function(d) {
                            if (!d.entry) return '#e5e7eb';
                            return d.entry.result ? '#22c55e' : '#ef4444';
                          });
                          var borderColors = days.map(function(d) {
                            if (!d.entry) return '#d1d5db';
                            return d.entry.result ? '#16a34a' : '#dc2626';
                          });
                          var reasons = days.map(function(d) {
                            if (!d.entry) return 'No data recorded';
                            return (d.entry.result ? 'Good' : 'Bad') + ': ' + (d.entry.reason || '—');
                          });

                          if (window._swVibesChart) window._swVibesChart.destroy();
                          window._swVibesChart = new Chart(canvas, {
                            type: 'bar',
                            data: {
                              labels: labels,
                              datasets: [{
                                data: barValues,
                                backgroundColor: bgColors,
                                borderColor: borderColors,
                                borderWidth: 1,
                                borderRadius: 2,
                                barPercentage: 0.9,
                                categoryPercentage: 0.95
                              }]
                            },
                            options: {
                              responsive: true,
                              maintainAspectRatio: false,
                              onClick: function(evt, elements) {
                                if (!elements.length) return;
                                var idx = elements[0].index;
                                var day = window._swVibesChartDays[idx];
                                if (!day || !day.entry) return;
                                showDayDetail(day.entry, 'sw-vibes-graph-popup');
                              },
                              plugins: {
                                legend: { display: false },
                                tooltip: {
                                  callbacks: {
                                    title: function(items) { return items[0].label; },
                                    label: function(ctx) {
                                      var r = reasons[ctx.dataIndex];
                                      if (r.length > 80) return r.substring(0, 77) + '...';
                                      return r;
                                    },
                                    afterLabel: function() { return '(click for details)'; }
                                  }
                                }
                              },
                              scales: {
                                y: { display: false, min: 0, max: 1 },
                                x: {
                                  grid: { display: false },
                                  ticks: { maxRotation: 45, minRotation: 45, font: { size: 10 } }
                                }
                              }
                            }
                          });
                        });
                      }
                      if (popupId === 'history-popup') {
                        document.getElementById('history-popup-list').style.display = 'block';
                        document.getElementById('history-popup-detail').style.display = 'none';
                      }
                    }
                  });
                });

                document.querySelectorAll('.sw-vibes-history__card').forEach(function(card) {
                  card.addEventListener('click', function() {
                    var idx = parseInt(this.getAttribute('data-history-index'), 10);
                    var historyData = window.SW_VIBES_HISTORY_DATA || [];
                    var s = historyData[idx];
                    if (!s) return;
                    showDayDetail(s, 'history-popup');
                  });
                });

                document.querySelectorAll('.sw-vibes-history-detail__back').forEach(function(btn) {
                  btn.addEventListener('click', function() {
                    var popup = document.getElementById('history-popup');
                    var cameFrom = popup.getAttribute('data-came-from');
                    if (cameFrom === 'sw-vibes-graph-popup') {
                      popup.style.display = 'none';
                      var graphPopup = document.getElementById('sw-vibes-graph-popup');
                      if (graphPopup) graphPopup.style.display = 'flex';
                    } else {
                      document.getElementById('history-popup-list').style.display = 'block';
                      document.getElementById('history-popup-detail').style.display = 'none';
                    }
                    popup.removeAttribute('data-came-from');
                  });
                });

                document.querySelectorAll('.sw-vibes-popup__close').forEach(function(closeBtn) {
                  closeBtn.addEventListener('click', function() {
                    this.closest('.sw-vibes-popup').style.display = 'none';
                  });
                });

                document.querySelectorAll('.sw-vibes-popup').forEach(function(popup) {
                  popup.addEventListener('click', function(e) {
                    if (e.target === this) this.style.display = 'none';
                  });
                });
              });
            </script>
        </div>

        <div class="super-mega-dashboard__card super-mega-dashboard__card--sw-stats">
          <h3>Stats</h3>
          <% if @ship_certs && !@ship_certs[:error] %>
            <div class="sw-stats-grid">
              <div class="sw-stats-grid__section">
                <h4>Decisions</h4>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">Approved</span>
                  <span class="sw-stats-grid__value" id="sw-approved"><%= number_with_delimiter(@ship_certs[:approved]) %></span>
                </div>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">Rejected</span>
                  <span class="sw-stats-grid__value" id="sw-rejected"><%= number_with_delimiter(@ship_certs[:rejected]) %></span>
                </div>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">Pending</span>
                  <span class="sw-stats-grid__value" id="sw-pending"><%= number_with_delimiter(@ship_certs[:pending]) %></span>
                </div>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">Total</span>
                  <span class="sw-stats-grid__value sw-stats-grid__value--blue" id="sw-total"><%= number_with_delimiter(@ship_certs[:total_judged]) %></span>
                </div>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">Approval Rate</span>
                  <span class="sw-stats-grid__value sw-stats-grid__value--blue" id="sw-approval-rate"><%= @ship_certs[:approval_rate] %>%</span>
                </div>
              </div>
              <div class="sw-stats-grid__section">
                <h4>Queue</h4>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">Median Wait</span>
                  <span class="sw-stats-grid__value" id="sw-median-wait"><%= @ship_certs[:median_queue_time] %></span>
                </div>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">Oldest</span>
                  <span class="sw-stats-grid__value sw-stats-grid__value--blue" id="sw-oldest"><%= @ship_certs[:oldest_in_queue] %></span>
                </div>
              </div>
              <div class="sw-stats-grid__section">
                <h4>Today</h4>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">New Ships</span>
                  <span class="sw-stats-grid__value" id="sw-new-ships"><%= @ship_certs[:new_ships_today] %></span>
                </div>
                <div class="sw-stats-grid__row">
                  <span class="sw-stats-grid__label">Decisions</span>
                  <span class="sw-stats-grid__value sw-stats-grid__value--blue" id="sw-decisions"><%= @ship_certs[:decisions_today] %></span>
                </div>
              </div>
            </div>

            <%= render TooltipComponent.new(target_id: "sw-approved", position: :top) do %>
              <strong>Approved Ships</strong><br>
              Total number of ships that have been approved by shipwrights
            <% end %>

            <%= render TooltipComponent.new(target_id: "sw-rejected", position: :top) do %>
              <strong>Rejected Ships</strong><br>
              Total number of ships that have been rejected by shipwrights
            <% end %>

            <%= render TooltipComponent.new(target_id: "sw-pending", position: :top) do %>
              <strong>Pending Ships</strong><br>
              Number of ships currently waiting for review
            <% end %>

            <%= render TooltipComponent.new(target_id: "sw-total", position: :top) do %>
              <strong>Total Judged</strong><br>
              Total number of ships that have been reviewed (approved + rejected)
            <% end %>

            <%= render TooltipComponent.new(target_id: "sw-approval-rate", position: :top) do %>
              <strong>Approval Rate</strong><br>
              Percentage of reviewed ships that were approved
            <% end %>

            <%= render TooltipComponent.new(target_id: "sw-median-wait", position: :top) do %>
              <strong>Median Queue Time</strong><br>
              The median time ships spend waiting in the queue before being reviewed
            <% end %>

            <%= render TooltipComponent.new(target_id: "sw-oldest", position: :top) do %>
              <strong>Oldest in Queue</strong><br>
              How long the oldest pending ship has been waiting for review
            <% end %>

            <%= render TooltipComponent.new(target_id: "sw-new-ships", position: :top) do %>
              <strong>New Ships Today</strong><br>
              Number of new ships submitted today
            <% end %>

            <%= render TooltipComponent.new(target_id: "sw-decisions", position: :top) do %>
              <strong>Decisions Today</strong><br>
              Number of ships reviewed (approved or rejected) today
            <% end %>
          <% else %>
            <p>Couldn't load ship certs data</p>
          <% end %>
        </div>

        <div class="super-mega-dashboard__card super-mega-dashboard__card--sw-graph">
          <h3>Avg Queue Time (30 Days)</h3>
          <% if @ship_certs && !@ship_certs[:error] && @ship_certs[:avg_queue_time_history].present? %>
            <div class="sw-queue-graph">
              <canvas id="avgQueueTimeChart" height="200"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('avgQueueTimeChart');
                if (!ctx) return;

                const rawData = <%= raw @ship_certs[:avg_queue_time_history].to_json %>;
                const sortedDates = Object.keys(rawData).sort();
                const labels = sortedDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                const values = sortedDates.map(d => {
                  const seconds = rawData[d];
                  return Math.round(seconds / 3600 * 10) / 10;
                });

                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: labels,
                    datasets: [{
                      label: 'Avg Queue Time (hours)',
                      data: values,
                      borderColor: '#6366f1',
                      backgroundColor: 'rgba(99, 102, 241, 0.1)',
                      fill: true,
                      tension: 0.3,
                      pointRadius: 4,
                      pointBackgroundColor: '#6366f1'
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: { display: false },
                      tooltip: {
                        callbacks: {
                          label: function(context) {
                            const hours = context.raw;
                            if (hours >= 24) {
                              const days = Math.floor(hours / 24);
                              const remainingHours = Math.round(hours % 24);
                              return days + 'd ' + remainingHours + 'h';
                            }
                            return hours.toFixed(1) + 'h';
                          }
                        }
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Hours' }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p>No queue time data available</p>
          <% end %>
        </div>

        <div class="super-mega-dashboard__card super-mega-dashboard__card--sw-graph">
          <h3>Review Rates (30 Days)</h3>
          <% if @ship_certs && !@ship_certs[:error] && @ship_certs[:reviews_per_day].present? %>
            <div class="sw-queue-graph">
              <canvas id="reviewRatesChart" height="200"></canvas>
            </div>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('reviewRatesChart');
                if (!ctx) return;

                const reviewsData = <%= raw @ship_certs[:reviews_per_day].to_json %>;
                const shipsData = <%= raw @ship_certs[:ships_per_day].to_json %>;
                const sortedDates = Object.keys(reviewsData).sort();
                const labels = sortedDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });
                const reviewValues = sortedDates.map(d => reviewsData[d]);
                const shipValues = sortedDates.map(d => shipsData[d] || 0);

                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        label: 'Reviews',
                        data: reviewValues,
                        borderColor: '#6b7280',
                        backgroundColor: 'rgba(107, 114, 128, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#6b7280'
                      },
                      {
                        label: 'Ships',
                        data: shipValues,
                        borderColor: '#f59e0b',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 4,
                        pointBackgroundColor: '#f59e0b'
                      }
                    ]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'bottom'
                      }
                    },
                    scales: {
                      y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Count' }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p>No review data available</p>
          <% end %>
        </div>
      </div>
    </div>

    <% if @support %>
      <div class="super-mega-dashboard__dashboard">
        <div class="super-mega-dashboard__header super-mega-dashboard__header--support">
          <h2>Support Overview</h2>
          <%= link_to "View Vibes Page →", "/admin/support_vibes", class: "super-mega-link", target: "_blank" %>
          <%= link_to "View Full Dashboard →", "https://grafana.slevel.xyz/public-dashboards/8441a22c6a714f53a38a65892a44748f", class: "super-mega-link", target: "_blank" %>
        </div>

        <div class="super-mega-dashboard__cards">
          <%
            hang_time_color = ->(minutes) {
              return nil if minutes.nil?
              return "red" if minutes >= 720
              return "orange" if minutes >= 360
              nil
            }
          %>

          <div class="super-mega-dashboard__card">
            <h3>Avg Hang Time (24h)</h3>
            <div class="super-mega-dashboard__stats">
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value <%= hang_time_color.call(@support[:hang_24h]) %>">
                  <%= format_seconds(@support[:hang_24h] * 60) %>
                  <% if @support[:hang_24h_change] %>
                    <span class="super-mega-dashboard__stat--change <%= @support[:hang_24h_change] <= 0 ? 'green' : 'red' %>">
                      (<%= @support[:hang_24h_change] > 0 ? "+" : "" %><%= @support[:hang_24h_change] %>%)
                    </span>
                  <% end %>
                </span>
                <span class="super-mega-dashboard__stat--label">vs previous day</span>
              </div>
            </div>
          </div>

          <div class="super-mega-dashboard__card">
            <h3>Avg Hang Time (7d)</h3>
            <div class="super-mega-dashboard__stats">
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value <%= hang_time_color.call(@support[:hang_7d]) %>">
                  <%= format_seconds(@support[:hang_7d] * 60) %>
                  <% if @support[:hang_7d_change] %>
                    <span class="super-mega-dashboard__stat--change <%= @support[:hang_7d_change] <= 0 ? 'green' : 'red' %>">
                      (<%= @support[:hang_7d_change] > 0 ? "+" : "" %><%= @support[:hang_7d_change] %>%)
                    </span>
                  <% end %>
                </span>
                <span class="super-mega-dashboard__stat--label">vs previous week</span>
              </div>
            </div>
          </div>

          <div class="super-mega-dashboard__card super-mega-dashboard__card--oldest">
            <h3>Oldest Unanswered</h3>
            <div class="super-mega-dashboard__stats">
              <div class="super-mega-dashboard__stat">
                <% if @support[:oldest_unanswered_link] %>
                  <%= link_to format_seconds(@support[:oldest_unanswered] * 60, include_days: true), @support[:oldest_unanswered_link], target: "_blank", class: "super-mega-dashboard__stat--value super-mega-dashboard__stat--scary" %>
                <% else %>
                  <span class="super-mega-dashboard__stat--value super-mega-dashboard__stat--scary"><%= format_seconds(@support[:oldest_unanswered] * 60, include_days: true) %></span>
                <% end %>
                <span class="super-mega-dashboard__stat--label">Click to view ticket</span>
              </div>
            </div>
          </div>

          <div class="super-mega-dashboard__card">
            <h3>Current Concerns</h3>
            <% if @latest_support_vibes&.concerns.present? %>
              <ol class="current-concerns-list">
                <% @latest_support_vibes.concerns.each_with_index do |concern, idx| %>
                  <li>
                    <div data-controller="modal">
                      <button
                        type="button"
                        class="concern-desc-btn"
                        onclick="document.getElementById(<%= "concern-#{idx}".to_json %>).showModal()">
                        <%= concern["title"] %>
                      </button>
                      <%= render layout: "shared/modal", locals: { id: "concern-#{idx}", title: concern["title"], description: concern["description"] } do %>
                        <div class="modal__actions">
                          <button type="button" class="modal__actions-close" onclick="document.getElementById(<%= "concern-#{idx}".to_json %>).close()">X</button>
                        </div>
                      <% end %>
                    </div>
                  </li>
                <% end %>
              </ol>
            <% else %>
              <p>No concerns found.</p>
            <% end %>
          </div>

          <div class="super-mega-dashboard__card super-mega-dashboard__card--full">
            <h3>Trend Graph</h3>
            <% if @support_graph_data %>
              <div class="support-graph">
                <canvas id="supportGraphChart" height="300"></canvas>
              </div>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const ctx = document.getElementById('supportGraphChart');
                  if (!ctx) return;

                  const data = <%= raw @support_graph_data.to_json %>;
                  const labels = data.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  });

                  const unresolved = data.map(d => d.unresolved_tickets);
                  const hangTime = data.map(d => d.hang_time_p95);

                  new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: labels,
                      datasets: [
                        {
                          label: 'Unresolved Tickets',
                          data: unresolved,
                          borderColor: '#6366f1',
                          backgroundColor: 'rgba(99,102,241,0.1)',
                          fill: false,
                          tension: 0.3,
                          pointRadius: 4
                        },
                        {
                          label: 'Hang Time (min)',
                          data: hangTime,
                          borderColor: '#f59e0b',
                          backgroundColor: 'rgba(245,158,11,0.1)',
                          fill: false,
                          tension: 0.3,
                          pointRadius: 4
                        }
                      ]
                    },
                    options: {
                      responsive: true,
                      plugins: {
                        legend: { display: true, position: 'bottom' }
                      },
                      scales: {
                        y: {
                          beginAtZero: true,
                          title: { display: true, text: 'Count / Minutes' }
                        }
                      }
                    }
                  });
                });
              </script>
            <% else %>
              <p>No graph data available :(</p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--ysws-review">
        <h2>YSWS Review Overview</h2>
        <%= link_to "View Full Dashboard →", "https://review.hackclub.com/admin/ysws_reviews", class: "super-mega-link", target: "_blank" %>
      </div>

      <div class="super-mega-dashboard__cards">
        <% if @ysws_review_stats && !@ysws_review_stats[:error] %>
          <div class="super-mega-dashboard__card super-mega-dashboard__card--full">
            <h3>Reviews Per Day</h3>
            <% if @ysws_review_graph_data.present? %>
              <div class="ysws-review-graph">
                <canvas id="yswsReviewChart" height="300"></canvas>
              </div>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const ctx = document.getElementById('yswsReviewChart');
                  if (!ctx) return;

                  const data = <%= raw @ysws_review_graph_data.to_json %>;
                  const doneData = data.done;
                  const returnedData = data.returned;

                  const sortedDates = Object.keys(doneData).sort();
                  const labels = sortedDates.map(d => {
                    const date = new Date(d);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  });

                  const doneValues = sortedDates.map(d => doneData[d]);
                  const returnedValues = sortedDates.map(d => returnedData[d]);

                  new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: labels,
                      datasets: [
                        {
                          label: 'Done',
                          data: doneValues,
                          borderColor: '#10b981',
                          backgroundColor: 'rgba(16, 185, 129, 0.1)',
                          fill: true,
                          tension: 0.3,
                          pointRadius: 4,
                          pointBackgroundColor: '#10b981'
                        },
                        {
                          label: 'Returned',
                          data: returnedValues,
                          borderColor: '#f59e0b',
                          backgroundColor: 'rgba(245, 158, 11, 0.1)',
                          fill: true,
                          tension: 0.3,
                          pointRadius: 4,
                          pointBackgroundColor: '#f59e0b'
                        }
                      ]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: {
                          display: true,
                          position: 'bottom'
                        },
                        tooltip: {
                          callbacks: {
                            title: function(context) {
                              return context[0].label;
                            },
                            label: function(context) {
                              return context.dataset.label + ': ' + context.raw + ' review' + (context.raw !== 1 ? 's' : '');
                            }
                          }
                        }
                      },
                      scales: {
                        y: {
                          beginAtZero: true,
                          title: { display: true, text: 'Reviews' },
                          ticks: {
                            precision: 0
                          }
                        },
                        x: {
                          title: { display: true, text: 'Date (EST)' }
                        }
                      }
                    }
                  });
                });
              </script>
            <% else %>
              <p>No review data available</p>
            <% end %>
          </div>
        <% else %>
          <div class="super-mega-dashboard__card">
            <h3>Error</h3>
            <p>Couldn't load YSWS review data: <%= @ysws_review_stats&.dig(:error) || "Unknown error" %></p>
          </div>
        <% end %>
      </div>
    </div>

    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--voting">
        <h2>Voting Overview</h2>
        <%= link_to "View Full Dashboard →", admin_voting_dashboard_path, class: "super-mega-link" %>
      </div>

      <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3>Overview</h3>
          <div class="super-mega-dashboard__stats">
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= number_with_delimiter(@voting_overview[:total]) %></span>
              <span class="super-mega-dashboard__stat--label">Total Votes</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= @voting_overview[:today] || 0 %></span>
              <span class="super-mega-dashboard__stat--label">Today</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= @voting_overview[:this_week] || 0 %></span>
              <span class="super-mega-dashboard__stat--label">This Week</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= @voting_overview[:avg_time_seconds] ? "#{@voting_overview[:avg_time_seconds]}s" : "—" %></span>
              <span class="super-mega-dashboard__stat--label">Avg Time</span>
            </div>
          </div>
        </div>

        <div class="super-mega-dashboard__card">
          <h3>Engagement</h3>
          <div class="super-mega-dashboard__stats">
            <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value blue"><%= @voting_overview[:demo_click_rate] || 0 %>%</span>
                <span class="super-mega-dashboard__stat--label">Demo Clicks</span>
            </div>
            <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value purple"><%= @voting_overview[:repo_click_rate] || 0 %>%</span>
                <span class="super-mega-dashboard__stat--label">Repo Clicks</span>
            </div>
            <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value green"><%= @voting_overview[:reason_rate] || 0 %>%</span>
                <span class="super-mega-dashboard__stat--label">With Reason</span>
            </div>
          </div>
        </div>

        <div class="super-mega-dashboard__card">
          <h3>Category Averages</h3>
          <div class="super-mega-dashboard__stats">
            <% Vote.enabled_categories.each do |category| %>
              <% color_class = {
                originality: "red",
                technical: "yellow",
                usability: "blue",
                storytelling: "green"
              }.fetch(category.to_sym, "purple") %>
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value <%= color_class %>"><%= @voting_category_avgs[category] || "—" %></span>
                <span class="super-mega-dashboard__stat--label"><%= category.to_s.humanize %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="super-mega-dashboard__actions">
    <%= link_to "← Back to Admin", admin_root_path, class: "btn-secondary" %>
  </div>
</div>
