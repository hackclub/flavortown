<div class="super-mega-dashboard" data-controller="lazy-load">
  <%= render HeadingComponent.new(title: "Super Mega Dashboard", tone: :red, size: :full) %>

  <h2>COMICALLY LARGE TEXT THANKING ROWAN AND SHREYAS</h2>
  <h3>(prob remove before merging in prod)</h3>

  <div class="super-mega-dashboard__dashboards">
    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--fraud">
        <h2>Fraud Overview</h2>
        <%= link_to "View Full Dashboard →", admin_fraud_dashboard_path, class: "super-mega-link" %>
      </div>

      <!-- SHOP ORDERS SECTION -->
      <div class="fraud-subsection">
        <h3 class="fraud-subsection__title">Shop Orders</h3>
        <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3>Order Queue</h3>
          <div class="fraud-stats-grid">
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">Pending</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--yellow"><%= @fraud_orders[:pending] %><span class="fraud-stats-grid__pct">(<%= @fraud_orders[:pending_pct] %>%)</span></span>
            </div>
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">Awaiting</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--blue"><%= @fraud_orders[:awaiting] %><span class="fraud-stats-grid__pct">(<%= @fraud_orders[:awaiting_pct] %>%)</span></span>
            </div>
            <div class="fraud-stats-grid__row">
              <span class="fraud-stats-grid__label">Total Backlog</span>
              <span class="fraud-stats-grid__value fraud-stats-grid__value--red"><%= @fraud_orders[:backlog] %><span class="fraud-stats-grid__pct">(<%= @fraud_orders[:backlog_pct] %>%)</span></span>
            </div>
          </div>
        </div>

        </div>
      </div>

      <!-- JOE SECTION -->
      <div class="fraud-subsection">
        <h3 class="fraud-subsection__title">Joe Cases</h3>
        <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3>Case Stats</h3>
          <% if @joe_fraud_stats && !@joe_fraud_stats[:error] %>
            <% total_joe_cases = @joe_fraud_stats[:total] %>
            <% fraudpheus_pct = @joe_fraud_stats[:open] > 0 ? ((@joe_fraud_stats[:fraudpheus_open].to_f / @joe_fraud_stats[:open]) * 100).round(1) : 0 %>
            <% open_pct = (((@joe_fraud_stats[:open].to_f / total_joe_cases) * 100).round(1)) %>
            <% closed_pct = (((@joe_fraud_stats[:closed].to_f / total_joe_cases) * 100).round(1)) %>
            <div class="fraud-stats-grid">
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Second Chances Given</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--green"><%= @joe_fraud_stats[:second_chances_given] %></span>
              </div>
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Open</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--yellow"><%= @joe_fraud_stats[:open] %><span class="fraud-stats-grid__pct">(<%= open_pct %>%)</span></span>
              </div>
              <div class="fraud-stats-grid__row">
                <span class="fraud-stats-grid__label">Closed</span>
                <span class="fraud-stats-grid__value fraud-stats-grid__value--green"><%= @joe_fraud_stats[:closed] %><span class="fraud-stats-grid__pct">(<%= closed_pct %>%)</span></span>
              </div>
            </div>
          <% else %>
            <p class="fraud-stats-error"><%= @joe_fraud_stats&.dig(:error) || "No Joe data" %></p>
          <% end %>
        </div>

        <div class="super-mega-dashboard__card super-mega-dashboard__card--mini-graph">
          <h3>Bans Over Time</h3>
          <% if @fraud_ban_trend_data.present? %>
            <div class="fraud-timeline-graph fraud-timeline-graph--compact">
              <canvas id="banTrendChart" height="100"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('banTrendChart');
                if (!ctx) return;

                const data = <%= raw @fraud_ban_trend_data.to_json %>;
                const sortedDates = Object.keys(data).sort();
                const labels = sortedDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                const bansData = sortedDates.map(d => data[d].bans);
                const unbansData = sortedDates.map(d => data[d].unbans);

                new Chart(ctx, {
                  type: 'line',
                  data: {
                    labels: labels,
                    datasets: [
                      {
                        label: 'Bans',
                        data: bansData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 1,
                        borderWidth: 1.5
                      },
                      {
                        label: 'Unbans',
                        data: unbansData,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: false,
                        tension: 0.3,
                        pointRadius: 1,
                        borderWidth: 1.5
                      }
                    ]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 8 }, padding: 4 }
                      }
                    },
                    scales: {
                      x: {
                        ticks: { font: { size: 7 }, maxRotation: 45, minRotation: 0 }
                      },
                      y: {
                        beginAtZero: true,
                        ticks: { precision: 0, font: { size: 7 } }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p class="fraud-stats-error">No trend data available</p>
          <% end %>
          </div>
          </div>
          </div>

          <!-- REPORTS SECTION -->
          <div class="fraud-subsection">
          <h3 class="fraud-subsection__title">Fraud Reports</h3>
          <div class="super-mega-dashboard__cards">
          <div class="super-mega-dashboard__card">
          <h3>Report Stats</h3>
          <div class="fraud-stats-grid">
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">New Today</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--blue"><%= @fraud_reports[:new_today] %></span>
           </div>
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Pending</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--yellow"><%= @fraud_reports[:pending] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:pending_pct] %>%)</span></span>
           </div>
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Reviewed</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--red"><%= @fraud_reports[:reviewed] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:reviewed_pct] %>%)</span></span>
           </div>
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Dismissed</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--green"><%= @fraud_reports[:dismissed] %><span class="fraud-stats-grid__pct">(<%= @fraud_reports[:dismissed_pct] %>%)</span></span>
           </div>
          </div>
          </div>

          <div class="super-mega-dashboard__card">
          <h3>Ban Stats</h3>
          <div class="fraud-stats-grid">
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Banned</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--red"><%= @fraud_bans[:banned] %><span class="fraud-stats-grid__pct">(<%= @fraud_bans[:banned_pct] %>%)</span></span>
           </div>
           <div class="fraud-stats-grid__row">
             <span class="fraud-stats-grid__label">Shadow Banned</span>
             <span class="fraud-stats-grid__value fraud-stats-grid__value--purple"><%= @fraud_bans[:shadow_banned_users] %><span class="fraud-stats-grid__pct">(<%= @fraud_bans[:shadow_banned_pct] %>%)</span></span>
           </div>
          </div>

          </div>

          <div class="super-mega-dashboard__card super-mega-dashboard__card--mini-graph">
          <h3>Reports Over Time (by reason)</h3>
          <% if @fraud_report_trend_data.present? %>
            <div class="fraud-timeline-graph fraud-timeline-graph--compact">
              <canvas id="reportTrendChart" height="100"></canvas>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const ctx = document.getElementById('reportTrendChart');
                if (!ctx) return;

                const data = <%= raw @fraud_report_trend_data.to_json %>;
                const sortedDates = Object.keys(data).sort();
                const labels = sortedDates.map(d => {
                  const date = new Date(d);
                  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                });

                // Group by reason
                const reasonMap = {};
                sortedDates.forEach(date => {
                  Object.entries(data[date] || {}).forEach(([reason, count]) => {
                    if (!reasonMap[reason]) reasonMap[reason] = {};
                    reasonMap[reason][date] = count;
                  });
                });

                // Define colors for different reasons
                const reasonColors = {
                  'low_effort': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
                  'undeclared_ai': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
                  'demo_broken': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
                  'stolen_code': { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
                  'inappropriate': { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },
                  'other': { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }
                };

                // Build datasets
                const datasets = Object.entries(reasonMap).map(([reason, dates]) => {
                  const dataArray = sortedDates.map(d => dates[d] || 0);
                  const colors = reasonColors[reason] || { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' };
                  return {
                    label: reason.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                    data: dataArray,
                    borderColor: colors.border,
                    backgroundColor: colors.bg,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 1,
                    borderWidth: 1.5
                  };
                });

                new Chart(ctx, {
                  type: 'line',
                  data: { labels: labels, datasets: datasets },
                  options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                      legend: {
                        display: true,
                        position: 'bottom',
                        labels: { font: { size: 8 }, padding: 4 }
                      }
                    },
                    scales: {
                      x: {
                        ticks: { font: { size: 7 }, maxRotation: 45, minRotation: 0 }
                      },
                      y: {
                        beginAtZero: true,
                        ticks: { precision: 0, font: { size: 7 } }
                      }
                    }
                  }
                });
              });
            </script>
          <% else %>
            <p class="fraud-stats-error">No data available</p>
          <% end %>
          </div>

          </div>
          </div>
          </div>

          <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--payouts">
        <h2>Payouts Overview</h2>
        <%= link_to "View Full Dashboard →", admin_payouts_dashboard_path, class: "super-mega-link" %>
      </div>

      <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3>Total Circulation</h3>
          <div class="super-mega-dashboard__stats">
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= number_with_delimiter(@payouts_cap) %></span>
              <span class="super-mega-dashboard__stat--label yellow">Cookies</span>
            </div>
          </div>
        </div>

        <div class="super-mega-dashboard__card">
          <h3>Last 24 Hours</h3>
          <div class="super-mega-dashboard__stats">
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value">+<%= number_with_delimiter(@payouts[:created]) %></span>
              <span class="super-mega-dashboard__stat--label green">Created</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value">-<%= number_with_delimiter(@payouts[:destroyed]) %></span>
              <span class="super-mega-dashboard__stat--label red">Destroyed</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= number_with_delimiter(@payouts[:txns]) %></span>
              <span class="super-mega-dashboard__stat--label blue">Transactions</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= number_with_delimiter(@payouts[:volume]) %></span>
              <span class="super-mega-dashboard__stat--label purple">Volume</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--fulfillment">
        <h2>Fulfillment Overview</h2>
        <%= link_to "View Full Dashboard →", admin_fulfillment_dashboard_index_path, class: "super-mega-link" %>
      </div>

      <div class="super-mega-dashboard__cards">
        <% [
          [:all, "All"],
          [:hq_mail, "HQ Stuff"],
          [:third_party, "Amber & Co"],
          [:warehouse, "Warehouse"],
          [:other, "Other"]
        ].each do |key, label| %>
          <div class="super-mega-dashboard__card">
            <h3><%= label %></h3>
            <div class="super-mega-dashboard__stats">
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value"><%= @fulfillment[key][:pending] %></span>
                <span class="super-mega-dashboard__stat--label red">Pending</span>
              </div>
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value"><%= @fulfillment[key][:awaiting] %></span>
                <span class="super-mega-dashboard__stat--label yellow">Awaiting</span>
              </div>
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value"><%= @fulfillment[key][:total] %></span>
                <span class="super-mega-dashboard__stat--label green">Total</span>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div data-lazy-section="shipwrights" class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--ship-certs">
        <div class="super-mega-dashboard__placeholder-text super-mega-dashboard__placeholder-text--title"></div>
      </div>
      <div class="super-mega-dashboard__cards super-mega-dashboard__cards--shipwrights">
        <div class="super-mega-dashboard__card super-mega-dashboard__card--sw-vibes super-mega-dashboard__placeholder-card">
          <div class="smd-skeleton__line smd-skeleton__line--heading"></div>
          <div class="smd-skeleton__badge"></div>
          <div class="smd-skeleton__line smd-skeleton__line--short"></div>
          <div class="smd-skeleton__line"></div>
          <div class="smd-skeleton__line smd-skeleton__line--medium"></div>
        </div>
        <div class="super-mega-dashboard__card super-mega-dashboard__card--sw-stats super-mega-dashboard__placeholder-card">
          <div class="smd-skeleton__line smd-skeleton__line--heading"></div>
          <div class="smd-skeleton__line"></div>
          <div class="smd-skeleton__line smd-skeleton__line--short"></div>
          <div class="smd-skeleton__line"></div>
          <div class="smd-skeleton__line smd-skeleton__line--medium"></div>
          <div class="smd-skeleton__line smd-skeleton__line--short"></div>
        </div>
        <div class="super-mega-dashboard__card super-mega-dashboard__card--sw-graph super-mega-dashboard__placeholder-card">
          <div class="smd-skeleton__line smd-skeleton__line--heading"></div>
          <div class="smd-skeleton__chart"></div>
        </div>
        <div class="super-mega-dashboard__card super-mega-dashboard__card--sw-graph super-mega-dashboard__placeholder-card">
          <div class="smd-skeleton__line smd-skeleton__line--heading"></div>
          <div class="smd-skeleton__chart"></div>
        </div>
      </div>
    </div>

    <% if @support %>
      <div class="super-mega-dashboard__dashboard">
        <div class="super-mega-dashboard__header super-mega-dashboard__header--support">
          <h2>Support Overview</h2>
          <%= link_to "View Vibes Page →", "/admin/support_vibes", class: "super-mega-link", target: "_blank" %>
          <%= link_to "View Full Dashboard →", "https://grafana.slevel.xyz/public-dashboards/8441a22c6a714f53a38a65892a44748f", class: "super-mega-link", target: "_blank" %>
        </div>

        <div class="super-mega-dashboard__cards">
          <%
            hang_time_color = ->(minutes) {
              return nil if minutes.nil?
              return "red" if minutes >= 720
              return "orange" if minutes >= 360
              nil
            }
          %>

          <div class="super-mega-dashboard__card">
            <h3>Avg Hang Time (24h)</h3>
            <div class="super-mega-dashboard__stats">
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value <%= hang_time_color.call(@support[:hang_24h]) %>">
                  <%= format_seconds(@support[:hang_24h] * 60) %>
                  <% if @support[:hang_24h_change] %>
                    <span class="super-mega-dashboard__stat--change <%= @support[:hang_24h_change] <= 0 ? 'green' : 'red' %>">
                      (<%= @support[:hang_24h_change] > 0 ? "+" : "" %><%= @support[:hang_24h_change] %>%)
                    </span>
                  <% end %>
                </span>
                <span class="super-mega-dashboard__stat--label">vs previous day</span>
              </div>
            </div>
          </div>

          <div class="super-mega-dashboard__card">
            <h3>Avg Hang Time (7d)</h3>
            <div class="super-mega-dashboard__stats">
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value <%= hang_time_color.call(@support[:hang_7d]) %>">
                  <%= format_seconds(@support[:hang_7d] * 60) %>
                  <% if @support[:hang_7d_change] %>
                    <span class="super-mega-dashboard__stat--change <%= @support[:hang_7d_change] <= 0 ? 'green' : 'red' %>">
                      (<%= @support[:hang_7d_change] > 0 ? "+" : "" %><%= @support[:hang_7d_change] %>%)
                    </span>
                  <% end %>
                </span>
                <span class="super-mega-dashboard__stat--label">vs previous week</span>
              </div>
            </div>
          </div>

          <div class="super-mega-dashboard__card super-mega-dashboard__card--oldest">
            <h3>Oldest Unanswered</h3>
            <div class="super-mega-dashboard__stats">
              <div class="super-mega-dashboard__stat">
                <% if @support[:oldest_unanswered_link] %>
                  <%= link_to format_seconds(@support[:oldest_unanswered] * 60, include_days: true), @support[:oldest_unanswered_link], target: "_blank", class: "super-mega-dashboard__stat--value super-mega-dashboard__stat--scary" %>
                <% else %>
                  <span class="super-mega-dashboard__stat--value super-mega-dashboard__stat--scary"><%= format_seconds(@support[:oldest_unanswered] * 60, include_days: true) %></span>
                <% end %>
                <span class="super-mega-dashboard__stat--label">Click to view ticket</span>
              </div>
            </div>
          </div>

          <div class="super-mega-dashboard__card">
            <h3>Current Concerns</h3>
            <% if @latest_support_vibes&.concerns.present? %>
              <ol class="current-concerns-list">
                <% @latest_support_vibes.concerns.each_with_index do |concern, idx| %>
                  <li>
                    <div data-controller="modal">
                      <button
                        type="button"
                        class="concern-desc-btn"
                        onclick="document.getElementById(<%= "concern-#{idx}".to_json %>).showModal()">
                        <%= concern["title"] %>
                      </button>
                      <%= render layout: "shared/modal", locals: { id: "concern-#{idx}", title: concern["title"], description: concern["description"] } do %>
                        <div class="modal__actions">
                          <button type="button" class="modal__actions-close" onclick="document.getElementById(<%= "concern-#{idx}".to_json %>).close()">X</button>
                        </div>
                      <% end %>
                    </div>
                  </li>
                <% end %>
              </ol>
            <% else %>
              <p>No concerns found.</p>
            <% end %>
          </div>

          <div class="super-mega-dashboard__card super-mega-dashboard__card--full">
            <h3>Unresolved Tickets v/s Hang Time</h3>
            <% if @support_graph_data %>
              <div class="support-graph">
                <canvas id="supportGraphChart" height="300"></canvas>
              </div>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const ctx = document.getElementById('supportGraphChart');
                  if (!ctx) return;

                  const data = <%= raw @support_graph_data.to_json %>;
                  const labels = data.map(d => {
                    const date = new Date(d.date);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  });

                  const unresolved = data.map(d => d.unresolved_tickets);
                  const hangTime = data.map(d => d.hang_time_p95);

                  new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: labels,
                      datasets: [
                        {
                          label: 'Unresolved Tickets',
                          data: unresolved,
                          borderColor: '#f1802d',
                          backgroundColor: 'rgba(241, 128, 45, 0.1)',
                          fill: false,
                          tension: 0.3,
                          pointRadius: 4
                        },
                        {
                          label: 'Hang Time (min)',
                          data: hangTime,
                          borderColor: '#6366f1',
                          backgroundColor: 'rgba(99,102,241,0.1)',
                          fill: false,
                          tension: 0.3,
                          pointRadius: 4
                        }
                      ]
                    },
                    options: {
                      responsive: true,
                      plugins: {
                        legend: { display: true, position: 'bottom' }
                      },
                      scales: {
                        y: {
                          beginAtZero: true,
                          title: { display: true, text: 'Count / Minutes' }
                        }
                      }
                    }
                  });
                });
              </script>
            <% else %>
              <p>No graph data available :(</p>
            <% end %>
          </div>
        </div>
      </div>
    <% end %>

    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--ysws-review">
        <h2>YSWS Review Overview</h2>
        <%= link_to "View Full Dashboard →", "https://review.hackclub.com/admin/ysws_reviews", class: "super-mega-link", target: "_blank" %>
      </div>

      <div class="super-mega-dashboard__cards">
        <% if @ysws_review_stats && !@ysws_review_stats[:error] %>
          <div class="super-mega-dashboard__card super-mega-dashboard__card--two-thirds">
            <h3>Reviews Per Day</h3>
            <% if @ysws_review_graph_data.present? %>
              <div class="ysws-review-graph">
                <canvas id="yswsReviewChart" height="300"></canvas>
              </div>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const ctx = document.getElementById('yswsReviewChart');
                  if (!ctx) return;

                  const data = <%= raw @ysws_review_graph_data.to_json %>;
                  const doneData = data.done;
                  const returnedData = data.returned;

                  const sortedDates = Object.keys(doneData).sort();
                  const labels = sortedDates.map(d => {
                    const date = new Date(d);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                  });

                  const doneValues = sortedDates.map(d => doneData[d]);
                  const returnedValues = sortedDates.map(d => returnedData[d]);

                  new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: labels,
                      datasets: [
                        {
                          label: 'Done',
                          data: doneValues,
                          borderColor: '#10b981',
                          backgroundColor: 'rgba(16, 185, 129, 0.1)',
                          fill: true,
                          tension: 0.3,
                          pointRadius: 4,
                          pointBackgroundColor: '#10b981'
                        },
                        {
                          label: 'Returned',
                          data: returnedValues,
                          borderColor: '#f59e0b',
                          backgroundColor: 'rgba(245, 158, 11, 0.1)',
                          fill: true,
                          tension: 0.3,
                          pointRadius: 4,
                          pointBackgroundColor: '#f59e0b'
                        }
                      ]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: {
                          display: true,
                          position: 'bottom'
                        },
                        tooltip: {
                          callbacks: {
                            title: function(context) {
                              return context[0].label;
                            },
                            label: function(context) {
                              return context.dataset.label + ': ' + context.raw + ' review' + (context.raw !== 1 ? 's' : '');
                            }
                          }
                        }
                      },
                      scales: {
                        y: {
                          beginAtZero: true,
                          title: { display: true, text: 'Reviews' },
                          ticks: {
                            precision: 0
                          }
                        },
                        x: {
                          title: { display: true, text: 'Date (EST)' }
                        }
                      }
                    }
                  });
                });
              </script>
            <% else %>
              <p>No review data available</p>
            <% end %>
          </div>

          <% if @ysws_review_ecdf_data.present? %>
            <div class="super-mega-dashboard__card super-mega-dashboard__card--two-thirds">
              <h3>Devlogs Distribution (ECDF)</h3>
              <div class="ysws-review-ecdf-graph">
                <canvas id="yswsReviewEcdfChart" height="300"></canvas>
              </div>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const ctx = document.getElementById('yswsReviewEcdfChart');
                  if (!ctx) return;

                  const ecdfData = <%= raw @ysws_review_ecdf_data.to_json %>;

                  // Get all unique devlog values from both datasets
                  const doneData = ecdfData.done || [];
                  const allData = ecdfData.all || [];

                  const allDevlogs = [...new Set([
                    ...doneData.map(d => d.devlogs),
                    ...allData.map(d => d.devlogs)
                  ])].sort((a, b) => a - b);

                  // Create lookup maps for easier access
                  const doneMap = new Map(doneData.map(d => [d.devlogs, d.cumulative_percent]));
                  const allMap = new Map(allData.map(d => [d.devlogs, d.cumulative_percent]));

                  // Fill in values for all devlog counts
                  const doneValues = [];
                  const allValues = [];
                  let lastDoneValue = 0;
                  let lastAllValue = 0;

                  allDevlogs.forEach(devlogs => {
                    if (doneMap.has(devlogs)) {
                      lastDoneValue = doneMap.get(devlogs);
                    }
                    if (allMap.has(devlogs)) {
                      lastAllValue = allMap.get(devlogs);
                    }
                    doneValues.push({ x: devlogs, y: lastDoneValue });
                    allValues.push({ x: devlogs, y: lastAllValue });
                  });

                  new Chart(ctx, {
                    type: 'line',
                    data: {
                      datasets: [
                        {
                          label: 'Done Reviews',
                          data: doneValues,
                          borderColor: '#ef4444',
                          backgroundColor: 'rgba(239, 68, 68, 0.1)',
                          fill: false,
                          tension: 0.4,
                          pointRadius: 3,
                          pointBackgroundColor: '#ef4444',
                          borderWidth: 2
                        },
                        {
                          label: 'All Reviews',
                          data: allValues,
                          borderColor: '#10b981',
                          backgroundColor: 'rgba(16, 185, 129, 0.1)',
                          fill: false,
                          tension: 0.4,
                          pointRadius: 3,
                          pointBackgroundColor: '#10b981',
                          borderWidth: 2
                        }
                      ]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: {
                          display: true,
                          position: 'bottom'
                        },
                        tooltip: {
                          callbacks: {
                            title: function(context) {
                              const devlogs = context[0].parsed.x;
                              return devlogs + ' devlog' + (devlogs !== 1 ? 's' : '');
                            },
                            label: function(context) {
                              return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '% of reviews';
                            }
                          }
                        }
                      },
                      scales: {
                        y: {
                          beginAtZero: true,
                          max: 100,
                          title: { display: true, text: 'Cumulative Percentage (%)' },
                          ticks: {
                            callback: function(value) {
                              return value + '%';
                            }
                          }
                        },
                        x: {
                          type: 'linear',
                          title: { display: true, text: 'Number of Devlogs' },
                          ticks: {
                            precision: 0,
                            stepSize: 1
                          }
                        }
                      }
                    }
                  });
                });
              </script>
            </div>
          <% end %>

          <div class="super-mega-dashboard__card super-mega-dashboard__card--full">
            <h3>Devlogs Reviewed per Day (Trend)</h3>
            <% if @ysws_reviewer_trend_data.present? %>
              <div class="ysws-reviewer-trend-graph">
                <canvas id="yswsReviewerTrendChart" height="300"></canvas>
              </div>
              <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
              <script>
                document.addEventListener('DOMContentLoaded', function() {
                  const ctx = document.getElementById('yswsReviewerTrendChart');
                  if (!ctx) return;

                  const trendData = <%= raw @ysws_reviewer_trend_data.to_json %>;

                  // Color palette for different reviewers
                  const colors = [
                    '#ef4444', // red
                    '#3b82f6', // blue
                    '#10b981', // green
                    '#f59e0b', // orange
                    '#8b5cf6', // purple
                    '#ec4899', // pink
                    '#14b8a6', // teal
                    '#f97316'  // orange-600
                  ];

                  // Build datasets for each reviewer
                  const datasets = [];
                  let colorIndex = 0;

                  // Add total line first (thicker)
                  const totalData = trendData.dates.map(date => trendData.totals[date] || 0);
                  datasets.push({
                    label: 'Total',
                    data: totalData,
                    borderColor: '#000000',
                    backgroundColor: 'rgba(0, 0, 0, 0.1)',
                    fill: false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: '#000000',
                    borderWidth: 3,
                    borderDash: []
                  });

                  // Add each reviewer's line
                  Object.entries(trendData.reviewers).forEach(([reviewerId, reviewerInfo]) => {
                    const color = colors[colorIndex % colors.length];
                    const data = trendData.dates.map(date => reviewerInfo.counts[date] || 0);

                    datasets.push({
                      label: reviewerInfo.username,
                      data: data,
                      borderColor: color,
                      backgroundColor: color.replace(')', ', 0.1)').replace('rgb', 'rgba'),
                      fill: false,
                      tension: 0.3,
                      pointRadius: 3,
                      pointBackgroundColor: color,
                      borderWidth: 2
                    });

                    colorIndex++;
                  });

                  new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: trendData.dates,
                      datasets: datasets
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      plugins: {
                        legend: {
                          display: true,
                          position: 'bottom',
                          labels: {
                            boxWidth: 12,
                            padding: 8,
                            font: { size: 11 }
                          }
                        },
                        tooltip: {
                          callbacks: {
                            title: function(context) {
                              return context[0].label;
                            },
                            label: function(context) {
                              const count = context.parsed.y;
                              return context.dataset.label + ': ' + count + ' devlog' + (count !== 1 ? 's' : '');
                            }
                          }
                        }
                      },
                      scales: {
                        y: {
                          beginAtZero: true,
                          title: { display: true, text: 'Devlogs Reviewed' },
                          ticks: {
                            precision: 0,
                            stepSize: 1
                          }
                        },
                        x: {
                          title: { display: true, text: 'Date' },
                          ticks: {
                            maxRotation: 45,
                            minRotation: 45,
                            font: { size: 10 }
                          }
                        }
                      }
                    }
                  });
                });
              </script>
            <% else %>
              <p>Reviewer trend data not available. Data: <%= @ysws_reviewer_trend_data.inspect %></p>
            <% end %>
          </div>
        <% else %>
          <div class="super-mega-dashboard__card">
            <h3>Error</h3>
            <p>Couldn't load YSWS review data: <%= @ysws_review_stats&.dig(:error) || "Unknown error" %></p>
          </div>
        <% end %>
      </div>
    </div>

    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--voting">
        <h2>Voting Overview</h2>
        <%= link_to "View Full Dashboard →", admin_voting_dashboard_path, class: "super-mega-link" %>
      </div>

      <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3>Overview</h3>
          <div class="super-mega-dashboard__stats">
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= number_with_delimiter(@voting_overview[:total]) %></span>
              <span class="super-mega-dashboard__stat--label">Total Votes</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= @voting_overview[:today] || 0 %></span>
              <span class="super-mega-dashboard__stat--label">Today</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= @voting_overview[:this_week] || 0 %></span>
              <span class="super-mega-dashboard__stat--label">This Week</span>
            </div>
            <div class="super-mega-dashboard__stat">
              <span class="super-mega-dashboard__stat--value"><%= @voting_overview[:avg_time_seconds] ? "#{@voting_overview[:avg_time_seconds]}s" : "—" %></span>
              <span class="super-mega-dashboard__stat--label">Avg Time</span>
            </div>
          </div>
        </div>

        <div class="super-mega-dashboard__card">
          <h3>Engagement</h3>
          <div class="super-mega-dashboard__stats">
            <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value blue"><%= @voting_overview[:demo_click_rate] || 0 %>%</span>
                <span class="super-mega-dashboard__stat--label">Demo Clicks</span>
            </div>
            <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value purple"><%= @voting_overview[:repo_click_rate] || 0 %>%</span>
                <span class="super-mega-dashboard__stat--label">Repo Clicks</span>
            </div>
            <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value green"><%= @voting_overview[:reason_rate] || 0 %>%</span>
                <span class="super-mega-dashboard__stat--label">With Reason</span>
            </div>
          </div>
        </div>

        <div class="super-mega-dashboard__card">
          <h3>Category Averages</h3>
          <div class="super-mega-dashboard__stats">
            <% Vote.enabled_categories.each do |category| %>
              <% color_class = {
                originality: "red",
                technical: "yellow",
                usability: "blue",
                storytelling: "green"
              }.fetch(category.to_sym, "purple") %>
              <div class="super-mega-dashboard__stat">
                <span class="super-mega-dashboard__stat--value <%= color_class %>"><%= @voting_category_avgs[category] || "—" %></span>
                <span class="super-mega-dashboard__stat--label"><%= category.to_s.humanize %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="super-mega-dashboard__dashboard">
      <div class="super-mega-dashboard__header super-mega-dashboard__header--community">
        <h2>Community Engagement</h2>
        <%= link_to "View Special Activities →", admin_special_activities_path, class: "super-mega-link" %>
      </div>
      <div class="super-mega-dashboard__cards">
        <div class="super-mega-dashboard__card">
          <h3 align="center">Show & Tell Attendance</h3>
          <div id="show-and-tell-attendance-graph" style="height: 220px;">
            <canvas id="showAndTellAttendanceChart" height="180"></canvas>
          </div>
          <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const ctx = document.getElementById('showAndTellAttendanceChart');
              if (!ctx) return;
              const data = <%= raw @show_and_tell_stats[:attendance_by_date].to_json %>;
              const dates = Object.keys(data).sort();
              const counts = dates.map(d => data[d]);
              new Chart(ctx, {
                type: 'line',
                data: {
                  labels: dates.map(d => {
                    const date = new Date(d);
                    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });
                  }),
                  datasets: [{
                    label: 'Attendance',
                    data: counts,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    borderWidth: 2
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: false,
                  plugins: {
                    legend: { display: false }
                  },
                  scales: {
                    y: { beginAtZero: true }
                  }
                }
              });
            });
          </script>
        </div>
        <% if @show_and_tell_stats[:last_winner] %>
          <div class="super-mega-dashboard__card" style="text-align: center; display: flex; flex-direction: column; justify-content: center; gap: 0.2em;">
            <h3>Last Winner:</h3>
            <% winner = @show_and_tell_stats[:last_winner] %>
            <%= link_to winner.project.title, project_path(winner.project), class: "show-and-tell-winner-link" %>
            <span>by <%= link_to winner.user.display_name, admin_user_path(winner.user), style: "color: #1e40af; text-decoration: none; font-size: 1.5rem" %></span>
            (<%= winner.date %>)
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <div class="super-mega-dashboard__actions">
    <%= link_to "← Back to Admin", admin_root_path, class: "btn-secondary" %>
  </div>
</div>
