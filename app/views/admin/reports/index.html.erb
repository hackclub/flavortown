<h1>Project Reports</h1>

<div class="card" style="margin-bottom: 2rem;">
  <h2>Stats</h2>
  <div style="display: flex; gap: 2rem; align-items: center;">
    <div>
      <strong>Pending:</strong> <%= @counts[:pending] %>
    </div>
    <div>
      <strong>Reviewed:</strong> <%= @counts[:reviewed] %>
    </div>
    <div>
      <strong>Dismissed:</strong> <%= @counts[:dismissed] %>
    </div>
    <div style="margin-left: auto;">
      <%= button_to "Process Demo Broken", process_demo_broken_admin_reports_path, method: :post, class: "btn-primary", data: { confirm: "This will auto-review projects with 5+ pending demo_broken reports and re-certify them. Continue?" } %>
    </div>
  </div>
</div>

<div class="card" style="margin-bottom: 2rem;">
  <h2>Filters</h2>

  <%= form_with url: admin_reports_path, method: :get, local: true do |f| %>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
      <div>
        <%= f.label :status, "Status" %>
        <%= f.select :status, options_for_select([["Pending", "pending"], ["Reviewed", "reviewed"], ["Dismissed", "dismissed"]], params[:status]), { include_blank: "All" }, class: "form-control" %>
      </div>

      <div>
        <%= f.label :reason, "Reason" %>
        <%= f.select :reason, options_for_select(Project::Report::REASONS.map { |r| [r.titleize, r] }, params[:reason]), { include_blank: "All" }, class: "form-control" %>
      </div>
    </div>

    <div>
      <%= f.submit "Filter", class: "btn-primary" %>
      <%= link_to "Clear Filters", admin_reports_path, class: "btn-secondary" %>
    </div>
  <% end %>
</div>

<div class="card">
  <table class="reports-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Project</th>
        <th>Reporter</th>
        <th>Reason</th>
        <th>Status</th>
        <th>Actioned By</th>
        <th>Created</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <% @reports.each do |report| %>
        <tr>
          <td>#<%= report.id %></td>
          <td>
            <% if report.project %>
              <%= link_to report.project.title, project_path(report.project) %>
            <% else %>
              <span class="text-muted">(Deleted Project)</span>
            <% end %>
          </td>
          <td>
            <div class="user-cell">
              <%= image_tag report.reporter.avatar, class: "avatar-sm", alt: report.reporter.display_name %>
              <span><%= report.reporter.display_name || report.reporter.email %></span>
            </div>
          </td>
          <td><%= report.reason.titleize %></td>
          <td>
            <span class="badge badge-<%= report.status %>">
              <%= report.status %>
            </span>
          </td>
          <td>
            <% reviewer_info = @reviewers_by_report[report.id] %>
            <% if reviewer_info.is_a?(User) %>
              <div class="user-cell">
                <%= image_tag reviewer_info.avatar, class: "avatar-sm", alt: reviewer_info.display_name %>
                <span><%= reviewer_info.display_name %></span>
              </div>
            <% elsif reviewer_info == :auto %>
              <span class="badge" style="background: #8b5cf6; color: white;">ðŸ¤– Auto</span>
            <% else %>
              <span class="text-muted">â€”</span>
            <% end %>
          </td>
          <td><%= report.created_at.strftime("%Y-%m-%d %H:%M") %></td>
          <td>
            <div class="actions-cell">
              <%= link_to "View", admin_report_path(report), class: "btn-primary slim" %>
              <% if report.pending? %>
                <%= button_to "Review", review_admin_report_path(report), method: :post, class: "btn-secondary slim" %>
                <%= button_to "Dismiss", dismiss_admin_report_path(report), method: :post, class: "btn-secondary slim" %>
              <% end %>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>

  <% if @reports.empty? %>
    <p style="text-align: center; padding: 2rem;">No reports found.</p>
  <% end %>
</div>

<div style="margin-top: 2em;">
  <%= link_to "â† Back", admin_root_path, class: "btn-secondary" %>
</div>

<style>
.reports-table {
  width: 100%;
  border-collapse: collapse;
}

.reports-table th,
.reports-table td {
  padding: 0.75rem 1rem;
  text-align: left;
  vertical-align: middle;
}

.reports-table th {
  font-weight: 600;
  white-space: nowrap;
}

.reports-table tbody tr:hover {
  background-color: rgba(0, 0, 0, 0.02);
}

.user-cell {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.avatar-sm {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.actions-cell {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.text-muted {
  color: #9ca3af;
}

.badge {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.875rem;
  font-weight: 500;
  text-transform: capitalize;
  display: inline-block;
}

.badge-pending {
  background-color: #fbbf24;
  color: #78350f;
}

.badge-reviewed {
  background-color: #10b981;
  color: white;
}

.badge-dismissed {
  background-color: #6b7280;
  color: white;
}

.form-control {
  width: 100%;
  padding: 0.5em;
  border-radius: 6px;
  border: 1px solid #d1d5db;
  background: white;
}
</style>
