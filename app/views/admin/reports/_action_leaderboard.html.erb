<%
  # Get report action stats from PaperTrail versions
  time_range = local_assigns[:time_range] || '7_days'
  limit = local_assigns[:limit]&.to_i || 10

  # Build query based on time range
  versions_query = PaperTrail::Version
    .where(item_type: "Project::Report")
    .where.not(whodunnit: nil)
    .where("object_changes ? 'status'")

  if time_range == '7_days'
    versions_query = versions_query.where("created_at >= ?", 7.days.ago)
  end

  recent_versions = versions_query

  # Group by user and count actions by type
  action_counts = recent_versions.each_with_object(Hash.new { |h, k| h[k] = { reviewed: 0, dismissed: 0, total: 0 } }) do |version, counts|
    user_id = version.whodunnit.to_i
    next if user_id.zero?

    changes = version.object_changes || {}

    status_change = changes["status"]
    next unless status_change.is_a?(Array) && status_change.length == 2

    new_status = status_change[1]
    case new_status
    when "reviewed"
      counts[user_id][:reviewed] += 1
    when "dismissed"
      counts[user_id][:dismissed] += 1
    end
    counts[user_id][:total] += 1
  end

  # Sort by total and take top users based on limit (nil means show all)
  sorted_users = action_counts.sort_by { |_, v| -v[:total] }
  top_users = limit.nil? ? sorted_users : sorted_users.first(limit)
  user_ids = top_users.map(&:first)
  users_by_id = User.where(id: user_ids).index_by(&:id)

  limit_options = [10, nil]
%>

<div class="card action-leaderboard">
  <div class="action-leaderboard__header">
    <h3>
      üïµÔ∏è Fraud Team Leaderboard
      <small style="color: #666; font-weight: normal;">(<%= time_range == '7_days' ? '7 days' : 'all time' %>)</small>
    </h3>
    <div class="action-leaderboard__toggle">
      <%= link_to "7 days", admin_reports_path(time_range: '7_days', limit: limit),
          class: "btn-#{time_range == '7_days' ? 'primary' : 'secondary'} slim" %>
      <%= link_to "All time", admin_reports_path(time_range: 'all_time', limit: limit),
          class: "btn-#{time_range == 'all_time' ? 'primary' : 'secondary'} slim" %>
    </div>
    <div class="action-leaderboard__limit-toggle">
      <%= link_to "Top 10", admin_reports_path(time_range: time_range, limit: 10),
          class: "btn-#{limit == 10 ? 'primary' : 'secondary'} slim" %>
      <%= link_to "All", admin_reports_path(time_range: time_range, limit: nil),
          class: "btn-#{limit.nil? ? 'primary' : 'secondary'} slim" %>
    </div>
  </div>

  <% if top_users.any? %>
    <table class="leaderboard-table">
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th title="Reviewed">‚úì</th>
          <th title="Dismissed">‚úó</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <% top_users.each_with_index do |(user_id, stats), index| %>
          <% user = users_by_id[user_id] %>
          <tr class="<%= 'highlight' if index < 3 %>">
            <td class="rank">
              <% if index == 0 %>ü•á
              <% elsif index == 1 %>ü•à
              <% elsif index == 2 %>ü•â
              <% else %><%= index + 1 %>
              <% end %>
            </td>
            <td class="user-name">
              <% if user %>
                <%= link_to user.display_name || user.email, admin_user_path(user) %>
              <% else %>
                <span class="text-muted">User #<%= user_id %></span>
              <% end %>
            </td>
            <td class="stat stat-reviewed"><%= stats[:reviewed] %></td>
            <td class="stat stat-dismissed"><%= stats[:dismissed] %></td>
            <td class="stat stat-total"><%= stats[:total] %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-muted">No report actions <%= time_range == '7_days' ? 'in the last 7 days' : 'recorded' %>.</p>
  <% end %>
</div>

<style>
  .action-leaderboard {
    max-width: 350px;
  }

  .action-leaderboard h3 {
    margin-top: 0;
    margin-bottom: 1em;
  }

  .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
  }

  .leaderboard-table th,
  .leaderboard-table td {
    padding: 0.4em 0.5em;
    text-align: center;
  }

  .leaderboard-table th {
    font-weight: 600;
    border-bottom: 2px solid #e5e7eb;
    font-size: 0.85em;
  }

  .leaderboard-table td.rank {
    font-weight: bold;
  }

  .leaderboard-table td.user-name {
    text-align: left;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .leaderboard-table tr.highlight {
    background: #fef3c7;
  }

  .leaderboard-table tr:hover {
    background: #f3f4f6;
  }

  .leaderboard-table .stat {
    font-family: monospace;
    font-weight: 500;
  }

  .leaderboard-table .stat-reviewed { color: #10b981; }
  .leaderboard-table .stat-dismissed { color: #6b7280; }
  .leaderboard-table .stat-total { font-weight: bold; color: #1f2937; }

  .text-muted {
    color: #6b7280;
  }

  .action-leaderboard__header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1em;
    gap: 1em;
  }

  .action-leaderboard__header h3 {
    margin: 0;
    flex: 1;
  }

  .action-leaderboard__toggle {
    display: flex;
    gap: 0.5em;
    flex-shrink: 0;
  }

  .action-leaderboard__toggle .btn-primary,
  .action-leaderboard__toggle .btn-secondary {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
  }

  .action-leaderboard__limit-toggle {
    display: flex;
    gap: 0.5em;
    margin-top: 0.5em;
  }

  .action-leaderboard__limit-toggle .btn-primary,
  .action-leaderboard__limit-toggle .btn-secondary {
    font-size: 0.7rem;
    padding: 0.2rem 0.4rem;
  }
</style>
