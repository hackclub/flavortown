<h1>Audit Logs</h1>

<div class="card" style="margin-bottom: 2rem;">
  <h2>Filters</h2>
  
  <%= form_with url: admin_audit_logs_path, method: :get, local: true do |f| %>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
      <div>
        <%= f.label :item_type, "Model Type" %>
        <%= f.select :item_type, options_for_select(@item_types, params[:item_type]), { include_blank: "All" }, class: "form-control" %>
      </div>
      
      <div>
        <%= f.label :event, "Action" %>
        <%= f.select :event, options_for_select(['create', 'update', 'destroy'], params[:event]), { include_blank: "All" }, class: "form-control" %>
      </div>
      
      <div>
        <%= f.label :whodunnit, "User" %>
        <%= f.select :whodunnit, options_from_collection_for_select(@users, :id, :display_name, params[:whodunnit]), { include_blank: "All" }, class: "form-control" %>
      </div>
      
      <div>
        <%= f.label :start_date, "Start Date" %>
        <%= f.date_field :start_date, value: params[:start_date], class: "form-control" %>
      </div>
      
      <div>
        <%= f.label :end_date, "End Date" %>
        <%= f.date_field :end_date, value: params[:end_date], class: "form-control" %>
      </div>
    </div>
    
    <div>
      <%= f.submit "Filter", class: "btn-primary" %>
      <%= link_to "Clear Filters", admin_audit_logs_path, class: "btn-secondary" %>
    </div>
  <% end %>
</div>

<div class="card">
  <table>
    <thead>
      <tr>
        <th>Timestamp</th>
        <th>User</th>
        <th>Action</th>
        <th>Model</th>
        <th>Record ID</th>
        <th>Changes</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <% @versions.each do |version| %>
        <tr>
          <td><%= version.created_at.strftime("%Y-%m-%d %H:%M:%S") %></td>
          <td>
            <% if version.whodunnit.present? %>
              <% user = User.find_by(id: version.whodunnit) %>
              <%= user&.display_name || "User ##{version.whodunnit}" %>
            <% else %>
              <em>System</em>
            <% end %>
          </td>
          <td>
            <span class="badge badge-<%= version.event %>">
              <%= version.event %>
            </span>
          </td>
          <td><%= version.item_type %></td>
          <td>#<%= version.item_id %></td>
          <td>
            <% if version.object_changes.present? %>
              <% changes = YAML.load(version.object_changes) rescue {} %>
              <%= changes.keys.take(3).join(", ") %>
              <% if changes.keys.count > 3 %>
                <em>(+<%= changes.keys.count - 3 %> more)</em>
              <% end %>
            <% else %>
              <em>N/A</em>
            <% end %>
          </td>
          <td>
            <%= link_to "Details", admin_audit_log_path(version), class: "btn-primary slim" %>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
  
</div>

<style>
.badge {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.875rem;
  font-weight: 500;
}

.badge-create {
  background-color: #10b981;
  color: white;
}

.badge-update {
  background-color: #3b82f6;
  color: white;
}

.badge-destroy {
  background-color: #ef4444;
  color: white;
}
</style>
