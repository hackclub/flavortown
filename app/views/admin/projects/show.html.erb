<h1>Project #<%= @project.id %></h1>

<% if @project.deleted? %>
  <div class="alert alert-warning" style="margin-bottom: 1rem; padding: 1rem; background: #dc2626; color: #fff; border-radius: 8px;">
    <strong>‚ö†Ô∏è This project has been deleted</strong>
    <span style="margin-left: 0.5rem;">Deleted at: <%= @project.deleted_at.strftime("%Y-%m-%d %H:%M") %></span>
  </div>
<% end %>

<% if @project.shadow_banned? %>
  <div class="alert" style="margin-bottom: 1rem; padding: 1rem; background: #f59e0b; color: #000; border-radius: 8px;">
    <strong>üëª This project is shadow banned</strong>
    <span style="margin-left: 0.5rem;">Since: <%= @project.shadow_banned_at&.strftime("%Y-%m-%d %H:%M") %></span>
    <% if @project.shadow_banned_reason.present? %>
      <div style="margin-top: 0.5rem; font-size: 0.875rem;">
        <strong>Reason:</strong> <%= @project.shadow_banned_reason %>
      </div>
    <% end %>
  </div>
<% end %>

<div class="flex" style="gap: 1rem; flex-wrap: wrap;">
  <div class="card">
    <h2>Details</h2>
    <div class="info-rows">
      <div><b>Title:</b> <%= @project.title %></div>
      <div><b>Description:</b> <%= @project.description.presence || "None" %></div>
      <div><b>Ship Status:</b> <%= @project.ship_status.titleize %></div>
      <div><b>Type:</b> <%= @project.project_type.presence || "Not set" %></div>
      <div><b>Categories:</b> <%= @project.project_categories.any? ? @project.project_categories.join(", ") : "None" %></div>
      <div><b>Created:</b> <%= @project.created_at.strftime("%Y-%m-%d %H:%M") %></div>
      <div><b>Updated:</b> <%= @project.updated_at.strftime("%Y-%m-%d %H:%M") %></div>
      <div><b>Shipped:</b> <%= @project.shipped_at&.strftime("%Y-%m-%d %H:%M") || "Not shipped" %></div>
      <div><b>Status:</b> <%= @project.deleted? ? "Deleted" : "Active" %></div>
      <div><b>Tutorial:</b> <%= @project.tutorial? ? "Yes" : "No" %></div>
      <div><b>Duration:</b> <%= @project.duration_seconds > 0 ? "#{(@project.duration_seconds / 3600.0).round(1)}h" : "0h" %></div>
      <div><b>Devlogs:</b> <%= @project.devlogs_count %></div>
      <div><b>AI Declaration:</b> <%= @project.ai_declaration.presence || "None" %></div>
      <% if @project.repo_url.present? %>
        <% if (safe_repo_url = safe_external_url(@project.repo_url)) %>
          <div><b>Repo:</b> <%= link_to @project.repo_url, safe_repo_url, target: "_blank", rel: "noopener noreferrer" %></div>
        <% else %>
          <div><b>Repo:</b> <%= @project.repo_url %> <span class="text-warning">(invalid URL)</span></div>
        <% end %>
      <% end %>
      <% if @project.demo_url.present? %>
        <% if (safe_demo_url = safe_external_url(@project.demo_url)) %>
          <div><b>Demo:</b> <%= link_to @project.demo_url, safe_demo_url, target: "_blank", rel: "noopener noreferrer" %></div>
        <% else %>
          <div><b>Demo:</b> <%= @project.demo_url %> <span class="text-warning">(invalid URL)</span></div>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="card">
    <h2>Members</h2>
    <% if @project.users.any? %>
      <ul style="margin: 0; padding-left: 1.25rem;">
        <% @project.users.each do |u| %>
          <li><%= link_to u.display_name, admin_user_path(u) %></li>
        <% end %>
      </ul>
    <% else %>
      <p>No members.</p>
    <% end %>
  </div>

  <div class="card">
    <h2>Hackatime Keys</h2>
    <% if @project.hackatime_projects.any? %>
      <ul style="margin: 0; padding-left: 1.25rem;">
        <% @project.hackatime_projects.each do |hp| %>
          <li>
            <code><%= hp.name %></code>
            <small style="color: #6b7280;">(<%= link_to hp.user.display_name, admin_user_path(hp.user) %>)</small>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p>No hackatime keys linked.</p>
    <% end %>
  </div>
</div>

<div style="margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
  <%= link_to "‚Üê Back", admin_projects_path, class: "btn-secondary" %>
  <%= link_to "View Public Page", project_path(@project), class: "btn-secondary", target: "_blank" %>
  <%= link_to "View Votes", votes_admin_project_path(@project), class: "btn-secondary slim" %>
  <% if @project.deleted? %>
    <%= button_to "Restore Project", restore_admin_project_path(@project),
      method: :post,
      class: "btn-primary",
      data: { confirm: "Are you sure you want to restore this project?" } %>
  <% else %>
    <%= button_to "Delete Project", delete_admin_project_path(@project),
      method: :post,
      class: "btn-danger slim",
      data: { confirm: "Are you sure you want to delete this project?" } %>
  <% end %>

  <% if policy(:admin).shadow_ban_projects? %>
    <% if @project.shadow_banned? %>
      <%= button_to "üëÅÔ∏è Remove Shadow Ban", unshadow_ban_admin_project_path(@project),
        method: :post,
        class: "btn-primary",
        data: { confirm: "Remove shadow ban from this project?" } %>
    <% else %>
      <button type="button" onclick="document.getElementById('shadow-ban-project-modal').showModal()" class="btn-secondary">
        üëª Shadow Ban
      </button>
      <%= render layout: "shared/modal", locals: { id: "shadow-ban-project-modal", title: "Shadow Ban Project", description: "This project will be hidden from other users but visible to its members. A notification will be sent via Slack DM to all project members." } do %>
        <form action="<%= shadow_ban_admin_project_path(@project) %>" method="post">
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>

          <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
            <p style="margin: 0 0 8px 0; font-weight: bold; color: #856404;">‚ö†Ô∏è DM will be sent to all project members:</p>
            <div style="background: white; border-radius: 4px; padding: 10px; font-size: 12px; line-height: 1.6; color: #333; font-family: monospace;">
              <p style="margin: 0 0 8px 0;">Hey! After review, your project "<%= @project.title %>" has been flagged by moderation.</p>
              <p style="margin: 0 0 8px 0;">Reason: <span id="shadow-ban-reason-preview"></span></p>
              <p style="margin: 0 0 8px 0;">Your project will not be able to ship again until this flag is removed.</p>
              <p style="margin: 0 0 8px 0;">We've issued a minimum payout for your work on this ship.</p>
              <p style="margin: 0;">If you'd like to appeal this decision, please DM @Fraud Squad with any additional context.</p>
            </div>
          </div>

          <div class="modal__field">
            <%= label_tag :reason, "Shadow Ban Reason (optional)" %>
            <%= text_area_tag :reason, "", placeholder: "Enter reason for shadow ban...", id: "shadow-ban-reason-input" %>
          </div>
          <div class="modal__actions">
            <button type="submit" class="btn-secondary">Confirm Shadow Ban</button>
            <button type="button" onclick="document.getElementById('shadow-ban-project-modal').close()" class="btn-secondary">Cancel</button>
          </div>
        </form>

        <script>
          const reasonInput = document.getElementById('shadow-ban-reason-input');
          const reasonPreview = document.getElementById('shadow-ban-reason-preview');

          reasonInput.addEventListener('input', function() {
            reasonPreview.textContent = this.value || '[reason you provide]';
          });

          reasonInput.addEventListener('focus', function() {
            if (!this.value) {
              reasonPreview.textContent = '[reason you provide]';
            }
          });
        </script>
      <% end %>
    <% end %>
  <% end %>
</div>
