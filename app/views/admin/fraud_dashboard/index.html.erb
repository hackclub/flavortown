<% content_for :title, "Fraud Dashboard" %>
<h1>Fraud Dashboard</h1>

<% r, b, o = @reports, @bans, @orders %>

<div class="fraud-grid">
  <div class="card fraud-card">
    <h2>Report Intake</h2>
    <div class="fraud-stats">
      <div class="fraud-stat">
        <span class="fraud-stat__value"><%= r[:new_today] %></span>
        <span class="fraud-stat__label">New Today</span>
      </div>
      <div class="fraud-stat fraud-stat--warning">
        <span class="fraud-stat__value"><%= r[:pending] %></span>
        <span class="fraud-stat__label">Pending</span>
      </div>
      <div class="fraud-stat fraud-stat--success">
        <span class="fraud-stat__value"><%= r[:reviewed] %></span>
        <span class="fraud-stat__label">Reviewed</span>
      </div>
      <div class="fraud-stat">
        <span class="fraud-stat__value"><%= r[:dismissed] %></span>
        <span class="fraud-stat__label">Dismissed</span>
      </div>
    </div>
    <% if r[:avg_response_hours] %>
      <p class="fraud-note">Avg response time (30d): <strong><%= r[:avg_response_hours] %>h</strong></p>
    <% end %>
    <%= link_to "View Reports →", admin_reports_path, class: "btn-primary slim" %>
  </div>

  <div class="card fraud-card">
    <h2>Report Reasons</h2>
    <table class="fraud-table">
      <thead><tr><th>Reason</th><th>Count</th></tr></thead>
      <tbody>
        <% r[:reasons].sort_by { |_, c| -c }.each do |reason, count| %>
          <tr>
            <td><%= reason.titleize %></td>
            <td><strong><%= count %></strong></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="card fraud-card">
    <h2>Report Reviewers (All-Time)</h2>
    <%= render "leaderboard", reviewers: r[:top_reviewers], medals: (1..10).map { |i| "##{i}" } %>
  </div>
</div>

<div class="fraud-grid">
  <div class="card fraud-card">
    <h2>Cooked Fraudsters</h2>
    <div class="fraud-stats">
      <div class="fraud-stat fraud-stat--danger">
        <span class="fraud-stat__value"><%= b[:banned] %></span>
        <span class="fraud-stat__label">Total Banned</span>
      </div>
      <div class="fraud-stat fraud-stat--purple">
        <span class="fraud-stat__value"><%= b[:shadow_banned_users] %></span>
        <span class="fraud-stat__label">Shadow Banned Users</span>
      </div>
      <div class="fraud-stat fraud-stat--purple">
        <span class="fraud-stat__value"><%= b[:shadow_banned_projects] %></span>
        <span class="fraud-stat__label">Shadow Banned Projects</span>
      </div>
    </div>
    <h3>Today's Activity</h3>
    <table class="fraud-table">
      <tbody>
        <tr><td>Bans</td><td class="fraud-danger"><strong><%= b[:bans_today] %></strong></td></tr>
        <tr><td>Unbans</td><td class="fraud-success"><strong><%= b[:unbans_today] %></strong></td></tr>
        <tr><td>User Shadow Bans</td><td><strong><%= b[:shadow_bans_today] %></strong></td></tr>
        <tr><td>User Unshadow Bans</td><td><strong><%= b[:unshadow_bans_today] %></strong></td></tr>
        <tr><td>Project Shadow Bans</td><td><strong><%= b[:project_shadow_today] %></strong></td></tr>
        <tr><td>Project Unshadow Bans</td><td><strong><%= b[:project_unshadow_today] %></strong></td></tr>
      </tbody>
    </table>
  </div>

  <div class="card fraud-card fraud-card--wide">
    <h2>Shop Order Review</h2>
    <div class="fraud-stats">
      <div class="fraud-stat fraud-stat--warning">
        <span class="fraud-stat__value"><%= o[:pending] %></span>
        <span class="fraud-stat__label">Pending</span>
      </div>
      <div class="fraud-stat">
        <span class="fraud-stat__value"><%= o[:on_hold] %></span>
        <span class="fraud-stat__label">On Hold</span>
      </div>
      <div class="fraud-stat fraud-stat--info">
        <span class="fraud-stat__value"><%= o[:awaiting] %></span>
        <span class="fraud-stat__label">Awaiting Fulfillment</span>
      </div>
      <div class="fraud-stat fraud-stat--danger">
        <span class="fraud-stat__value"><%= o[:rejected] %></span>
        <span class="fraud-stat__label">Rejected</span>
      </div>
      <div class="fraud-stat fraud-stat--warning">
        <span class="fraud-stat__value"><%= o[:backlog] %></span>
        <span class="fraud-stat__label">Total Backlog</span>
      </div>
      <div class="fraud-stat">
        <span class="fraud-stat__value"><%= o[:new_today] %></span>
        <span class="fraud-stat__label">New Today</span>
      </div>
    </div>
    <% if o[:avg_response_hours] %>
      <p class="fraud-note">Avg response time (30d): <strong><%= o[:avg_response_hours] %>h</strong></p>
    <% end %>
    <%= link_to "View Orders →", admin_shop_orders_path, class: "btn-primary slim" %>
  </div>
</div>

<div class="fraud-grid">
   <div class="card fraud-card">
     <h2>Order Reviewers (All-Time)</h2>
     <%= render "leaderboard", reviewers: o[:top_reviewers], medals: (1..10).map { |i| "##{i}" } %>
   </div>
 </div>

 <div class="fraud-grid">
   <div class="card fraud-card fraud-card--wide">
     <h2>Case Status Timeline (Joe)</h2>
     <% if @joe_fraud_stats && @joe_fraud_stats[:timeline]&.any? && !@joe_fraud_stats[:error] %>
       <div class="fraud-timeline-graph" style="height: 300px;">
         <canvas id="fraudTimelineChartDash"></canvas>
       </div>
       <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
       <script>
         document.addEventListener('DOMContentLoaded', function() {
           const ctx = document.getElementById('fraudTimelineChartDash');
           if (!ctx) return;

           const timeline = <%= raw @joe_fraud_stats[:timeline].to_json %>;
           
           // Group by status
           const statusMap = {};
           timeline.forEach(entry => {
             if (!statusMap[entry.status]) {
               statusMap[entry.status] = {};
             }
             statusMap[entry.status][entry.date] = entry.count;
           });

           // Get all unique dates
           const allDates = [...new Set(timeline.map(e => e.date))].sort();
           const labels = allDates.map(d => {
             const date = new Date(d);
             return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
           });

           // Define colors for different statuses
           const statusColors = {
             'second_chance_given': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
             'banned': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
             'fraudpheus_open': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
             'other': { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }
           };

           // Build datasets
           const datasets = Object.entries(statusMap).map(([status, dates]) => {
             const data = allDates.map(d => dates[d] || 0);
             const colors = statusColors[status] || { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' };
             return {
               label: status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
               data: data,
               borderColor: colors.border,
               backgroundColor: colors.bg,
               fill: false,
               tension: 0.3,
               pointRadius: 3,
               borderWidth: 2
             };
           });

           new Chart(ctx, {
             type: 'line',
             data: { labels: labels, datasets: datasets },
             options: {
               responsive: true,
               maintainAspectRatio: false,
               plugins: {
                 legend: {
                   display: true,
                   position: 'bottom',
                   labels: { padding: 12 }
                 }
               },
               scales: {
                 y: {
                   beginAtZero: true,
                   ticks: { precision: 0 }
                 }
               }
             }
           });
         });
       </script>
     <% else %>
       <p class="fraud-note">No timeline data available</p>
     <% end %>
   </div>
   </div>

   <div class="fraud-grid">
    <div class="card fraud-card fraud-card--wide">
      <h2>Shop Orders Over Time</h2>
      <% if @fraud_shop_order_trend_data.present? %>
        <div class="fraud-timeline-graph" style="height: 300px;">
          <canvas id="shopOrderTrendChart"></canvas>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('shopOrderTrendChart');
            if (!ctx) return;

            const data = <%= raw @fraud_shop_order_trend_data.to_json %>;
            const sortedDates = Object.keys(data).sort();
            const labels = sortedDates.map(d => {
              const date = new Date(d);
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            // Group by state
            const stateMap = {};
            sortedDates.forEach(date => {
              Object.entries(data[date] || {}).forEach(([state, count]) => {
                if (!stateMap[state]) stateMap[state] = {};
                stateMap[state][date] = count;
              });
            });

            // Define colors for different states
            const stateColors = {
              'pending': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
              'awaiting_periodical_fulfillment': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
              'fulfilled': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
              'rejected': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
              'on_hold': { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' }
            };

            // Build datasets
            const datasets = Object.entries(stateMap).map(([state, dates]) => {
              const dataArray = sortedDates.map(d => dates[d] || 0);
              const colors = stateColors[state] || { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' };
              return {
                label: state.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                data: dataArray,
                borderColor: colors.border,
                backgroundColor: colors.bg,
                fill: false,
                tension: 0.3,
                pointRadius: 1,
                borderWidth: 1.5
              };
            });

            new Chart(ctx, {
              type: 'line',
              data: { labels: labels, datasets: datasets },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: { padding: 12 }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                  }
                }
              }
            });
          });
        </script>
      <% else %>
        <p class="fraud-note">No data available</p>
      <% end %>
    </div>
   </div>

   <div class="fraud-grid">
    <div class="card fraud-card fraud-card--wide">
      <h2>Reports Over Time (by reason)</h2>
      <% if @fraud_report_trend_data.present? %>
        <div class="fraud-timeline-graph" style="height: 300px;">
          <canvas id="reportReasonTrendChart"></canvas>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('reportReasonTrendChart');
            if (!ctx) return;

            const data = <%= raw @fraud_report_trend_data.to_json %>;
            const sortedDates = Object.keys(data).sort();
            const labels = sortedDates.map(d => {
              const date = new Date(d);
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            // Group by reason
            const reasonMap = {};
            sortedDates.forEach(date => {
              Object.entries(data[date] || {}).forEach(([reason, count]) => {
                if (!reasonMap[reason]) reasonMap[reason] = {};
                reasonMap[reason][date] = count;
              });
            });

            // Define colors for different reasons
            const reasonColors = {
              'low_effort': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
              'undeclared_ai': { border: '#ef4444', bg: 'rgba(239, 68, 68, 0.1)' },
              'demo_broken': { border: '#3b82f6', bg: 'rgba(59, 130, 246, 0.1)' },
              'stolen_code': { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' },
              'inappropriate': { border: '#ec4899', bg: 'rgba(236, 72, 153, 0.1)' },
              'other': { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }
            };

            // Build datasets
            const datasets = Object.entries(reasonMap).map(([reason, dates]) => {
              const dataArray = sortedDates.map(d => dates[d] || 0);
              const colors = reasonColors[reason] || { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' };
              return {
                label: reason.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                data: dataArray,
                borderColor: colors.border,
                backgroundColor: colors.bg,
                fill: false,
                tension: 0.3,
                pointRadius: 1,
                borderWidth: 1.5
              };
            });

            new Chart(ctx, {
              type: 'line',
              data: { labels: labels, datasets: datasets },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: { padding: 12 }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                  }
                }
              }
            });
          });
        </script>
      <% else %>
        <p class="fraud-note">No data available</p>
      <% end %>
    </div>
   </div>

   <div class="fraud-grid">
    <div class="card fraud-card fraud-card--wide">
      <h2>Reports Over Time (by status)</h2>
      <% if @fraud_report_status_trend_data.present? %>
        <div class="fraud-timeline-graph" style="height: 300px;">
          <canvas id="reportStatusTrendChart"></canvas>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            const ctx = document.getElementById('reportStatusTrendChart');
            if (!ctx) return;

            const data = <%= raw @fraud_report_status_trend_data.to_json %>;
            const sortedDates = Object.keys(data).sort();
            const labels = sortedDates.map(d => {
              const date = new Date(d);
              return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            // Group by status
            const statusMap = {};
            sortedDates.forEach(date => {
              Object.entries(data[date] || {}).forEach(([status, count]) => {
                if (!statusMap[status]) statusMap[status] = {};
                statusMap[status][date] = count;
              });
            });

            // Define colors for different statuses
            const statusColors = {
              'pending': { border: '#f59e0b', bg: 'rgba(245, 158, 11, 0.1)' },
              'reviewed': { border: '#10b981', bg: 'rgba(16, 185, 129, 0.1)' },
              'dismissed': { border: '#6366f1', bg: 'rgba(99, 102, 241, 0.1)' }
            };

            // Build datasets
            const datasets = Object.entries(statusMap).map(([status, dates]) => {
              const dataArray = sortedDates.map(d => dates[d] || 0);
              const colors = statusColors[status] || { border: '#8b5cf6', bg: 'rgba(139, 92, 246, 0.1)' };
              return {
                label: status.charAt(0).toUpperCase() + status.slice(1),
                data: dataArray,
                borderColor: colors.border,
                backgroundColor: colors.bg,
                fill: false,
                tension: 0.3,
                pointRadius: 1,
                borderWidth: 1.5
              };
            });

            new Chart(ctx, {
              type: 'line',
              data: { labels: labels, datasets: datasets },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: true,
                    position: 'bottom',
                    labels: { padding: 12 }
                  }
                },
                scales: {
                  y: {
                    beginAtZero: true,
                    ticks: { precision: 0 }
                  }
                }
              }
            });
          });
        </script>
      <% else %>
        <p class="fraud-note">No data available</p>
      <% end %>
    </div>
   </div>

   <%= link_to "← Back", admin_root_path, class: "btn-secondary" %>

<style>
.fraud-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.fraud-card { display: flex; flex-direction: column; gap: 0.75rem; }
.fraud-card--wide { grid-column: span 2; }
@media (max-width: 800px) { .fraud-card--wide { grid-column: span 1; } }
.fraud-card h2 { margin: 0 0 0.25rem; font-size: 1rem; }
.fraud-card h3 { margin: 0.5rem 0 0.25rem; font-size: 0.875rem; color: var(--color-brown-600); }
.fraud-stats { display: flex; flex-wrap: wrap; gap: 1rem; }
.fraud-stat { display: flex; flex-direction: column; align-items: center; min-width: 80px; padding: 0.5rem; }
.fraud-stat__value { font-size: 1.5rem; font-weight: 700; line-height: 1; }
.fraud-stat__label { font-size: 0.7rem; color: var(--color-text-muted); text-align: center; }
.fraud-stat--warning .fraud-stat__value { color: #f59e0b; }
.fraud-stat--success .fraud-stat__value { color: #10b981; }
.fraud-stat--danger .fraud-stat__value { color: #ef4444; }
.fraud-stat--info .fraud-stat__value { color: #3b82f6; }
.fraud-stat--purple .fraud-stat__value { color: #8b5cf6; }
.fraud-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
.fraud-table th, .fraud-table td { padding: 0.375rem 0.5rem; text-align: left; border-bottom: 1px solid var(--color-tan-400); }
.fraud-table th { font-weight: 600 }
.fraud-table td:last-child { text-align: right; }
.fraud-note { margin: 0; font-size: 0.8rem; color: var(--color-text-muted); }
.fraud-danger { color: #ef4444; }
.fraud-success { color: #10b981; }
.fraud-leaderboard { list-style: none; margin: 0; padding: 0; }
.fraud-leaderboard li { display: flex; justify-content: space-between; padding: 0.25rem 0; font-size: 0.875rem; }
.fraud-leaderboard li span:first-child { font-weight: 500; }

</style>
