<h1 style="font-size: 1.5rem; margin-bottom: 1rem;">Order #<%= @order.id %></h1>

<div class="card" style="padding: 1rem; margin-bottom: 1rem;">
  <div style="display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: center;">
    <div>
      <span style="font-size: 0.75rem; color: #6b7280; display: block;">Status</span>
      <span class="badge badge-<%= @order.aasm_state %>" style="font-size: 0.75rem; padding: 0.2rem 0.4rem;">
        <%= @order.aasm_state.humanize %>
      </span>
    </div>

    <div>
      <span style="font-size: 0.75rem; color: #6b7280; display: block;">Created</span>
      <span style="font-size: 0.875rem;"><%= @order.created_at.strftime("%m/%d %l:%M%p") %></span>
    </div>

    <div>
      <span style="font-size: 0.75rem; color: #6b7280; display: block;">User</span>
      <%= link_to @order.user.display_name || "Unknown", admin_user_path(@order.user), style: "font-size: 0.875rem; color: #3b82f6;" %>
    </div>

    <div>
      <span style="font-size: 0.75rem; color: #6b7280; display: block;">Item</span>
      <span style="font-size: 0.875rem;"><%= truncate(@order.shop_item.name, length: 25) %></span>
    </div>

    <div>
      <span style="font-size: 0.75rem; color: #6b7280; display: block;">Qty / Cost</span>
      <span style="font-size: 0.875rem;">
        <%= @order.quantity %> √ó <%= @order.frozen_item_price %> tickets
        <strong style="color: #15803d;">(<%= @order.total_cost %> total)</strong>
      </span>
    </div>
  </div>
</div>

<div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
  <div class="card" style="flex: 1; padding: 1rem;">
    <h2 style="color: #a855f7; font-size: 1rem; margin-bottom: 0.75rem;">Shop Orders Summary</h2>
    <div style="font-size: 0.875rem; line-height: 1.6;">
      <div><strong>Total Orders:</strong> <%= @user_order_stats[:total] %></div>
      <div><strong>Fulfilled:</strong> <%= @user_order_stats[:fulfilled] %></div>
      <div><strong>Pending:</strong> <%= @user_order_stats[:pending] %></div>
      <div><strong>Rejected:</strong> <%= @user_order_stats[:rejected] %></div>
      <div><strong>Total Quantity:</strong> <%= @user_order_stats[:total_quantity] %></div>
      <div><strong>On Hold:</strong> <%= @user_order_stats[:on_hold] %></div>
      <div><strong>Awaiting Fulfillment:</strong> <%= @user_order_stats[:awaiting_fulfillment] %></div>
    </div>
    <% if @user_orders.present? %>
      <details style="margin-top: 0.75rem; cursor: pointer;">
        <summary style="font-size: 0.8rem; color: #6b7280;">‚ñ∏ View All Orders (<%= @user_order_stats[:total] %>)</summary>
        <div style="padding-top: 0.5rem; font-size: 0.75rem;">
          <% @order.user.shop_orders.order(created_at: :desc).each do |order| %>
            <div style="padding: 0.25rem 0; border-bottom: 1px solid #374151;">
              <%= link_to "##{order.id}", admin_shop_order_path(order), style: "color: #3b82f6;" %>
              - <%= truncate(order.shop_item.name, length: 15) %>
              <span class="badge badge-<%= order.aasm_state %>" style="font-size: 0.6rem; padding: 0.1rem 0.25rem;"><%= order.aasm_state.humanize %></span>
            </div>
          <% end %>
        </div>
      </details>
    <% end %>
  </div>

  <div class="card" style="flex: 1; padding: 1rem;">
    <h2 style="color: #a855f7; font-size: 1rem; margin-bottom: 0.75rem;">shop item</h2>
    <% item = @order.shop_item %>
    <%= link_to item.name, "#", style: "color: #60a5fa; font-size: 0.95rem; text-decoration: underline;" %>
    <div style="font-size: 0.875rem; line-height: 1.6; margin-top: 0.5rem;">
      <div><strong>Description:</strong> <%= item.description %></div>
      <div><strong>Internal description:</strong> <%= item.internal_description %></div>
      <div><strong>USD cost:</strong> $<%= number_with_precision(item.usd_cost, precision: 2) %></div>
      <div><strong>Ticket cost:</strong> <%= item.ticket_cost %></div>
      <div><strong>Type:</strong> <%= item.type %></div>
    </div>
    <% if item.image.attached? %>
      <div style="margin-top: 0.75rem;">
        <%= image_tag item.image.variant(:carousel_sm), style: "max-width: 120px; border-radius: 4px;" %>
      </div>
    <% end %>
  </div>
</div>

<% if @order.parent_order.present? %>
<div class="card" style="padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #f59e0b;">
  <h2 style="color: #f59e0b; font-size: 1rem; margin-bottom: 0.5rem;">üîó This is an Accessory Order</h2>
  <div style="font-size: 0.875rem;">
    <p style="margin: 0;">This accessory was ordered with:</p>
    <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.5rem; padding: 0.5rem; background: #fffbeb; border-radius: 4px;">
      <% if @order.parent_order.shop_item.image.attached? %>
        <%= image_tag @order.parent_order.shop_item.image.variant(:carousel_sm), style: "width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" %>
      <% end %>
      <div>
        <strong><%= @order.parent_order.shop_item.name %></strong>
        <br>
        <%= link_to "View Parent Order ##{@order.parent_order.id}", admin_shop_order_path(@order.parent_order), style: "color: #3b82f6; font-size: 0.8rem;" %>
      </div>
    </div>
  </div>
</div>
<% end %>

<% if @order.accessory_orders.any? %>
<div class="card" style="padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #10b981;">
  <h2 style="color: #10b981; font-size: 1rem; margin-bottom: 0.75rem;">üéÅ Accessories Ordered</h2>
  <div style="display: flex; flex-direction: column; gap: 0.5rem;">
    <% @order.accessory_orders.includes(shop_item: { image_attachment: :blob }).each do |acc_order| %>
      <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; background: #f0fdf4; border-radius: 4px;">
        <% if acc_order.shop_item.image.attached? %>
          <%= image_tag acc_order.shop_item.image.variant(:carousel_sm), style: "width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" %>
        <% end %>
        <div style="flex: 1;">
          <strong><%= acc_order.shop_item.name %></strong>
          <br>
          <small style="color: #6b7280;">üç™ <%= acc_order.frozen_item_price || acc_order.shop_item.ticket_cost %></small>
        </div>
        <div>
          <span class="badge badge-<%= acc_order.aasm_state %>" style="font-size: 0.7rem;">
            <%= acc_order.aasm_state.humanize %>
          </span>
        </div>
        <div>
          <%= link_to "View", admin_shop_order_path(acc_order), class: "btn-primary slim", style: "font-size: 0.75rem; padding: 0.2rem 0.5rem;" %>
        </div>
      </div>
    <% end %>
  </div>
</div>
<% end %>

<% if @can_view_address %>
<div class="card">
  <h2>Shipping Address</h2>
  <% if @can_view_address %>
    <div id="address-container">

      <turbo-frame id="address-content"> <div style="padding: 1em; background: #f3f4f6; border-radius: 4px; text-align: center;">
        <p style="margin: 0 0 1em 0; color: #374151;">
          üîí Address is encrypted. Click below to decrypt and view.
        </p>
        <%= button_to "Reveal Address", reveal_address_admin_shop_order_path(@order),
            method: :post,
            class: "btn-primary",
            data: {
              turbo_frame: "address-content",
              turbo_method: "post"
            } %>
      </div></turbo-frame>
    </div>
  <% else %>
    <div style="padding: 1em; background: #fee2e2; border-radius: 4px;">
      <p style="color: #991b1b; margin: 0;">
        üîí You do not have permission to view this address. Only admins and fulfillment persons in the order's region can access this information.
      </p>
    </div>
  <% end %>
</div>
<% end %>

<div class="card">
  <h2>Fulfillment Information</h2>
  <div class="info-rows">
    <% if current_user.admin? %>
      <div style="margin-bottom: 1rem;">
        <b>Assigned To:</b>
        <% if @order.assigned_to_user.present? %>
          <div style="display: inline-flex; align-items: center; gap: 0.5rem; margin-left: 0.5rem;">
            <%= image_tag @order.assigned_to_user.avatar, alt: @order.assigned_to_user.display_name, style: "width: 24px; height: 24px; border-radius: 50%; object-fit: cover;" %>
            <span><%= @order.assigned_to_user.display_name %></span>
            <% if @order.assigned_to_user.has_regions? %>
              <span style="background: #e0f2fe; color: #0369a1; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.7rem;">
                <%= @order.assigned_to_user.regions.join(", ") %>
              </span>
            <% end %>
          </div>
        <% else %>
          <span style="color: #9ca3af; margin-left: 0.5rem;">Unassigned</span>
        <% end %>

        <div data-controller="searchable-select" style="position: relative; margin-top: 0.5rem; max-width: 250px;">
          <%= form_with url: assign_user_admin_shop_order_path(@order), method: :post, local: true, data: { turbo: false } do |f| %>
            <%= f.hidden_field :assigned_to_user_id, value: @order.assigned_to_user_id, data: { searchable_select_target: "hiddenField" } %>
            <input
              type="text"
              class="form-control"
              placeholder="<%= @order.assigned_to_user.present? ? 'Change assignee...' : 'Assign someone...' %>"
              style="padding: 0.4rem 0.75rem; font-size: 0.85rem;"
              data-searchable-select-target="input"
              data-action="focus->searchable-select#open input->searchable-select#filter"
              autocomplete="off">
            <div data-searchable-select-target="dropdown" class="searchable-select-dropdown">
              <div
                class="searchable-select-option"
                data-searchable-select-target="option"
                data-action="click->searchable-select#selectAndSubmit"
                data-value=""
                data-label=""
                data-search-text="unassigned none remove">
                <span style="color: #9ca3af;">Unassign</span>
              </div>
              <% @fulfillment_users.each do |user| %>
                <div
                  class="searchable-select-option <%= 'selected' if user.id == @order.assigned_to_user_id %>"
                  data-searchable-select-target="option"
                  data-action="click->searchable-select#selectAndSubmit"
                  data-value="<%= user.id %>"
                  data-label="<%= user.display_name %>"
                  data-search-text="<%= "#{user.display_name} #{user.regions.join(' ')} #{user.id}".downcase %>">
                  <img src="<%= user.avatar %>" alt="" class="searchable-select-avatar">
                  <span><%= user.display_name %></span>
                  <% if user.has_regions? %>
                    <span style="font-size: 0.7rem; color: #6b7280; margin-left: auto;"><%= user.regions.join(", ") %></span>
                  <% end %>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    <% if @order.external_ref.present? %>
      <div><b>Tracking/External Reference:</b> <%= @order.external_ref %></div>
    <% end %>
    <% if @order.fulfilled_by.present? %>
      <div><b>Fulfilled By:</b> <%= @order.fulfilled_by %></div>
    <% end %>
    <% if @order.fulfillment_cost.present? && @order.fulfillment_cost > 0 %>
      <div><b>Fulfillment Cost:</b> $<%= number_to_currency(@order.fulfillment_cost, precision: 2, unit: "") %></div>
    <% end %>
    <% if @order.rejection_reason.present? %>
      <div><b>Rejection Reason:</b> <%= @order.rejection_reason %></div>
    <% end %>
    <% if @order.internal_notes.present? %>
      <div><b>Internal Notes:</b> <%= @order.internal_notes %></div>
    <% end %>
  </div>
</div>

<% if @order.shop_card_grant_id.present? %>
  <div class="card">
    <h2>Card Grant</h2>
    <div class="info-rows">
      <div><b>Card Grant ID:</b> <%= @order.shop_card_grant_id %></div>
      <% if @order.shop_card_grant&.hcb_grant_hashid.present? %>
        <div><b>HCB Grant ID:</b> <%= @order.shop_card_grant.hcb_grant_hashid %></div>
        <div>
          <%= link_to "View on HCB", @order.shop_card_grant.hcb_url, target: "_blank", class: "btn-primary", style: "margin-right: 0.5rem;" %>
          <% if current_user.admin? && @order.fulfilled? %>
            <form method="post" action="<%= cancel_hcb_grant_admin_shop_order_path(@order) %>" style="display: inline;">
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <button type="submit" class="btn-danger" onclick="return confirm('Are you sure you want to cancel this HCB grant? This cannot be undone.')">Cancel HCB Grant</button>
            </form>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% end %>

<% if @order.warehouse_package_id.present? %>
  <div class="card">
    <h2>Warehouse Package</h2>
    <div class="info-rows">
      <div><b>Package ID:</b> <%= @order.warehouse_package_id %></div>
    </div>
  </div>
<% end %>

<div class="card" style="margin-top: 0.75rem; padding: 0.4rem; width: 50%;">
<h2>Buttons!</h2>
  <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.25rem;">
    <%= link_to "‚Üê Back", admin_shop_orders_path, class: "btn-secondary", style: "text-align: center; padding: 0.2rem 0.4rem;" %>
    <% unless current_user.fulfillment_person? %>
      <%= link_to "View User", admin_user_path(@order.user), class: "btn-primary", style: "text-align: center; padding: 0.2rem 0.4rem;" %>
    <% end %>

    <% if @order.pending? %>
      <form method="post" action="<%= approve_admin_shop_order_path(@order) %>">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.2rem 0.4rem;" onclick="return confirm('Approve this order for fulfillment?')">‚úì Approve</button>
      </form>
    <% end %>

    <%# Reject button for all non-fulfilled states %>
    <% if %w[pending awaiting_verification awaiting_periodical_fulfillment on_hold].include?(@order.aasm_state) %>
      <button type="button" onclick="document.getElementById('reject-modal').showModal()" class="btn-danger" style="width: 100%; padding: 0.2rem 0.4rem;">‚úó Reject</button>
      <%= render "reject_modal", order: @order %>
    <% end %>

    <%# Refresh verification button for awaiting_verification state %>
    <% if @order.awaiting_verification? %>
      <form method="post" action="<%= refresh_verification_admin_shop_order_path(@order) %>">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.2rem 0.4rem;" onclick="return confirm('Refresh verification status for this user?')">üîÑ Refresh Verification</button>
      </form>
    <% end %>

    <% if (@order.pending? || @order.awaiting_verification? || @order.awaiting_periodical_fulfillment?) && !current_user.fulfillment_person? %>
      <form method="post" action="<%= place_on_hold_admin_shop_order_path(@order) %>">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="btn-secondary" style="width: 100%; padding: 0.2rem 0.4rem;" onclick="return confirm('Place this order on hold?')">‚è∏ Hold</button>
      </form>
    <% end %>

    <% if @order.awaiting_periodical_fulfillment? && (current_user.admin? || current_user.fulfillment_person?) %>
      <form method="post" action="<%= mark_fulfilled_admin_shop_order_path(@order) %>">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.2rem 0.4rem;" onclick="return confirm('Mark this order as fulfilled?')">‚úî Fulfilled</button>
      </form>
    <% end %>

    <% if @order.on_hold? %>
      <form method="post" action="<%= release_from_hold_admin_shop_order_path(@order) %>">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="btn-primary" style="width: 100%; padding: 0.2rem 0.4rem;" onclick="return confirm('Release this order from hold?')">‚ñ∂ Release</button>
      </form>
    <% end %>
  </div>
</div>

<div class="card" style="margin-top: 1rem;">
  <details style="cursor: pointer;">
    <summary style="font-size: 0.875rem; font-weight: 600; padding: 0.25rem 0; user-select: none; color: #374151;">
      üìù Internal Notes
    </summary>
    <div style="padding-top: 0.5rem;">
      <form method="post" action="<%= update_internal_notes_admin_shop_order_path(@order) %>">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <textarea name="internal_notes" rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem; resize: vertical;"><%= @order.internal_notes %></textarea>
        <button type="submit" class="btn-primary" style="margin-top: 0.5rem; padding: 0.25rem 0.75rem; font-size: 0.8rem;">Save Notes</button>
      </form>
    </div>
  </details>
</div>

<%= render Admin::PastOrdersComponent.new(user: @order.user, orders: @user_orders) %>

<div class="card" style="margin-top: 2rem;">
  <% versions = @order.versions.order(created_at: :desc) %>
  <details style="cursor: pointer;">
    <summary style="font-size: 0.875rem; font-weight: 600; padding: 0.25rem 0; user-select: none; color: #374151;">
      üìú Audit Log (<%= versions.count %>)
    </summary>
    <div style="padding-top: 0.5rem;">
  <% if versions.any? %>
    <ul style="list-style: none; padding: 0; margin: 0;">
      <% versions.each do |version| %>
        <%
          changes = version.changeset.except('frozen_address_ciphertext')
          state_change = changes.dig('aasm_state') rescue nil
          old_state = state_change.is_a?(Array) ? state_change.first : nil
          new_state = state_change.is_a?(Array) ? state_change.last : nil
          rejection_reason = changes.dig('rejection_reason')
          new_reason = rejection_reason.is_a?(Array) ? rejection_reason.last : nil
          notes_change = changes.dig('internal_notes')
          who = version.whodunnit.present? ? User.find_by(id: version.whodunnit)&.display_name || "Unknown User" : "System"
        %>
        <li style="padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid
          <% case version.event %>
            <% when 'create' %>
              #3b82f6
            <% when 'update' %>
              <% if new_state %>
                #10b981
              <% else %>
                #f59e0b
              <% end %>
            <% else %>
              #6b7280
          <% end %>
        ; background: #f9fafb; border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div>
              <div style="font-weight: 600; font-size: 0.875rem;">
                <% if new_state == 'awaiting_periodical_fulfillment' %>
                  ‚úì Order Approved for Fulfillment
                <% elsif new_state == 'fulfilled' %>
                  ‚úî Order Fulfilled
                <% elsif new_state == 'rejected' %>
                  ‚úó Order Rejected
                <% elsif new_state == 'on_hold' %>
                  ‚è∏ Order Placed on Hold
                <% elsif new_state == 'pending' %>
                  ‚ü≤ Released from Hold
                <% elsif new_state == 'refunded' %>
                  ‚Ü© Order Refunded
                <% elsif notes_change %>
                  ‚úé Internal Notes Updated
                <% elsif version.event == 'create' %>
                  üìù Order Created
                <% else %>
                  üîÑ Updated
                <% end %>
              </div>
              <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                By <strong><%= who %></strong> ‚Ä¢ Order #<%= version.item_id %>
              </div>
            </div>
            <div style="font-size: 0.75rem; color: #6b7280; text-align: right;">
              <%= version.created_at.strftime("%b %d, %Y %l:%M%p") %>
            </div>
          </div>

          <% if new_state %>
            <div style="font-size: 0.8rem; color: #374151; margin-top: 0.5rem;">
              Updated from <code style="background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 2px; font-weight: 500;"><%= old_state %></code> to <code style="background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 2px; font-weight: 500;"><%= new_state %></code>
            </div>
          <% end %>

          <% if new_reason %>
            <div style="font-size: 0.8rem; color: #991b1b; background: #fee2e2; padding: 0.5rem; border-radius: 3px; margin-top: 0.5rem;">
              <strong>Rejection Reason:</strong> <%= new_reason %>
            </div>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% else %>
    <p style="color: #6b7280; margin: 0; font-size: 0.875rem;">No audit history yet.</p>
  <% end %>
    </div>
  </details>
</div>

<style>
.badge {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.875rem;
  font-weight: 500;
  text-transform: capitalize;
  display: inline-block;
}

.badge-pending {
  background-color: #fbbf24;
  color: #78350f;
}

.badge-awaiting_periodical_fulfillment {
  background-color: #60a5fa;
  color: #1e3a8a;
}

.badge-fulfilled {
  background-color: #10b981;
  color: white;
}

.badge-rejected {
  background-color: #ef4444;
  color: white;
}

.badge-on_hold {
  background-color: #6b7280;
  color: white;
}

.badge-refunded {
  background-color: #a855f7;
  color: white;
}

/* Searchable Select */
.searchable-select-dropdown {
  display: none;
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  max-height: 240px;
  overflow-y: auto;
  background: var(--color-tan-300, #faf7f2);
  border: 1px solid var(--color-brown-500, #8b7355);
  border-radius: 0.5rem;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  z-index: 100;
  margin-top: 0.25rem;
}

.searchable-select-option {
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  transition: background 0.1s;
}

.searchable-select-option:hover {
  background: var(--color-tan-400, #f0ebe3);
}

.searchable-select-option.selected {
  background: var(--color-tan-400, #f0ebe3);
}

.searchable-select-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
}

.form-control {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border-radius: 0.5rem;
  border: 1px solid var(--color-brown-500, #8b7355);
  background: var(--color-tan-400, #f0ebe3);
  font-size: 0.875rem;
  color: inherit;
}

.form-control:focus {
  outline: none;
  border-color: var(--color-brown-700, #5a4a3a);
  box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.1);
}
</style>
