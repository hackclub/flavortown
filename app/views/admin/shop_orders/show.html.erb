<h1 style="font-size: 1.5rem; margin-bottom: 1rem;">Order #<%= @order.id %></h1>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
  <div class="card" style="padding: 0.75rem;">
    <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; font-weight: 600;">Status</h3>
    <span class="badge badge-<%= @order.aasm_state %>" style="font-size: 0.75rem; padding: 0.2rem 0.4rem;">
      <%= @order.aasm_state.humanize %>
    </span>
  </div>

  <div class="card" style="padding: 0.75rem;">
    <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; font-weight: 600;">Created</h3>
    <div style="font-size: 0.75rem; color: #6b7280;"><%= @order.created_at.strftime("%m/%d %l:%M%p") %></div>
  </div>

  <div class="card" style="padding: 0.75rem;">
    <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; font-weight: 600;">User</h3>
    <%= link_to @order.user.display_name || "Unknown", admin_user_path(@order.user), class: "btn-primary slim", style: "font-size: 0.75rem; padding: 0.2rem 0.4rem;" %>
  </div>

  <div class="card" style="padding: 0.75rem;">
    <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; font-weight: 600;">Item</h3>
    <div style="font-size: 0.75rem; color: #374151;"><%= truncate(@order.shop_item.name, length: 25) %></div>
  </div>

  <div class="card" style="padding: 0.75rem;">
    <h3 style="font-size: 0.875rem; margin: 0 0 0.5rem 0; font-weight: 600;">Qty / Cost</h3>
    <div style="font-size: 0.75rem; color: #374151;">
      <%= @order.quantity %> √ó <%= @order.frozen_item_price %> tickets<br>
      <strong style="color: #15803d;"><%= @order.total_cost %> total</strong>
    </div>
  </div>
</div>

<div class="card">
  <h2>Shipping Address</h2>
  <% if @can_view_address %>
    <div id="address-container">
      <div style="padding: 1em; background: #f3f4f6; border-radius: 4px; text-align: center;">
        <p style="margin: 0 0 1em 0; color: #374151;">
          üîí Address is encrypted. Click below to decrypt and view.
        </p>
        <%= button_to "Reveal Address", reveal_address_admin_shop_order_path(@order),
            method: :post,
            class: "btn-primary",
            data: {
              turbo_frame: "address-content",
              turbo_method: "post"
            } %>
      </div>
      <turbo-frame id="address-content"></turbo-frame>
    </div>
  <% else %>
    <div style="padding: 1em; background: #fee2e2; border-radius: 4px;">
      <p style="color: #991b1b; margin: 0;">
        üîí You do not have permission to view this address. Only admins and fulfillment persons in the order's region can access this information.
      </p>
    </div>
  <% end %>
</div>
<% if @order.fulfilled_by.present? %>
<div class="card">
  <h2>Fulfillment Information</h2>
  <div class="info-rows">
    <% if @order.external_ref.present? %>
      <div><b>Tracking/External Reference:</b> <%= @order.external_ref %></div>
    <% end %>
    <% if @order.fulfilled_by.present? %>
      <div><b>Fulfilled By:</b> <%= @order.fulfilled_by %></div>
    <% end %>
    <% if @order.fulfillment_cost.present? && @order.fulfillment_cost > 0 %>
      <div><b>Fulfillment Cost:</b> $<%= number_to_currency(@order.fulfillment_cost, precision: 2, unit: "") %></div>
    <% end %>
    <% if @order.rejection_reason.present? %>
      <div><b>Rejection Reason:</b> <%= @order.rejection_reason %></div>
    <% end %>
    <% if @order.internal_notes.present? %>
      <div><b>Internal Notes:</b> <%= @order.internal_notes %></div>
    <% end %>
  </div>
</div>

<% if @order.shop_card_grant_id.present? %>
  <div class="card">
    <h2>Card Grant</h2>
    <div class="info-rows">
      <div><b>Card Grant ID:</b> <%= @order.shop_card_grant_id %></div>
    </div>
  </div>
<% end %>

<% if @order.warehouse_package_id.present? %>
  <div class="card">
    <h2>Warehouse Package</h2>
    <div class="info-rows">
      <div><b>Package ID:</b> <%= @order.warehouse_package_id %></div>
    </div>
  </div>
<% end %>
<% end %>
<div style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
   <%= link_to "‚Üê Back to Orders", admin_shop_orders_path, class: "btn-secondary" %>
 <% unless current_user.fulfillment_person? %>
 <%= link_to "View User", admin_user_path(@order.user), class: "btn-primary" %>
 <% end %>

   <% if @order.pending? %>
     <form method="post" action="<%= approve_admin_shop_order_path(@order) %>" style="display: inline;">
       <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
       <button type="submit" class="btn-primary" onclick="return confirm('Approve this order for fulfillment?')">‚úì Approve for Fulfillment</button>
     </form>
     <button type="button" onclick="document.getElementById('reject-modal').showModal()" class="btn-danger">‚úó Reject Order</button>
     <%= render "reject_modal", order: @order %>
   <% end %>
   <% if (@order.pending? || @order.awaiting_periodical_fulfillment?) && !current_user.fulfillment_person? %>
      <form method="post" action="<%= place_on_hold_admin_shop_order_path(@order) %>" style="display: inline;">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="btn-secondary" onclick="return confirm('Place this order on hold?')">‚è∏ Place on Hold</button>
      </form>
    <% end %>
    <% if @order.awaiting_periodical_fulfillment? && current_user.fulfillment_person? && !current_user.admin? %>
      <form method="post" action="<%= mark_fulfilled_admin_shop_order_path(@order) %>" style="display: inline;">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit" class="btn-primary" onclick="return confirm('Mark this order as fulfilled?')">‚úî Mark as Fulfilled</button>
      </form>
    <% end %>
   <% if @order.on_hold? %>
     <form method="post" action="<%= release_from_hold_admin_shop_order_path(@order) %>" style="display: inline;">
       <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
       <button type="submit" class="btn-primary" onclick="return confirm('Release this order from hold?')">‚ñ∂ Release from Hold</button>
     </form>
   <% end %>
   </div>

<div class="card" style="margin-top: 2rem;">
  <h2 style="margin-bottom: 1rem;">Audit Log</h2>
  <% versions = @order.versions.order(created_at: :desc) %>
  <% if versions.any? %>
    <ul style="list-style: none; padding: 0; margin: 0;">
      <% versions.each do |version| %>
        <%
          changes = version.changeset.except('frozen_address_ciphertext')
          state_change = changes.dig('aasm_state') rescue nil
          old_state = state_change.is_a?(Array) ? state_change.first : nil
          new_state = state_change.is_a?(Array) ? state_change.last : nil
          rejection_reason = changes.dig('rejection_reason')
          new_reason = rejection_reason.is_a?(Array) ? rejection_reason.last : nil
          notes_change = changes.dig('internal_notes')
          who = version.whodunnit.present? ? User.find_by(id: version.whodunnit)&.display_name || "Unknown User" : "System"
        %>
        <li style="padding: 0.75rem; margin-bottom: 0.5rem; border-left: 3px solid
          <% case version.event %>
            <% when 'create' %>
              #3b82f6
            <% when 'update' %>
              <% if new_state %>
                #10b981
              <% else %>
                #f59e0b
              <% end %>
            <% else %>
              #6b7280
          <% end %>
        ; background: #f9fafb; border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
            <div>
              <div style="font-weight: 600; font-size: 0.875rem;">
                <% if new_state == 'awaiting_periodical_fulfillment' %>
                  ‚úì Order Approved for Fulfillment
                <% elsif new_state == 'fulfilled' %>
                  ‚úî Order Fulfilled
                <% elsif new_state == 'rejected' %>
                  ‚úó Order Rejected
                <% elsif new_state == 'on_hold' %>
                  ‚è∏ Order Placed on Hold
                <% elsif new_state == 'pending' %>
                  ‚ü≤ Released from Hold
                <% elsif new_state == 'refunded' %>
                  ‚Ü© Order Refunded
                <% elsif notes_change %>
                  ‚úé Internal Notes Updated
                <% elsif version.event == 'create' %>
                  üìù Order Created
                <% else %>
                  üîÑ Updated
                <% end %>
              </div>
              <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                By <strong><%= who %></strong> ‚Ä¢ Order #<%= version.item_id %>
              </div>
            </div>
            <div style="font-size: 0.75rem; color: #6b7280; text-align: right;">
              <%= version.created_at.strftime("%b %d, %Y %l:%M%p") %>
            </div>
          </div>

          <% if new_state %>
            <div style="font-size: 0.8rem; color: #374151; margin-top: 0.5rem;">
              Updated from <code style="background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 2px; font-weight: 500;"><%= old_state %></code> to <code style="background: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 2px; font-weight: 500;"><%= new_state %></code>
            </div>
          <% end %>

          <% if new_reason %>
            <div style="font-size: 0.8rem; color: #991b1b; background: #fee2e2; padding: 0.5rem; border-radius: 3px; margin-top: 0.5rem;">
              <strong>Rejection Reason:</strong> <%= new_reason %>
            </div>
          <% end %>
        </li>
      <% end %>
    </ul>
  <% else %>
    <p style="color: #6b7280; margin: 0; font-size: 0.875rem;">No audit history yet.</p>
  <% end %>
</div>

<style>
.badge {
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.875rem;
  font-weight: 500;
  text-transform: capitalize;
  display: inline-block;
}

.badge-pending {
  background-color: #fbbf24;
  color: #78350f;
}

.badge-awaiting_periodical_fulfillment {
  background-color: #60a5fa;
  color: #1e3a8a;
}

.badge-fulfilled {
  background-color: #10b981;
  color: white;
}

.badge-rejected {
  background-color: #ef4444;
  color: white;
}

.badge-on_hold {
  background-color: #6b7280;
  color: white;
}

.badge-refunded {
  background-color: #a855f7;
  color: white;
}
</style>
