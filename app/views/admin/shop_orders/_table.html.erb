<% if orders.any? %>
  <div class="card">
    <table class="table-data">
      <thead>
        <tr>
          <th>ID</th>
          <th>User</th>
          <th>Item</th>
          <th>Qty</th>
          <th>Tickets</th>
          <th>Status</th>
          <% if @view == 'fulfillment' %>
            <th>Region</th>
          <% end %>
          <% if current_user.admin? && @view == 'fulfillment' %>
            <th>Assignee</th>
          <% end %>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% orders.each do |order| %>
          <% can_see = order.can_view_address?(current_user) %>
          <tr>
            <td>#<%= order.id %></td>
            <td>
              <%= link_to order.user.display_name || "Unknown", admin_user_path(order.user), class: "btn-primary slim" %><br>
              <small style="color: #6b7280;"><%= order.user.email %></small>
            </td>
            <td>
              <%= order.shop_item.name %><br>
              <small style="color: #6b7280;"><%= order.shop_item.type&.demodulize %></small>
              <% if order.parent_order_id.present? %>
                <br><small style="color: #f59e0b;">üîó Accessory for #<%= order.parent_order_id %></small>
              <% elsif order.accessory_orders.any? %>
                <br><small style="color: #10b981;">üéÅ +<%= order.accessory_orders.count %> accessories</small>
              <% end %>
            </td>
            <td><%= order.quantity %></td>
            <td><%= order.total_cost %></td>
            <td>
              <span class="badge badge-<%= order.aasm_state %>">
                <%= order.aasm_state.humanize %>
              </span>
              <% if order.aasm_state == "fulfilled" %>
                <br><small style="color: #6b7280;">Shipped to user</small>
              <% end %>
            </td>

            <% if @view == 'fulfillment' %>
              <td>
                <% if order.frozen_address.present? %>
                  <span style="background: #e0f2fe; color: #0369a1; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;">
                    <%= country_name_from_code(order.frozen_address["country"]) %>
                  </span>
                <% else %>
                  <span style="color: #9ca3af;">‚Äî</span>
                <% end %>
              </td>
            <% end %>

            <% if current_user.admin? && @view == 'fulfillment' %>
              <td>
                <% if order.assigned_to_user.present? %>
                  <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <%= image_tag order.assigned_to_user.avatar, alt: order.assigned_to_user.display_name, style: "width: 24px; height: 24px; border-radius: 50%; object-fit: cover;" %>
                    <span><%= order.assigned_to_user.display_name %></span>
                  </div>
                <% end %>
                <div data-controller="searchable-select" style="position: relative; margin-top: 0.25rem;">
                  <%= form_with url: assign_user_admin_shop_order_path(order), method: :post, local: true, data: { turbo: false } do |f| %>
                    <%= f.hidden_field :assigned_to_user_id, value: order.assigned_to_user_id, data: { searchable_select_target: "hiddenField" } %>
                    <input
                      type="text"
                      class="input-primary"
                      placeholder="<%= order.assigned_to_user.present? ? 'Change...' : 'Assign...' %>"
                      style="padding: 0.25rem 0.5rem; font-size: 0.75rem; width: 120px;"
                      data-searchable-select-target="input"
                      data-action="focus->searchable-select#open input->searchable-select#filter"
                      autocomplete="off">
                    <div data-searchable-select-target="dropdown" class="searchable-select-dropdown" style="min-width: 200px;">
                      <div
                        class="searchable-select-option"
                        data-searchable-select-target="option"
                        data-action="click->searchable-select#selectAndSubmit"
                        data-value=""
                        data-label=""
                        data-search-text="unassigned none">
                        <span style="color: #9ca3af;">Unassign</span>
                      </div>
                      <% @fulfillment_users.each do |user| %>
                        <div
                          class="searchable-select-option"
                          data-searchable-select-target="option"
                          data-action="click->searchable-select#selectAndSubmit"
                          data-value="<%= user.id %>"
                          data-label="<%= user.display_name %>"
                          data-search-text="<%= "#{user.display_name} #{user.regions.join(' ')} #{user.id}".downcase %>">
                          <img src="<%= user.avatar %>" alt="" class="searchable-select-avatar">
                          <span><%= user.display_name %></span>
                          <% if user.has_regions? %>
                            <span style="font-size: 0.65rem; color: #6b7280; margin-left: auto;"><%= user.regions.join(", ") %></span>
                          <% end %>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                </div>
              </td>
            <% end %>

            <td>
              <%= order.created_at.strftime("%b %d, %Y") %><br>
              <small style="color: #6b7280;"><%= order.created_at.strftime("%l:%M %p") %></small>
            </td>
            <td>
              <%= link_to "Inspect", admin_shop_order_path(order, return_view: params[:view], return_status: params[:status]), class: "btn-primary slim" %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
<% else %>
  <div class="card">
    <p>No orders found matching the filters.</p>
  </div>
<% end %>
