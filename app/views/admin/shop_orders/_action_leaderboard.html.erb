<%
  # Get order action stats from PaperTrail versions in the last 7 days
  recent_versions = PaperTrail::Version
    .where(item_type: "ShopOrder")
    .where("created_at >= ?", 7.days.ago)
    .where.not(whodunnit: nil)
    .where("object_changes ? 'aasm_state'")

  # Group by user and count actions by type
  action_counts = recent_versions.each_with_object(Hash.new { |h, k| h[k] = { approved: 0, rejected: 0, on_hold: 0, fulfilled: 0, total: 0 } }) do |version, counts|
    user_id = version.whodunnit.to_i
    next if user_id.zero?

    changes = version.object_changes || {}

    state_change = changes["aasm_state"]
    next unless state_change.is_a?(Array) && state_change.length == 2

    new_state = state_change[1]
    case new_state
    when "awaiting_periodical_fulfillment"
      counts[user_id][:approved] += 1
    when "rejected"
      counts[user_id][:rejected] += 1
    when "on_hold"
      counts[user_id][:on_hold] += 1
    when "fulfilled"
      counts[user_id][:fulfilled] += 1
    end
    counts[user_id][:total] += 1
  end

  # Sort by total and take top 10
  top_users = action_counts.sort_by { |_, v| -v[:total] }.first(10)
  user_ids = top_users.map(&:first)
  users_by_id = User.where(id: user_ids).index_by(&:id)
%>

<div class="card action-leaderboard">
  <h3>üèÜ Action Leaderboard <small style="color: #666; font-weight: normal;">(7 days)</small></h3>

  <% if top_users.any? %>
    <table class="leaderboard-table">
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th title="Approved">‚úì</th>
          <th title="Rejected">‚úó</th>
          <th title="On Hold">‚è∏</th>
          <th title="Fulfilled">üì¶</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody>
        <% top_users.each_with_index do |(user_id, stats), index| %>
          <% user = users_by_id[user_id] %>
          <tr class="<%= 'highlight' if index < 3 %>">
            <td class="rank">
              <% if index == 0 %>ü•á
              <% elsif index == 1 %>ü•à
              <% elsif index == 2 %>ü•â
              <% else %><%= index + 1 %>
              <% end %>
            </td>
            <td class="user-name">
              <% if user %>
                <%= link_to user.display_name || user.email, admin_user_path(user) %>
              <% else %>
                <span class="text-muted">User #<%= user_id %></span>
              <% end %>
            </td>
            <td class="stat stat-approved"><%= stats[:approved] %></td>
            <td class="stat stat-rejected"><%= stats[:rejected] %></td>
            <td class="stat stat-on_hold"><%= stats[:on_hold] %></td>
            <td class="stat stat-fulfilled"><%= stats[:fulfilled] %></td>
            <td class="stat stat-total"><%= stats[:total] %></td>
          </tr>
        <% end %>
      </tbody>
    </table>
  <% else %>
    <p class="text-muted">No order actions in the last 7 days.</p>
  <% end %>
</div>

<style>
  .action-leaderboard {
    max-width: 400px;
  }

  .action-leaderboard h3 {
    margin-top: 0;
    margin-bottom: 1em;
  }

  .leaderboard-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9em;
  }

  .leaderboard-table th,
  .leaderboard-table td {
    padding: 0.4em 0.5em;
    text-align: center;
  }

  .leaderboard-table th {
    font-weight: 600;
    border-bottom: 2px solid #e5e7eb;
    font-size: 0.85em;
  }

  .leaderboard-table td.rank {
    font-weight: bold;
  }

  .leaderboard-table td.user-name {
    text-align: left;
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .leaderboard-table tr.highlight {
    background: #fef3c7;
  }

  .leaderboard-table tr:hover {
    background: #f3f4f6;
  }

  .leaderboard-table .stat {
    font-family: monospace;
    font-weight: 500;
  }

  .leaderboard-table .stat-approved { color: #10b981; }
  .leaderboard-table .stat-rejected { color: #ef4444; }
  .leaderboard-table .stat-on_hold { color: #6b7280; }
  .leaderboard-table .stat-fulfilled { color: #6366f1; }
  .leaderboard-table .stat-total { font-weight: bold; color: #1f2937; }

  .text-muted {
    color: #6b7280;
  }
</style>
