<% content_for :title, "Edit Devlog" %>

<div class="projects-new">
  <div class="projects-new__container">
    <%= render HeadingComponent.new(title: "Edit Devlog", tone: :brown) %>

    <%= form_with model: @devlog,
                  url: project_devlog_path(@project, @devlog),
                  method: :patch,
                  html: { multipart: true, data: { controller: "upload-form" } },
                  class: "projects-new__form",
                  local: true do |f| %>
      <div class="projects-new__card">
        <div class="projects-new__field">
          <%= render InputComponent.new(
                label: "Devlog Text",
                placeholder: "Write a few sentences about what you worked onâ€¦",
                form: f,
                attribute: :body,
                color: :red,
                as: :text_area,
                input_html: { rows: 6 }
              ) %>
        </div>

        <% if @devlog.attachments.attached? %>
          <div class="projects-new__field">
            <p class="input__label" style="color: var(--color-brown-900); font-weight: 600;">Current Attachments</p>
            <% if @devlog.attachments.count > 1 %>
              <p class="input__subtitle" style="color: var(--color-brown-700); margin-bottom: 0.5rem;">Check the boxes to remove attachments.</p>
            <% end %>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; padding: 1rem; background: var(--color-bg); border-radius: 8px;">
              <% @devlog.attachments.each do |attachment| %>
                <div style="position: relative; display: flex; flex-direction: column; align-items: center; gap: 0.5rem;">
                  <% if attachment.content_type.start_with?("image/") %>
                    <%= image_tag url_for(attachment.variant(:thumb)), style: "max-width: 100px; max-height: 100px; border-radius: 8px; border: 2px solid var(--color-brown-300);" %>
                  <% elsif attachment.content_type.start_with?("video/") %>
                    <div style="width: 100px; height: 100px; background: var(--color-brown-200); border-radius: 8px; display: flex; align-items: center; justify-content: center; border: 2px solid var(--color-brown-300);">
                      <span style="font-size: 2rem;">ðŸŽ¬</span>
                    </div>
                  <% else %>
                    <div style="padding: 1rem; background: var(--color-brown-100); border-radius: 8px; color: var(--color-brown-900);">
                      <%= truncate(attachment.filename.to_s, length: 15) %>
                    </div>
                  <% end %>
                  <% if @devlog.attachments.count > 1 %>
                    <label style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--color-red-600); cursor: pointer;">
                      <%= check_box_tag "remove_attachment_ids[]", attachment.id, false, style: "cursor: pointer;", data: { "upload-form-target": "removeCheckbox" } %>
                      Remove
                    </label>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <div class="projects-new__field">
          <%= render FileUploadComponent.new(
                label: "Add More Attachments",
                form: f,
                attribute: :attachments,
                color: :green,
                subtitle: "Supports images, video, and GIF. Max 50 MB.",
                accept: Post::Devlog::ACCEPTED_CONTENT_TYPES.join(","),
                multiple: true,
                max_count: 8,
                max_size: 50.megabytes
              ) %>
        </div>
      </div>

      <div class="projects-new__actions">
        <%= render ButtonComponent.new(text: "Cancel", href: project_path(@project), color: :red, variant: :borderless) %>
        <%= render ButtonComponent.new(text: "Save Changes", color: :brown, type: :submit, disable_with: "Saving...", data: { "upload-form-target": "submit" }) %>
      </div>
    <% end %>

    <% if @devlog.versions.any? %>
      <div class="projects-new__card" style="margin-top: 2rem;">
        <h3>Version History</h3>
        <p><%= link_to "View #{@devlog.versions.count} previous version(s)", versions_project_devlog_path(@project, @devlog) %></p>
      </div>
    <% end %>
  </div>
</div>
