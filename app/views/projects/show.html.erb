<% content_for :title, @project.title %>
<% content_for :og_title, @project.title %>
<% content_for :og_description, truncate(@project.description.to_s, length: 200) %>
<% content_for :og_image, project_og_image_url(@project, format: :png) %>
<% content_for :twitter_card, "summary_large_image" %>
<% content_for :og_author, @project.memberships.find_by(role: :owner)&.user&.display_name %>

<div class="projects-show">
  <div class="projects-show__container">
    <%= render ProjectShowCardComponent.new(project: @project, current_user: current_user) %>

    <% if current_user.present? %>
      <div class="mt-4" style="display: flex; gap: var(--space-m); align-items: center;">
        <% if @project.users.include?(current_user) %>
          <%= render ButtonComponent.new(
                text: "Add Devlog",
                color: :brown,
                href: new_project_devlog_path(@project)
              ) %>
        <% else %>
          <% if current_user.project_follows.exists?(project: @project) %>
            <%= button_to unfollow_project_path(@project), method: :delete, class: "btn btn--brown" do %>
              Unfollow
            <% end %>
          <% else %>
            <%= button_to follow_project_path(@project), method: :post, class: "btn btn--brown" do %>
              Follow
            <% end %>
          <% end %>
        <% end %>

        <% if !@project.users.include?(current_user) || Rails.env.development? %>
          <button type="button" class="btn btn--yellow btn--borderless report-btn" aria-label="Report" onclick="document.getElementById('project-report-modal').showModal()">
            <%= inline_svg_tag "icons/flag.svg" %>
            REPORT
          </button>
        <% end %>

        <% if policy(@project).resend_webhook? %>
          <button type="button" class="btn btn--brown" id="resend-webhook-btn" data-project-id="<%= @project.id %>">
            Resend Webhook (for ship)
          </button>
          <script>
            document.getElementById('resend-webhook-btn').addEventListener('click', function() {
              if (confirm('Are you sure you want to resend the webhook for this project?')) {
                fetch("<%= resend_webhook_project_path(@project).to_json %>".replaceAll("&quot;", ""), {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                  }
                })
                .then(response => response.json())
                .then(data => {
                  alert(data.message);
                })
                .catch(error => {
                  alert('An error occurred while resending the webhook.');
                  console.error('Error:', error);
                });
              }
            });
          </script>
        <% end %>
      </div>
    <% end %>

    <% if @posts.present? %>
      <div class="projects-show__timeline">
        <div class="mt-4" style="display: grid; gap: var(--space-xl);">
          <% @posts.each do |post| %>
            <%= render PostComponent.new(post: post, current_user: current_user) %>
          <% end %>
        </div>
      </div>
    <% end %>

    <% if current_user.present? && (!@project.users.include?(current_user) || Rails.env.development?) %>
      <%= render layout: "shared/modal", locals: { id: "project-report-modal", title: "Report project?" } do %>
        <h2>We want good, high quality projects in Flavortown. If you believe this project violates our community guidelines, please let us know why:</h2>

        <%= form_with model: Project::Report.new, url: project_reports_path(@project), local: true do |f| %>
          <div class="form-field">
            <div class="form-checkbox">
              <%= f.radio_button :reason, "low_effort", id: "project_report_reason_low_effort", required: true %>
              <%= f.label :reason, "Low-effort project", for: "project_report_reason_low_effort" %>
            </div>

            <div class="form-checkbox">
              <%= f.radio_button :reason, "undeclared_ai", id: "project_report_reason_undeclared_ai" %>
              <%= f.label :reason, "Uses AI but it's undeclared", for: "project_report_reason_undeclared_ai" %>
            </div>

            <div class="form-checkbox">
              <%= f.radio_button :reason, "demo_broken", id: "project_report_reason_demo_broken" %>
              <%= f.label :reason, "Demo does not work", for: "project_report_reason_demo_broken" %>
            </div>

            <div class="form-checkbox">
              <%= f.radio_button :reason, "other", id: "project_report_reason_other" %>
              <%= f.label :reason, "Other", for: "project_report_reason_other" %>
            </div>
          </div>

          <div class="form-group">
            <%= f.text_area :details,
                  rows: 4,
                  minlength: 20,
                  required: true,
                  class: "form-field",
                  placeholder: "Share a short explanation (20+ characters)." %>
            <small>Why are you reporting this project? (20+ characters)</small>
          </div>

          <div class="modal__actions">
            <%= f.submit "Submit", class: "modal__actions-close" %>
            <button type="button" class="modal__actions-close" onclick="document.getElementById('project-report-modal').close()">Cancel</button>
          </div>
        <% end %>
      <% end %>
    <% end %>
  </div>
</div>
