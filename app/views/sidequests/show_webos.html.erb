<% content_for :title, @sidequest.title %>
<% content_for :og_description, truncate(@sidequest.description.to_s, length: 200) %>
<% content_for :og_image, og_image_url('sidequests', format: :png) %>
<% content_for :twitter_card, "summary_large_image" %>
<%= content_for :stylesheets do %>
  <%= stylesheet_link_tag "xp_window", "data-turbo-track": "reload" %>
<% end %>

<%= render HeadingComponent.new(title: @sidequest.title, tone: :blue, size: :full) %>

<div class="sidequest-show">
  <div class="sidequest-show__content">
    <% if @sidequest.description.present? %>
      <p class="sidequest-show__description"><%= @sidequest.description %></p>
    <% end %>

<div class="sidequest-show__xp-windows">
      <%# Instructions window %>
      <div class="xp-window-wrapper" data-controller="xp-window">
        <div class="window" data-xp-window-target="window">
          <div class="title-bar"
               data-xp-window-target="titlebar"
               data-action="mousedown->xp-window#dragStart touchstart->xp-window#dragTouchStart">
            <div class="title-bar-text">How to participate</div>
            <div class="title-bar-controls">
              <button aria-label="Minimize" data-action="click->xp-window#minimize"></button>
              <%= link_to "https://jams.hackclub.com/batch/webOS", target: "_blank", rel: "noopener", class: "xp-window-wrapper__external-link", title: "Open Jam guide" do %>
                <button aria-label="Maximize"></button>
              <% end %>
              <button aria-label="Close" data-action="click->xp-window#close"></button>
            </div>
          </div>
          <div class="window-body">
            <ol class="sidequest-show__steps">
              <li>Follow the <a href="https://jams.hackclub.com/batch/webOS" target="_blank" rel="noopener">webOS Jam guide</a> to build your project</li>
              <li>Ship your project on Flavortown</li>
              <li>Submit it to this sidequest from your project page</li>
              <li>Once approved, you'll unlock webOS prizes in the shop!</li>
            </ol>
          </div>
          <div class="xp-window-wrapper__resize-handle"
               data-xp-window-target="resizeHandle"
               data-action="mousedown->xp-window#resizeStart"></div>
        </div>
      </div>

      <%# Countdown window %>
      <% if @sidequest.expires_at.present? %>
        <% sidequest_ended = @sidequest.expires_at <= Time.current %>
        <div class="xp-window-wrapper" data-controller="xp-window">
          <div class="window" data-xp-window-target="window">
            <div class="title-bar"
                 data-xp-window-target="titlebar"
                 data-action="mousedown->xp-window#dragStart touchstart->xp-window#dragTouchStart">
              <div class="title-bar-text"><%= sidequest_ended ? "Submissions Closed" : "Time Remaining" %></div>
              <div class="title-bar-controls">
                <button aria-label="Minimize" data-action="click->xp-window#minimize"></button>
                <button aria-label="Close" data-action="click->xp-window#close"></button>
              </div>
            </div>
            <div class="window-body">
              <p style="text-align: center; margin: 0 0 8px;">
                <%= sidequest_ended ? "Ended" : "Ends" %> <%= @sidequest.expires_at.strftime("%B %d, %Y") %>
              </p>
              <% sidequest_start = Time.zone.local(2026, 2, 14) %>
              <% total = (@sidequest.expires_at - sidequest_start).to_f %>
              <% remaining = [(@sidequest.expires_at - Time.current).to_f, 0].max %>
              <% elapsed_pct = (((total - remaining) / total) * 100).clamp(0, 100) %>
              <progress max="100" value="<%= elapsed_pct.round %>"></progress>
              <p style="text-align: center; margin: 8px 0 0; font-size: 11px; color: #666;">
                <% if sidequest_ended %>
                  Submissions ended <%= distance_of_time_in_words(Time.current, @sidequest.expires_at) %> ago
                <% else %>
                  <%= distance_of_time_in_words(Time.current, @sidequest.expires_at) %> left
                <% end %>
              </p>
            </div>
            <div class="xp-window-wrapper__resize-handle"
                 data-xp-window-target="resizeHandle"
                 data-action="mousedown->xp-window#resizeStart"></div>
          </div>
        </div>
      <% end %>

      <%# Prizes window %>
      <% if @prizes.present? && @prizes.any? %>
        <div class="xp-window-wrapper" data-controller="xp-window">
          <div class="window" data-xp-window-target="window">
            <div class="title-bar"
                 data-xp-window-target="titlebar"
                 data-action="mousedown->xp-window#dragStart touchstart->xp-window#dragTouchStart">
              <div class="title-bar-text">Prizes</div>
              <div class="title-bar-controls">
                <button aria-label="Minimize" data-action="click->xp-window#minimize"></button>
                <button aria-label="Close" data-action="click->xp-window#close"></button>
              </div>
            </div>
            <div class="window-body">
              <div class="sidequest-show__prizes-list">
                <% @prizes.each do |prize| %>
                  <%= link_to "/shop/order?shop_item_id=#{prize.id}", class: "sidequest-show__prize-row" do %>
                    <% if prize.image.attached? %>
                      <div class="sidequest-show__prize-image">
                        <%= image_tag prize.image.variant(:carousel_sm), alt: prize.name, loading: "lazy" %>
                      </div>
                    <% end %>
                    <span class="sidequest-show__prize-name"><%= prize.name %></span>
                    <span class="sidequest-show__prize-cost"><%= number_to_currency(prize.ticket_cost, precision: 0).gsub('$', '') %></span>
                  <% end %>
                <% end %>
              </div>
            </div>
            <div class="xp-window-wrapper__resize-handle"
                 data-xp-window-target="resizeHandle"
                 data-action="mousedown->xp-window#resizeStart"></div>
          </div>
        </div>
      <% end %>
    </div>

    <% if @approved_entries.any? %>
      <div class="sidequest-show__gallery">
        <h3 class="sidequest-show__gallery-title"><%= @approved_entries.size %> <%= "submission".pluralize(@approved_entries.size) %></h3>
        <div class="sidequest-show__gallery-grid">
          <% @approved_entries.each do |entry| %>
            <% project = entry.project %>
            <% next unless project.present? %>
            <div class="sidequest-show__gallery-item">
              <%= render partial: "projects/card", locals: { project: project } %>
            </div>
          <% end %>
        </div>
      </div>
    <% else %>
      <div class="sidequest-show__stats">
        <p><strong>Be the first to submit</strong></p>
      </div>
    <% end %>

    <div class="sidequest-show__actions">
      <%= render ButtonComponent.new(
            text: "\u2190 Back to Sidequests",
            href: sidequests_path,
            color: :brown,
            variant: :borderless
          ) %>
    </div>
  </div>
</div>
