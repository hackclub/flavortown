<% content_for :title, "Order #{@shop_item.name}" %>
<%= render "shared/inspector", record: @shop_item %>
<div class="shop-order">
    <div class="shop-order__back">
        <%= render ButtonComponent.new(
            text: "‚Üê Back to the Shop",
            href: "/shop",
            color: :brown,
            variant: :borderless
        ) %>
    </div>
    <div class="shop-order__content">
        <div class="shop-order__view"
         data-controller="customs-warning"
         data-customs-warning-item-type-value="<%= customs_warning_item_type(@shop_item) %>"
         data-customs-warning-us-origin-message-value="‚ö†Ô∏è Shipped from US - Customs fees may apply if shipping outside the US"
         data-customs-warning-uk-origin-message-value="‚ö†Ô∏è Shipped from UK - Customs fees may apply if shipping outside the UK"
         data-customs-warning-unknown-origin-message-value="‚ö†Ô∏è Origin unknown - Customs fees may apply depending on destination country"
         data-customs-warning-custom-region-message-value="<%= customs_warning_message(@shop_item) %>"
         data-customs-warning-source-region-value="<%= customs_warning_source_region(@shop_item) %>"
         data-action="address-select:change@document->customs-warning#addressChanged">
            <div class="shop-order__image">
                <%= image_tag @shop_item.image, loading: "lazy", decoding: "async" if @shop_item.image.attached? %>
            </div>
            <h2><%= @shop_item.name %></h2>
            <% if @shop_item.on_sale? %>
                <div class="shop-order__sale-badge">
                    <%= @shop_item.sale_percentage %>% OFF SALE
                </div>
            <% end %>
            <% if @shop_item.limited? && @shop_item.remaining_stock.present? %>
                <div class="shop-order__stock-indicator<%= ' shop-order__stock-indicator--low' if @shop_item.remaining_stock <= 5 %><%= ' shop-order__stock-indicator--out' if @shop_item.remaining_stock <= 0 %>">
                    <% if @shop_item.remaining_stock <= 0 %>
                        <span>Out of stock</span>
                    <% else %>
                        <span><%= @shop_item.remaining_stock %> left in stock</span>
                    <% end %>
                </div>
            <% end %>
            <% if @required_achievement %>
                <div class="shop-order__achievement-requirement <%= 'shop-order__achievement-requirement--locked' if @locked_by_achievement %>">
                    <% if @locked_by_achievement %>
                        <span>Requires "<%= @required_achievement.name %>" achievement to purchase</span>
                    <% else %>
                        <span>Unlocked via "<%= @required_achievement.name %>" achievement</span>
                    <% end %>
                </div>
            <% end %>
            <div class="shop-order__description"><%= md(@shop_item.description) %></div>
             <%= render MarkdownContentComponent.new(markdown: @shop_item.long_description) %>
             <div class="shop-order__disclaimer">
                 Heads up! If we can't order this item to you, we'll try our best to send something simillar, which may be from a different brand!
             </div>
             <div class="shop-order__blocked-country-banner" data-blocked-country-banner style="display: none;">
                 This item is currently not available in your specific country due to logistics issues.
             </div>
            <div class="shop-order__customs-warning" data-customs-warning-target="warning" style="display: none;"></div>
        </div>
        <div class="shop-order__details" data-controller="order-form" data-order-form-has-addresses-value="<%= current_user.addresses.any? %>" data-order-form-base-ticket-cost-value="<%= @sale_price || @shop_item.ticket_cost || 0 %>" data-order-form-user-balance-value="<%= current_user.balance || 0 %>" data-order-form-addresses-value="<%= current_user.addresses.to_json %>" data-order-form-blocked-countries-value="<%= @shop_item.blocked_countries.to_json %>" data-action="address-select:change@document->order-form#addressChanged">
            <h2>Complete your order:</h2>
            <%= form_with url: shop_order_path(shop_item_id: @shop_item.id), method: :post, local: true, id: "order-form" do |form| %>
                <% if not @shop_item.one_per_person_ever %>
                    <div class="shop-order__quantity">
                        <%= render InputComponent.new(
                        label: "Quantity",
                        placeholder: 1,
                        form: form,
                        attribute: :quantity,
                        subtitle: "Maximum #{@shop_item.max_qty || 10} items per order",
                        color: :red,
                        as: :number_field,
                        input_html: { min: 1, max: 10, step: 1, value: 1, id: "shop-order__quantity-input" }
                        ) %>
                    </div>
                <% else %>
                    <%= form.hidden_field :quantity, value: 1 %>
                <% end %>

                <%
                  tagged_accessories = @accessories.select(&:has_tag?).group_by(&:accessory_tag).transform_values { |accessories| accessories.sort_by(&:ticket_cost) }
                  untagged_accessories = @accessories.reject(&:has_tag?).sort_by(&:ticket_cost)
                %>

                <% if tagged_accessories.any? || untagged_accessories.any? %>
                    <div class="shop-order__accessories">

                         <% tagged_accessories.each do |tag, accessories_in_group| %>
                             <div class="shop-order__accessory-group-section">
                                 <h5><%= tag.titleize.gsub('_', ' ') %></h5>
                                 <div class="shop-order__accessory-options">
                                     <% accessories_in_group.each do |accessory| %>
                                         <label class="shop-order__accessory-option-label">
                                             <input type="radio"
                                                    name="accessory_tag_<%= tag %>"
                                                    value="<%= accessory.id %>"
                                                    class="shop-order__accessory-option-input"
                                                    data-price="<%= accessory.ticket_cost %>"
                                                    data-tag="<%= tag %>"
                                                    form="order-form"
                                                    style="display: none;">
                                             <div class="shop-order__accessory-option-block">
                                                 <div class="shop-order__accessory-option-name"><%= accessory.name %></div>
                                                 <div class="shop-order__accessory-option-price">üç™ <%= accessory.ticket_cost.round %></div>
                                             </div>
                                         </label>
                                     <% end %>
                                 </div>
                             </div>
                         <% end %>

                        <% if untagged_accessories.any? %>
                            <div class="shop-order__accessory-group-section">
                                <h5>Other upgrades</h5>
                                <div class="shop-order__accessory-options">
                                    <% untagged_accessories.each do |accessory| %>
                                        <label class="shop-order__accessory-option-label">
                                            <input type="checkbox"
                                                   name="accessory_ids[]"
                                                   value="<%= accessory.id %>"
                                                   class="shop-order__accessory-option-input"
                                                   data-price="<%= accessory.ticket_cost %>"
                                                   style="display: none;">
                                            <div class="shop-order__accessory-option-block shop-order__accessory-option-block--with-image">
                                                <% if accessory.image.attached? %>
                                                    <%= image_tag accessory.image.variant(:carousel_sm), class: "shop-order__accessory-option-image", loading: "lazy" %>
                                                <% end %>
                                                <div class="shop-order__accessory-option-details">
                                                    <div class="shop-order__accessory-option-name"><%= accessory.name %></div>
                                                    <div class="shop-order__accessory-option-price">üç™ <%= accessory.ticket_cost.round %></div>
                                                </div>
                                            </div>
                                        </label>
                                    <% end %>
                                </div>
                            </div>
                        <% end %>
                    </div>
                <% end %>
            <% end %>
            <% user_addresses = current_user.addresses %>
            <div class="shop-order__address" data-controller="address-select" data-addresses="<%= user_addresses.to_json %>">
                <% if user_addresses.any? %>
                    <div class="shop-order__address-details">
                        <%
                          primary_addr = user_addresses.find { |a| a["primary"] } || user_addresses.first
                          address_options = user_addresses.map do |addr|
                            {
                              label: "#{addr["first_name"]} #{addr["last_name"]} - #{addr["line_1"]}, #{addr["city"]}",
                              value: addr["id"]
                            }
                          end
                          longest_option = address_options.max_by { |o| o[:label].length }&.dig(:label) || ""
                        %>
                        <input type="hidden" name="address_id" form="order-form" id="address-id-input" value="<%= primary_addr["id"] %>" data-address-select-target="input">
                        <div data-address-select-target="dropdown">
                            <%= render DropdownComponent.new(
                                label: "Shipping Address",
                                options: address_options,
                                selected_option: "#{primary_addr["first_name"]} #{primary_addr["last_name"]} - #{primary_addr["line_1"]}, #{primary_addr["city"]}",
                                longest_option_string: longest_option,
                                color: :blue
                            ) %>
                        </div>

                    </div>
                    <div class="shop-order__edit-address">
                        <%= link_to "Edit addresses", HCAService.address_portal_url(return_to: request.original_url), class: "btn btn-order", style: "margin-top: 0.5em;" %>
                    </div>
                <% else %>
                    <div class="shop-order__no-address">
                         <p>No shipping address found.</p>
                         <%= link_to "Add an address", HCAService.address_portal_url(return_to: request.original_url), class: "btn btn-order" %>
                    </div>
                <% end %>
            </div>
            <div class="shop-order__summary">
                <%= render InputGroupComponent.new(
                    label: "Order Summary",
                    color: :green,
                    subtitle: "Current Balance: üç™#{ current_user.balance }",
                ) do %>
                    <div class="shop-order__summary-content">
                        <div class="shop-order__summary-price">
                            <h4>Base Price:</h4>
                            <% if @shop_item.on_sale? %>
                                <h4>
                                    <span class="shop-order__original-price">üç™ <%= @regional_base_price.round %></span>
                                    üç™ <%= @sale_price.round %>
                                </h4>
                            <% else %>
                                <h4>üç™ <%= @regional_base_price.round %></h4>
                            <% end %>
                        </div>
                        <div class="shop-order__summary-accessories-list" id="shop-order__summary-accessories-list" style="display: none;" data-order-form-target="accessoriesListContainer">
                            <h4>Accessories:</h4>
                            <ul id="shop-order__accessories-list-items" data-order-form-target="accessoriesListItems"></ul>
                        </div>
                        <div class="shop-order__summary-qty">
                            <h4>Quantity:</h4>
                            <h4 id="shop-order__summary-qty-display" data-order-form-target="summaryQtyDisplay">1x</h4>
                        </div>
                        <div class="shop-order__summary-total">
                            <h4>Total:</h4>
                            <h4 id="shop-order__summary-total-display" data-order-form-target="summaryTotalDisplay">üç™ <%= @sale_price.round %></h4>
                        </div>
                    </div>
                <% end %>
            </div>
            <button type="submit" form="order-form" class="btn btn-order" style="width: 100%;" data-order-form-target="submitButton" <%= 'disabled' if @locked_by_achievement %>>
                <%= inline_svg_tag "icons/tick.svg", class: "shop-order__summary-btn-icon", aria: { hidden: true } %>
                <%= @locked_by_achievement ? 'Locked' : 'Get!' %>
            </button>
        </div>
    </div>
</div>
