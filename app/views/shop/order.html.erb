<div class="shop-order">
    <div class="shop-order__back">
        <%= render ButtonComponent.new(
            text: "‚Üê Back to the Shop",
            href: "/shop",
            color: :brown,
            variant: :borderless
        ) %>
    </div>
    <div class="shop-order__content">
        <div class="shop-order__view">
            <div class="shop-order__image">
                <%= image_tag @shop_item.image, loading: "lazy", decoding: "async" if @shop_item.image.attached? %>
            </div>
            <h2><%= @shop_item.name %></h2>
            <div class="shop-order__description"><%= md(@shop_item.description) %></div>
            <% if @shop_item.type.include?("HQMailItem") || @shop_item.type.include?("WarehouseItem") %>
                <div class="shop-order__customs-warning">
                ‚ö†Ô∏è May incur customs duties
                </div>
          <% end %>
        </div>
        <div class="shop-order__details" data-controller="order-form" data-order-from-has-addresses-value="<%= current_user.addresses.any? %>">
            <h2>Complete your order:</h2>
            <%= form_with url: shop_order_path(shop_item_id: @shop_item.id), method: :post, local: true, id: "order-form" do |form| %>
                <% if not @shop_item.one_per_person_ever %>
                    <div class="shop-order__quantity">
                        <%= render InputComponent.new(
                        label: "Quantity",
                        placeholder: 1,
                        form: form,
                        attribute: :quantity,
                        subtitle: "Maximum #{@shop_item.max_qty || 10} items per order",
                        color: :red,
                        as: :number_field,
                        input_html: { min: 1, max: 10, step: 1, value: 1, id: "shop-order__quantity-input" }
                        ) %>
                    </div>
                <% else %>
                    <%= form.hidden_field :quantity, value: 1 %>
                <% end %>

                <% if @accessories.any? %>
                    <div class="shop-order__accessories">
                        <h4>Add Accessories:</h4>
                        <% @accessories.each do |accessory| %>
                            <div class="shop-order__accessory-item">
                                <label class="shop-order__accessory-label">
                                    <input type="checkbox"
                                           name="accessory_ids[]"
                                           value="<%= accessory.id %>"
                                           class="shop-order__accessory-checkbox"
                                           data-price="<%= accessory.ticket_cost %>">
                                    <% if accessory.image.attached? %>
                                        <%= image_tag accessory.image.variant(:carousel_sm), class: "shop-order__accessory-image", loading: "lazy" %>
                                    <% end %>
                                    <span class="shop-order__accessory-name"><%= accessory.name %></span>
                                    <span class="shop-order__accessory-price">üç™ <%= accessory.ticket_cost %></span>
                                </label>
                            </div>
                        <% end %>
                    </div>
                <% end %>
            <% end %>
            <% user_addresses = current_user.addresses %>
            <div class="shop-order__address" data-controller="address-select" data-addresses="<%= user_addresses.to_json %>">
                <% if user_addresses.any? %>
                    <div class="shop-order__address-details">
                        <%
                          primary_addr = user_addresses.find { |a| a["primary"] } || user_addresses.first
                          address_options = user_addresses.map do |addr|
                            {
                              label: "#{addr["first_name"]} #{addr["last_name"]} - #{addr["line_1"]}, #{addr["city"]}",
                              value: addr["id"]
                            }
                          end
                          longest_option = address_options.max_by { |o| o[:label].length }&.dig(:label) || ""
                        %>
                        <input type="hidden" name="address_id" form="order-form" id="address-id-input" value="<%= primary_addr["id"] %>" data-address-select-target="input">
                        <div data-address-select-target="dropdown">
                            <%= render DropdownComponent.new(
                                label: "Shipping Address",
                                options: address_options,
                                selected_option: "#{primary_addr["first_name"]} #{primary_addr["last_name"]} - #{primary_addr["line_1"]}, #{primary_addr["city"]}",
                                longest_option_string: longest_option,
                                color: :blue
                            ) %>
                        </div>

                    </div>
                <% else %>
                    <div class="shop-order__no-address">
                         <p>No shipping address found.</p>
                         <a href="https://auth.hackclub.com/addresses" target="_blank" class="btn btn-sm btn-outline-primary">Manage addresses</a>
                    </div>
                <% end %>
            </div>
            <div class="shop-order__summary">
                <%= render InputGroupComponent.new(
                    label: "Order Summary",
                    color: :green,
                    subtitle: "Current Balance: üç™#{ current_user.balance }",
                ) do %>
                    <div class="shop-order__summary-content">
                        <div class="shop-order__summary-price">
                            <h4>Price:</h4>
                            <h4>üç™ <%= @shop_item.ticket_cost %></h4>
                        </div>
                        <div class="shop-order__summary-qty">
                            <h4>Quantity:</h4>
                            <h4 id="shop-order__summary-qty-display">1x</h4>
                        </div>
                        <div class="shop-order__summary-accessories" id="shop-order__summary-accessories" style="display: none;">
                            <h4>Accessories:</h4>
                            <h4 id="shop-order__summary-accessories-display">üç™ 0</h4>
                        </div>
                        <div class="shop-order__summary-total">
                            <h4>Total:</h4>
                            <h4 id="shop-order__summary-total-display">üç™ <%= @shop_item.ticket_cost %></h4>
                        </div>
                    </div>
                <% end %>
            </div>
            <button type="submit" form="order-form" class="btn btn-order" style="width: 100%;" data-order-form-target="submitButton">
                <%= inline_svg_tag "icons/tick.svg", class: "shop-order__summary-btn-icon", aria: { hidden: true } %>
                Get!
            </button>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const quantityInput = document.getElementById('shop-order__quantity-input');
    const summaryQtyDisplay = document.getElementById('shop-order__summary-qty-display');
    const summaryTotalDisplay = document.getElementById('shop-order__summary-total-display');
    const summaryAccessoriesContainer = document.getElementById('shop-order__summary-accessories');
    const summaryAccessoriesDisplay = document.getElementById('shop-order__summary-accessories-display');
    const accessoryCheckboxes = document.querySelectorAll('.shop-order__accessory-checkbox');
    const ticketCost = <%= raw (@shop_item.ticket_cost || 0).to_json %>;

    function calculateAccessoriesTotal() {
        let total = 0;
        accessoryCheckboxes.forEach(function(checkbox) {
            if (checkbox.checked) {
                total += parseFloat(checkbox.dataset.price) || 0;
            }
        });
        return total;
    }

    function updateOrderSummary() {
        const qty = parseInt(quantityInput ? quantityInput.value : 1) || 1;
        const accessoriesTotal = calculateAccessoriesTotal();
        const itemTotal = qty * ticketCost;
        const grandTotal = itemTotal + accessoriesTotal;

        if (summaryQtyDisplay) {
            summaryQtyDisplay.textContent = qty + 'x';
        }

        if (summaryAccessoriesContainer && summaryAccessoriesDisplay) {
            if (accessoriesTotal > 0) {
                summaryAccessoriesContainer.style.display = 'flex';
                summaryAccessoriesDisplay.textContent = 'üç™ ' + accessoriesTotal.toFixed(2);
            } else {
                summaryAccessoriesContainer.style.display = 'none';
            }
        }

        if (summaryTotalDisplay) {
            summaryTotalDisplay.textContent = 'üç™ ' + grandTotal.toFixed(2);
        }
    }

    if (quantityInput) {
        quantityInput.addEventListener('input', updateOrderSummary);
    }

    accessoryCheckboxes.forEach(function(checkbox) {
        checkbox.addEventListener('change', updateOrderSummary);
    });

    updateOrderSummary();

    const addressSelect = document.getElementById('address-select');
    const addressPreview = document.getElementById('address-preview');
    const addresses = <%= raw (current_user.addresses || []).to_json %>;

    if (addressSelect && addressPreview) {
        addressSelect.addEventListener('change', function() {
            const selectedId = this.value;
            const addr = addresses.find(a => a.id === selectedId);
            if (addr) {
                let html = '<p>' +
                    addr.first_name + ' ' + addr.last_name + '<br>' +
                    addr.line_1;
                if (addr.line_2) {
                    html += '<br>' + addr.line_2;
                }
                html += '<br>' + addr.city + ', ' + addr.state + ' ' + addr.postal_code +
                    '<br>' + addr.country + '</p>';
                addressPreview.innerHTML = html;
            }
        });
    }
});
</script>
