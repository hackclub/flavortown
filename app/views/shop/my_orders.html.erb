<% if @show_tutorial_complete_dialog %>
  <%= render DialogueBoxComponent.new(
    text: [
      "Awesome! Your free stickers are on the way!",
      "We've received your order and will ship it out soon once your identity is verified!",
      "Tutorial complete! You now know how to tracking time, earn cookies, and order prizes.",
      "Keep building and earning cookies to unlock more shop items! Need help? Drop a message in #flavortown-help on Slack. Happy Hacking and Keep Cooking!"
    ],
    sticker: "free_sticker.png",
    sticker_line_index: 0
  ) %>
<% end %>

<div class="my-orders">
  <div class="my-orders__header">
    <h1 class="my-orders__title">My Orders</h1>
    <%= render ButtonComponent.new(text: "Back to the Shop", href: "/shop/", color: :brown, variant: :borderless) %>
  </div>

  <% if @orders.empty? %>
    <div class="my-orders__empty">
      <p>You haven't placed any orders yet.</p>
    </div>
  <% else %>
    <div class="my-orders__list">
      <% @orders.each do |order| %>
        <%= render "shared/inspector", record: order %>
        <div class="my-orders__item">
          <div class="my-orders__header-bar">
            <div class="my-orders__header-item">
              <span class="my-orders__header-label">Order Placed</span>
              <span class="my-orders__header-value"><%= order.created_at.strftime("%b %d, %Y") %></span>
            </div>

            <div class="my-orders__header-item">
              <span class="my-orders__header-label">Total</span>
              <span class="my-orders__header-value">üç™ <%= number_with_precision((order.frozen_item_price || order.shop_item.ticket_cost) * order.quantity, precision: 0) %></span>
            </div>

            <% if order.frozen_address.present? %>
              <div class="my-orders__header-item">
                <span class="my-orders__header-label">Ship To</span>
                <span class="my-orders__header-value my-orders__blurred-when-inactive"><%= order.frozen_address.dig('line_1')&.to_s&.split(',')&.first&.truncate(30) || 'N/A' %></span>
              </div>
            <% end %>

            <div class="my-orders__header-item my-orders__header-item--right">
              <div class="my-orders__order-number-section">
                  <span class="my-orders__header-label">Order # <%= order.id %></span>
                  <% if order.pending? %>
                    <%= button_to "Cancel Order", cancel_shop_order_path(order_id: order.id), method: :delete, class: "my-orders__cancel-link", form: { data: { turbo_confirm: "Are you sure you want to cancel this order?" } } %>
                  <% end %>
                </div>
            </div>
          </div>

          <div class="my-orders__body">
            <div class="my-orders__image-container">
              <% if order.shop_item.image.attached? && order.shop_item.image.variable? %>
                <%= image_tag(order.shop_item.image.variant(:carousel_md), class: "my-orders__image", loading: "lazy") %>
              <% elsif order.shop_item.image.attached? %>
                <%= image_tag(order.shop_item.image, class: "my-orders__image", loading: "lazy") %>
              <% else %>
                <div class="my-orders__image--placeholder">
                  No Image
                </div>
              <% end %>
            </div>

            <div class="my-orders__content">
              <div class="my-orders__title-section">
                <h2 class="my-orders__item-name"><%= order.shop_item.name %></h2>
                <div class="my-orders__status-wrapper">
                  <span class="my-orders__status my-orders__status--<%= order.aasm_state %>">
                    <%= order.aasm_state.humanize %>
                  </span>
                  <% if order.aasm_state == "fulfilled" %>
                    <% if not order.digital? %>
                      <span class="my-orders__status-hint">We have ordered/shipped the item to you! this does not mean it has already reached you.</span>
                    <% elsif order.grant? && order.shop_card_grant.present? %>
                      <div class="my-orders__grant-actions">
                        <%= render ButtonComponent.new(text: "Open Grant", href: order.shop_card_grant.hcb_url, color: :brown, target: "_blank") %>
                        <%= render ButtonComponent.new(text: "Top Up", href: order.shop_card_grant.topup_url, color: :brown, target: "_blank") %>
                      </div>
                    <% end %>
                  <% end %>
                </div>
              </div>

              <div class="my-orders__details">
                <div class="my-orders__detail-row">
                  <span class="my-orders__label">Quantity:</span>
                  <span class="my-orders__value"><%= order.quantity %></span>
                </div>

                <div class="my-orders__detail-row">
                  <span class="my-orders__label">Unit Price:</span>
                  <span class="my-orders__value">üç™ <%= number_with_precision(order.frozen_item_price || order.shop_item.ticket_cost, precision: 0) %></span>
                </div>

                <% if order.accessory_orders.any? %>
                  <div class="my-orders__accessories">
                    <span class="my-orders__label">Accessories:</span>
                    <ul class="my-orders__accessory-list">
                      <% order.accessory_orders.includes(shop_item: { image_attachment: :blob }).each do |acc_order| %>
                        <li class="my-orders__accessory-item">
                          <% if acc_order.shop_item.image.attached? %>
                            <%= image_tag acc_order.shop_item.image.variant(:carousel_sm), class: "my-orders__accessory-image", loading: "lazy" %>
                          <% end %>
                          <span class="my-orders__accessory-name"><%= acc_order.shop_item.name %></span>
                          <span class="my-orders__accessory-price">üç™ <%= number_with_precision(acc_order.frozen_item_price || acc_order.shop_item.ticket_cost, precision: 0) %></span>
                          <span class="my-orders__status my-orders__status--<%= acc_order.aasm_state %>"><%= acc_order.aasm_state.humanize %></span>
                        </li>
                      <% end %>
                    </ul>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
