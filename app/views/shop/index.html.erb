<% content_for :title, "Shop" %>
<% content_for :og_title, "Flavortown Shop" %>
<% content_for :og_description, "Spend your cookies on stickers, hardware, and other prizes. Earn cookies by building projects and voting!" %>
<% content_for :og_image, og_image_url('shop', format: :png) %>

<%= render MusicPlayerComponent.new(audio_url: audio_path("fireentity - shop.mp3")) %>

<% if @show_shop_tutorial && session[:tutorial_redirect_url].present? %>
  <%= render DialogueBoxComponent.new(
    text: [
      "You're in the shop now. This is where you spend cookies on prizes.",
      "Cookies are the currency you use to buy prizes here. You earn cookies by working on your project with your time attached, then voting on other projects.",
      "I've given you 10 cookies to get started. We'll use them to place your stickers order.",
      "Before we can ship prizes, I need to confirm that you're a teenager and get your address. I'll redirect you to Hack Club Auth to fill that out. It's secure and open source."
    ],
    sticker: "cookie.svg",
    sticker_line_index: 0,
    redirect_url: session[:tutorial_redirect_url]
  ) %>
<% end %>

<div class="shop" data-controller="shop" data-shop-user-region-value="<%= @user_region %>">
  <%= render HeadingComponent.new(title: "Shop", tone: :brown) %>

  <div class="shop-goals" data-controller="shop-goals" data-shop-goals-balance-value="<%= @user_balance %>">
    <div class="shop-goals__container" data-shop-goals-target="container" style="display: none;">
      <h3 class="shop-goals__title"><%= inline_svg_tag "icons/star_fill.svg" %> My Goal Items</h3>
      <div class="shop-goals__items" data-shop-goals-target="items"></div>
    </div>
  </div>

  <% if @shop_open %>
    <% if current_user&.admin? %>
      <div class="admin-banner">
        <div class="admin-banner__content">
          <span class="admin-banner__count"><%= @shop_items.count %> items</span>
          <%= link_to "Edit items ‚Üí", admin_manage_shop_path, class: "admin-banner__link" %>
        </div>
      </div>
    <% end %>

    <% unless current_user %>
      <div class="shop__signup-cta">
        <div class="shop__signup-cta-content">
          <h3>üç™ Want to order something?</h3>
          <p>Join <%= link_to "Hack Club Flavortown", "/" %> to start earning cookies by building personal projects!</p>
        </div>
        <div class="shop__signup-cta-buttons">
          <%= link_to "Get building!", "/start", class: "btn btn-cta" %>
          <%= form_tag "/auth/hack_club", method: :post, data: { turbo: false }, class: "shop__signin-form" do %>
            <button type="submit" class="shop__signin-link">Already a member? Sign in</button>
          <% end %>
        </div>
      </div>
    <% end %>

    <div class="shop__buttons">
      <% if current_user %>
        <%= render ButtonComponent.new(
          text: "View My Orders",
          href: "/shop/my_orders",
          color: :brown,
          variant: :borderless
        ) %>
      <% end %>
      <%= render DropdownComponent.new(
        label: "Region",
        options: @region_options,
        selected_option: Shop::Regionalizable::REGIONS.dig(@user_region, :name),
        longest_option_string: "Rest of World",
        color: :brown
      ) %>
    </div>
    <% if @featured_item && current_user %>
      <%= render partial: "shop/banner", locals: { featured_item: @featured_item, user_region: @user_region } %>
    <% end %>
    <div class="shop__nav">
      <div class="shop__searchbar">
        <%= form_with url: shop_path, method: :get, local: true do |f| %>
          <%= render InputComponent.new(
            label: nil,
            icon: "icons/search.svg",
            placeholder: "Search item",
            form: f,
            attribute: :q,
            color: :yellow,
            input_html: {
              value: params[:q],
              data: { action: "input->shop#search" }
            }
          ) %>
        <% end %>
      </div>
      <div class="shop__filters">
        <%= render DropdownComponent.new(
          label: "Category",
          options: ["All", "Grants", "HQ", "Digital", "Locally Fulfilled", "Made by Hack Clubbers"],
          selected_option: "All",
          longest_option_string: "Made by Hack Clubbers",
          color: :blue
        ) %>
        <%= render DropdownComponent.new(
          label: "Price Range",
          options: [
            { label: "None", value: "none" },
            { label: "üç™0 - üç™100", value: "0-100" },
            { label: "üç™100 - üç™500", value: "100-500" },
            { label: "üç™500 - üç™1000", value: "500-1000" },
            { label: ">üç™1000", value: "1000+" }
          ],
          selected_option: "None",
          longest_option_string: "üç™100 - üç™500",
          color: :pink
        ) %>
        <%= render DropdownComponent.new(
          label: "Sort by",
          options: ["Prices", "Alphabetical"],
          selected_option: "Prices",
          longest_option_string: "Alphabetical",
          color: :green
        ) %>
        <button id="sort-btn">
          <span>
            <%= inline_svg_tag "icons/sort.svg", title: "Sort Icon" %>
          </span>
          <%= inline_svg_tag "icons/sort-btn-icon.svg", title: "Sort Arrow" %>
        </button>
      </div>
    </div>
    <%= turbo_frame_tag "shop_items" do %>
      <div class="shop__items">
        <% @shop_items.each do |item| %>
          <% if item.image.present? && item.enabled_in_region?(@user_region) %>
            <% sale_price = item.price_for_region(@user_region) %>
            <%= render ShopItemCardComponent.new(
              item_id: item.id,
              name: item.name,
              description: item.description,
              hours: item.fixed_estimate(sale_price).to_i,
              price: item.ticket_cost,
              image_url: item.image.variant(:carousel_lg),
              item_type: item.type,
              balance: @user_balance,
              enabled_regions: Shop::Regionalizable::REGION_CODES.select { |code| item.enabled_in_region?(code) },
              regional_price: sale_price,
              logged_in: current_user.present?,
              remaining_stock: item.remaining_stock,
              limited: item.limited?,
              on_sale: item.on_sale?,
              sale_percentage: item.sale_percentage,
              original_price: item.ticket_cost
            ) %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  <% else %>
    <h2>The shop is not opened yet!</h2>
  <% end %>
</div>
