<!DOCTYPE html>
<html lang="en">
  <head>
    <title><%= content_for?(:title) ? "#{strip_tags(yield(:title))} - Flavortown" : "Flavortown - Hack Club" %></title>
    <%= favicon_link_tag 'favicon.ico' %>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta property="og:type" content="website">
    <meta name="twitter:site" content="@hackclub">
    <meta name="twitter:creator" content="@hackclub">
    <meta property="og:locale" content="en_US">
    <meta property="og:site_name" content="Flavortown - Hack Club">

    <% og_title = content_for?(:og_title) ? yield(:og_title) : (content_for?(:title) ? "#{yield(:title)} - Flavortown" : "Flavortown - Hack Club") %>
    <% og_description = content_for?(:og_description) ? yield(:og_description) : "Build projects, earn cookies, get prizes. A Hack Club program for teen coders." %>
    <% og_image = content_for?(:og_image) ? yield(:og_image) : image_url("landing/hero/long-image.avif") %>
    <% og_url = content_for?(:og_url) ? yield(:og_url) : request.original_url %>
    <% twitter_card = content_for?(:twitter_card) ? yield(:twitter_card) : "summary" %>

    <meta name="description" content="<%= og_description %>">
    <meta property="og:title" content="<%= og_title %>">
    <meta property="og:description" content="<%= og_description %>">
    <meta property="og:url" content="<%= og_url %>">
    <meta property="og:image" content="<%= og_image %>">
    <meta name="twitter:card" content="<%= twitter_card %>">
    <meta name="twitter:title" content="<%= og_title %>">
    <meta name="twitter:description" content="<%= og_description %>">
    <meta name="twitter:image" content="<%= og_image %>">
    <% if content_for?(:og_author) %><meta name="author" content="<%= yield(:og_author) %>"><% end %>

    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <meta name="turbo-prefetch" content="false">

    <%= preload_link_tag image_path("landing/hero/long-image.avif"), as: "image", fetchpriority: "high" %>
    <%= preload_link_tag image_path("landing/hero/hero-bg.avif"), as: "image" %>
    <%= preload_link_tag asset_path("Jua-Regular.woff2"), as: "font", type: "font/woff2", crossorigin: true %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <%= yield :stylesheets %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <% if Rails.env.production? %>
      <script async src="https://plausible.io/js/pa-vZKZvMqR3_6nQr_H-sJ_2.js"></script>
      <script>
        window.plausible=window.plausible||function(){(plausible.q=plausible.q||[]).push(arguments)},plausible.init=plausible.init||function(i){plausible.o=i||{}};
        plausible.init()
      </script>
    <% end %>
    <script src="/howler.js"></script>
    <script src="/yappingv2.js"></script>
    <%= javascript_include_tag "application", "data-turbo-track": "reload", type: "module" %>
    <%= Sentry.get_trace_propagation_meta.html_safe %> <%# erb_lint:disable ErbSafety %>
  </head>

  <body class="<%= current_user.present? && !@hide_sidebar ? 'signed-in' : '' %> <%= @body_class %> <%= 'christmas-theme' if current_user && Flipper.enabled?(:christmas_theme, current_user) && current_user.special_effects_enabled %> <%= 'launch-theme' if controller_name == 'launch' %>" <%= 'data-controller="snow"'.html_safe if current_user && Flipper.enabled?(:christmas_theme, current_user) && current_user.special_effects_enabled %> <%= 'data-controller="stars shooting-star"'.html_safe if controller_name == 'launch' %>>
    <% if controller_name == 'launch' %>
      <%= image_tag "iss.svg", class: "launch-iss", alt: "", aria: { hidden: true } %>
    <% end %>
    <% if Rails.env.development? && current_user.blank? %>
      <div style="position: fixed; top: 0; left: 0; right: 0; z-index: 99999; background: linear-gradient(90deg, #ff6b35, #f7931e); padding: 12px 20px; display: flex; align-items: center; justify-content: center; gap: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-family: system-ui, sans-serif;">
        <span style="color: white; font-weight: bold; font-size: 14px;">ðŸ”§ DEV MODE</span>
        <% User.limit(5).each do |user| %>
          <%= link_to user.display_name.presence || "User ##{user.id}",
                      dev_login_path(user.id),
                      style: "background: white; color: #ff6b35; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 13px;" %>
        <% end %>
      </div>
      <div style="height: 50px;"></div>
    <% end %>
    <% if impersonating? %>
      <div class="impersonation-banner">
        <div class="impersonation-content">
          <div style="display: flex; align-items: center;">
            <div class="impersonation-text">
              <strong>IMPERSONATING:</strong> <%= current_user.display_name %>
              <span class="impersonation-admin">(as <%= real_user.display_name %>)</span>
            </div>
          </div>
          <%= button_to "Stop Impersonating",
                        stop_impersonating_admin_users_path,
                        method: :post,
                        class: "btn-stop-impersonation",
                        form: { style: "margin: 0;" } %>
        </div>
      </div>
    <% end %>
    <% if current_user.present? && !current_user.banned? && !@hide_sidebar %>
      <%= render "shared/sidebar" %>
    <% end %>
    <%= render "shared/flash" %>
    <% if tutorial_messages.present? %>
      <%= render DialogueBoxComponent.new(text: tutorial_messages) %>
    <% end %>
    <%= yield %>
    <% unless @hide_footer %>
      <footer class="dev-footer">
        <p>
          Build <%= link_to Rails.application.config.git_version, Rails.application.config.commit_link %>
          from <%= time_ago_in_words(Rails.application.config.server_start_time) %> ago.
          (DB: <%= pluralize(QueryCount::Counter.counter, "query") %>, <%= QueryCount::Counter.counter_cache %> cached)
          (CACHE: <%= cache_stats[:hits] %> hits, <%= cache_stats[:misses] %> misses)
          (<%= requests_per_second %>)
          (Active: <%= active_users_stats %>)
        </p>
      </footer>
    <% end %>
  </body>
</html>
